<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Message Queue Module - Documentatie</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('message_queue_doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Message Queue Module - Documentatie </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_modules_2message__queue_2message__queue__doc"></a></p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md126"></a>
ğŸ”— Navigatie</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Sectie  </th><th class="markdownTableHeadNone">Link  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“š <b>API Referentie</b>  </td><td class="markdownTableBodyNone"><a class="el" href="group__message__queue.html">Message Queue - API Referentie</a> - Module groep met alle functies, structs, en macros  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ğŸ“„ <b>Source Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="message__queue_8c.html">message_queue.c</a> - Implementatie  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“„ <b>Header Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="message__queue__zbus_8h.html">message_queue_zbus.h</a> - Public API en ZBUS definities  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md128"></a>
Overzicht</h1>
<p>De Message Queue module combineert energie metingen van P1 (DSMR slimme meter) en Pulse (puls-tellers) modules in een gecoÃ¶rdineerde collectie window, buffert deze voor cloud verzending, en implementeert een state machine voor robuuste delivery. Werkt nauw samen met de Timing Module voor gecoÃ¶rdineerde data acquisitie en verzending.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md130"></a>
Waarom? (Design Rationale)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md131"></a>
GecoÃ¶rdineerde Data Collectie</h2>
<p><b>Probleem</b>: P1 en Pulse modules publiceren asynchroon. We willen deze data synchroon combineren voor cloud verzending.</p>
<p><b>Design Keuze</b>: Collection window met 1000ms timeout, getriggerd door Timing Module.</p>
<p><b>Rationale</b>:</p><ul>
<li><span class="tt">DATA_PUBLISH_REQUEST</span> triggert collectie window (elke 10 min)</li>
<li>Module wacht op P1 Ã©n Pulse data binnen 1 seconde</li>
<li>Als beide data binnen timeout: combineer direct</li>
<li>Bij timeout: combineer wat beschikbaar is (met flags)</li>
<li>Voorkomt race conditions en data mismatch</li>
</ul>
<p><b>Result</b>: Gegarandeerd gesynchroniseerde metingen in Ã©Ã©n cloud bericht.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md132"></a>
Delivery Garanties via Buffering</h2>
<p><b>Probleem</b>: Cloud kan tijdelijk unavailable zijn (verbinding opbouwen, netwerk instabiel, LTE-M outages).</p>
<p><b>Design Keuze</b>: Zephyr Message Queue met 144 berichten capaciteit + FIFO drop strategie.</p>
<p><b>Rationale</b>:</p><ul>
<li>Typische publish interval: 10 minuten</li>
<li>Buffer capacity: 144 berichten = ~24 uur data buffering</li>
<li>Bij 2 uur cloud outage: 12 berichten gebufferd</li>
<li>Data niet verloren tijdens tijdelijke disconnects</li>
<li>Gebruikt Zephyr <span class="tt">K_MSGQ_DEFINE</span> - battle-tested, geen custom ring buffer</li>
</ul>
<p><b>Trade-off</b>: RAM usage vs data reliability. Queue size configureerbaar via Kconfig (<span class="tt">CONFIG_APP_MESSAGE_QUEUE_MODULE_QUEUE_SIZE</span>).</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md134"></a>
Wat? (Functionaliteit &amp; Data Flow)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md135"></a>
GecoÃ¶rdineerde Data Collectie Flow</h2>
<div class="fragment"><div class="line">Timing Module</div>
<div class="line">    â”‚</div>
<div class="line">    â”‚ DATA_PUBLISH_REQUEST (every 10 min)</div>
<div class="line">    â”‚</div>
<div class="line">    â–¼</div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚           Message Queue Module                      â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  STATE_COLLECTING_DATA (1000ms window):             â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  P1 Module â”€â”€â”€â”€â”€â”€â–º collected_p1.data                â”‚</div>
<div class="line">â”‚                    collected_p1.has_data = true     â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  Pulse Module â”€â”€â”€â–º collected_pulse.data             â”‚</div>
<div class="line">â”‚                    collected_pulse.has_data = true  â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  Timer ISR â”€â”€â”€â”€â”€â”€â–º collection_timeout_expired       â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  Combine triggers:                                  â”‚</div>
<div class="line">â”‚  - Both P1 + Pulse received â†’ combine immediately   â”‚</div>
<div class="line">â”‚  - 1000ms timeout â†’ combine what&#39;s available        â”‚</div>
<div class="line">â”‚                                                     â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚</div>
<div class="line">â”‚  â”‚  combine_and_queue_data()                     â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚ combined_energy_msg {                   â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚   timestamp: k_uptime_get()             â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚   has_p1_data: bool                     â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚   p1_data: struct p_one_msg             â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚   has_pulse_data: bool                  â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚   pulse_data: struct energy_pulse_msg   â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â”‚ }                                       â”‚  â”‚  â”‚</div>
<div class="line">â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚</div>
<div class="line">â”‚                     â”‚                               â”‚</div>
<div class="line">â”‚                     â–¼                               â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚  Zephyr Message Queue (K_MSGQ_DEFINE)       â”‚   â”‚</div>
<div class="line">â”‚  â”‚  Capacity: CONFIG_..._QUEUE_SIZE (default   â”‚   â”‚</div>
<div class="line">â”‚  â”‚  144)                                        â”‚   â”‚</div>
<div class="line">â”‚  â”‚  Drop strategy: FIFO (oldest first)         â”‚   â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â”‚                     â”‚                               â”‚</div>
<div class="line">â”‚  DATA_SEND_REQUEST (timing trigger)                 â”‚</div>
<div class="line">â”‚                     â”‚                               â”‚</div>
<div class="line">â”‚                     â–¼                               â”‚</div>
<div class="line">â”‚  STATE_SEND_MSG_ATTEMPT:                            â”‚</div>
<div class="line">â”‚  - Send max 10 msgs per cycle (MAX_MSGS_PER_CYCLE)  â”‚</div>
<div class="line">â”‚  - Only if cloud ready (is_cloud_ready)             â”‚</div>
<div class="line">â”‚  - Stop on error, retry next cycle                  â”‚</div>
<div class="line">â”‚                     â”‚                               â”‚</div>
<div class="line">â”‚                     â–¼                               â”‚</div>
<div class="line">â”‚              nRF Cloud SDK                          â”‚</div>
<div class="line">â”‚         (nrf_cloud_send via MQTT)                   â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md136"></a>
ZBUS Interfaces</h2>
<p><b>Subscribed Channels</b>:</p><ul>
<li><span class="tt">CLOUD_CHAN</span> - Cloud connection status tracking (cloud_is_ready)</li>
<li><span class="tt">P_ONE_CHAN</span> - P1 DSMR data (tijdens COLLECTING_DATA state)</li>
<li><span class="tt">ENERGY_PULSE_CHAN</span> - Pulse counter data (tijdens COLLECTING_DATA state)</li>
<li><span class="tt">DATA_PUBLISH_REQUEST_CHAN</span> - Triggert data collectie window (van Timing Module)</li>
<li><span class="tt">DATA_SEND_REQUEST_CHAN</span> - Triggert cloud verzending (van Timing Module)</li>
</ul>
<p><b>Published Channels</b>:</p><ul>
<li>Geen - verzendt direct naar nRF Cloud SDK via <span class="tt">nrf_cloud_send()</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md137"></a>
Message Format</h2>
<p><b>Combined Energy Message bevat</b>:</p><ul>
<li><span class="tt">uptime_ms</span>: System uptime when combined (k_uptime_get(), milliseconds) - converted to epoch when sending</li>
<li><span class="tt">has_p1_data</span>: Flag of P1 data beschikbaar is</li>
<li><span class="tt">p1_data</span>: Volledige <span class="tt">struct <a class="el" href="structp__one__msg.html" title="P_ONE module message structure.">p_one_msg</a></span> (energie, vermogen, gas)<ul>
<li>P1 timestamps zijn <b>Unix epoch milliseconds</b> (van meter OBIS 0-0:1.0.0)</li>
</ul>
</li>
<li><span class="tt">has_pulse_data</span>: Flag of Pulse data beschikbaar is <br  />
</li>
<li><span class="tt">pulse_data</span>: Volledige <span class="tt">struct <a class="el" href="structenergy__pulse__msg.html" title="Energy pulse message.">energy_pulse_msg</a></span> (2 kanalen)<ul>
<li>Pulse timestamp is <b>system uptime</b> (<span class="tt">uptime_ms</span>) - converted to epoch when sending</li>
</ul>
</li>
</ul>
<p><b>Data Types</b> (zoals gedefinieerd in bron modules):</p><ul>
<li>P1 energie velden: <span class="tt">int64_t</span> (Wh - Watt-hour)</li>
<li>P1 vermogen velden: <span class="tt">int32_t</span> (W - Watt)</li>
<li>P1 gas: <span class="tt">int32_t</span> (dmÂ³ = liters)</li>
<li>Pulse counters: <span class="tt">uint64_t</span> (Wh - Watt-hour)</li>
<li>System uptime: <span class="tt">int64_t uptime_ms</span> (milliseconds since boot)</li>
<li>P1 timestamps: <span class="tt">int64_t timestamp_epoch_ms</span> (milliseconds since Unix epoch)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md139"></a>
Hoe? (Architectuur &amp; Gedrag)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md140"></a>
State Machine</h2>
<p>De module gebruikt een hierarchische state machine met <b>3 states</b>:</p>
<div class="fragment"><div class="line">           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   OPERATIONAL      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚          â”‚   (parent state)   â”‚         â”‚</div>
<div class="line">â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚</div>
<div class="line">â”‚                    â”‚                    â”‚</div>
<div class="line">â”‚   DATA_PUBLISH_    â”‚                    â”‚  DATA_SEND_</div>
<div class="line">â”‚   REQUEST          â”‚                    â”‚  REQUEST</div>
<div class="line">â”‚                    â”‚                    â”‚  (+ cloud ready)</div>
<div class="line">â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚</div>
<div class="line">â”‚          â”‚  COLLECTING_DATA   â”‚         â”‚</div>
<div class="line">â”‚          â”‚  (child of OPER)   â”‚         â”‚</div>
<div class="line">â”‚          â”‚  - 1000ms window   â”‚         â”‚</div>
<div class="line">â”‚          â”‚  - Collect P1+Pulseâ”‚         â”‚</div>
<div class="line">â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚</div>
<div class="line">â”‚                    â”‚                    â”‚</div>
<div class="line">â”‚    Both received   â”‚  Timeout           â”‚</div>
<div class="line">â”‚    OR timeout      â”‚                    â”‚</div>
<div class="line">â”‚                    â”‚                    â”‚</div>
<div class="line">â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ SEND_MSG_ATTEMPT   â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">           â”‚ (child of OPER)    â”‚</div>
<div class="line">           â”‚ - Max 10 msgs/cycleâ”‚</div>
<div class="line">           â”‚ - Runs in entry()  â”‚</div>
<div class="line">           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">                    â”‚</div>
<div class="line">                    â”‚ Always returns</div>
<div class="line">                    â”‚ to OPERATIONAL</div>
<div class="line">                    â–¼</div>
</div><!-- fragment --><p><b>State Gedrag</b>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">State  </th><th class="markdownTableHeadNone">Trigger  </th><th class="markdownTableHeadNone">Gedrag  </th><th class="markdownTableHeadNone">Exit Conditie  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">STATE_OPERATIONAL</span>  </td><td class="markdownTableBodyNone">Initial state  </td><td class="markdownTableBodyNone">Wacht op events, tracks cloud status  </td><td class="markdownTableBodyNone"><span class="tt">DATA_PUBLISH_REQUEST</span> â†’ COLLECTING<br  />
<span class="tt">DATA_SEND_REQUEST</span> + cloud ready â†’ SEND  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">STATE_COLLECTING_DATA</span>  </td><td class="markdownTableBodyNone"><span class="tt">DATA_PUBLISH_REQUEST</span>  </td><td class="markdownTableBodyNone">Start 1s timer, collect P1 &amp; Pulse data  </td><td class="markdownTableBodyNone">Both received OR 1000ms timeout  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">STATE_SEND_MSG_ATTEMPT</span>  </td><td class="markdownTableBodyNone"><span class="tt">DATA_SEND_REQUEST</span> + ready  </td><td class="markdownTableBodyNone">Send max 10 msgs, runs in <span class="tt">entry()</span> only  </td><td class="markdownTableBodyNone">Immediate return to OPERATIONAL  </td></tr>
</table>
<p><b>Belangrijke Design Keuzes</b>:</p>
<ol type="1">
<li><b>OPERATIONAL als Parent</b>: COLLECTING_DATA en SEND_MSG_ATTEMPT zijn child states. Cloud status tracking gebeurt in parent (altijd actief).</li>
<li><b>Collection Window</b>: 1000ms is ruim genoeg voor beide modules om te publishen. P1 en Pulse modules worden getriggerd door dezelfde <span class="tt">DATA_PUBLISH_REQUEST</span>.</li>
<li><b>Early Exit</b>: Als beide P1 en Pulse data binnen timeout ontvangen, sluit window direct (efficiency).</li>
<li><b>Partial Data Allowed</b>: Bij timeout combineert wat beschikbaar is. Flags (<span class="tt">has_p1_data</span>, <span class="tt">has_pulse_data</span>) in bericht tonen wat aanwezig is.</li>
<li><b>Cloud Ready Check</b>: Send state wordt alleen bereikt als cloud ready is. Voorkomt nutteloos poging en queue drain.</li>
<li><b>Never Block</b>: SEND_MSG_ATTEMPT draait in <span class="tt">entry()</span> functie, returnt altijd naar OPERATIONAL. Voorkomt blocking op cloud/network problemen.</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md141"></a>
Queue Management</h2>
<p><b>Zephyr Message Queue (K_MSGQ_DEFINE)</b>: </p><div class="fragment"><div class="line"><a class="code hl_function" href="message__queue_8c.html#ae9820326512114f9d391c41364a4a7f3">K_MSGQ_DEFINE</a>(combined_energy_msgq, </div>
<div class="line">              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code hl_struct" href="structcombined__energy__msg.html">combined_energy_msg</a>),</div>
<div class="line">              CONFIG_APP_MESSAGE_QUEUE_MODULE_QUEUE_SIZE,  <span class="comment">// default: 144</span></div>
<div class="line">              1);  <span class="comment">// alignment</span></div>
<div class="ttc" id="amessage__queue_8c_html_ae9820326512114f9d391c41364a4a7f3"><div class="ttname"><a href="message__queue_8c.html#ae9820326512114f9d391c41364a4a7f3">K_MSGQ_DEFINE</a></div><div class="ttdeci">K_MSGQ_DEFINE(combined_energy_msgq, sizeof(struct combined_energy_msg), CONFIG_APP_MESSAGE_QUEUE_MODULE_QUEUE_SIZE, 1)</div></div>
<div class="ttc" id="astructcombined__energy__msg_html"><div class="ttname"><a href="structcombined__energy__msg.html">combined_energy_msg</a></div><div class="ttdoc">Combined energy message structure.</div><div class="ttdef"><b>Definition</b> <a href="message__queue__zbus_8h_source.html#l00039">message_queue_zbus.h:39</a></div></div>
</div><!-- fragment --><p><b>Properties</b>:</p><ul>
<li>Thread-safe enqueueing/dequeueing (Zephyr kernel garanties)</li>
<li>Fixed capacity: 144 berichten (configureerbaar via Kconfig)</li>
<li>FIFO ordering: First In, First Out</li>
<li>No dynamic allocation: fixed memory footprint</li>
</ul>
<p><b>Enqueue Logica</b> (in <span class="tt">queue_combined_message</span>):</p><ol type="1">
<li>Check if queue full via <span class="tt">k_msgq_num_free_get()</span></li>
<li>If full: drop oldest message via <span class="tt">k_msgq_get()</span> (FIFO strategy)</li>
<li>Add new message via <span class="tt">k_msgq_put(..., K_NO_WAIT)</span></li>
<li>Log queue statistics (<span class="tt">k_msgq_num_used_get()</span>, <span class="tt">k_msgq_num_free_get()</span>)</li>
</ol>
<p><b>Dequeue Logica</b> (in <span class="tt">state_send_msg_attempt_entry</span>):</p><ol type="1">
<li>Check queue size via <span class="tt">k_msgq_num_used_get()</span></li>
<li>Loop: get message via <span class="tt">k_msgq_get(..., K_NO_WAIT)</span></li>
<li>Build JSON and send via <span class="tt">nrf_cloud_send()</span></li>
<li>On error: break (message queue preserves remaining msgs)</li>
<li>Limit: max 10 messages per cycle (<span class="tt">MAX_MSGS_PER_CYCLE</span>)</li>
</ol>
<p><b>Rationale voor Zephyr Message Queue</b>:</p><ul>
<li>Battle-tested kernel primitive (geen custom bugs)</li>
<li>Zero-copy mogelijk voor kleine messages</li>
<li>Atomic operations (geen extra mutexes nodig)</li>
<li>Goed gedocumenteerd en getest</li>
<li>Integratie met Zephyr tracing/debugging tools</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md142"></a>
Verzend Logica</h2>
<p><b>Immediate Send Strategie</b> (geen batching threshold):</p>
<p>De module verzendt <b>direct</b> wanneer <span class="tt">DATA_SEND_REQUEST</span> ontvangen wordt EN cloud ready is. Er is <b>geen</b> wacht-threshold (zoals "wacht tot 3 berichten in queue").</p>
<p><b>Configuratie</b>:</p><ul>
<li><span class="tt">MAX_MSGS_PER_CYCLE</span> = 10 berichten per verzend cyclus (hardcoded in code)</li>
<li>Timing: <span class="tt">DATA_SEND_REQUEST</span> interval configureerbaar in Timing Module</li>
<li>Cloud ready check: <span class="tt">is_cloud_ready</span> flag (via <span class="tt">CLOUD_CHAN</span> updates)</li>
</ul>
<p><b>Verzend Cyclus Gedrag</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">while</span> (queue_not_empty &amp;&amp; sent_count &lt; <a class="code hl_define" href="message__queue_8c.html#a2c8e46d63c3681faca97c3341bd2af97">MAX_MSGS_PER_CYCLE</a>) {</div>
<div class="line">    get_message_from_queue();</div>
<div class="line">    build_json();</div>
<div class="line">    err = nrf_cloud_send();</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        <span class="keywordflow">break</span>;  <span class="comment">// Stop, retry next cycle</span></div>
<div class="line">    }</div>
<div class="line">    sent_count++;</div>
<div class="line">}</div>
<div class="ttc" id="amessage__queue_8c_html_a2c8e46d63c3681faca97c3341bd2af97"><div class="ttname"><a href="message__queue_8c.html#a2c8e46d63c3681faca97c3341bd2af97">MAX_MSGS_PER_CYCLE</a></div><div class="ttdeci">#define MAX_MSGS_PER_CYCLE</div></div>
</div><!-- fragment --><p><b>Rationale voor Direct Send (geen threshold)</b>:</p><ul>
<li><b>Simpliciteit</b>: Minder states, minder complexity</li>
<li><b>Lage latency</b>: Data verzonden zo snel mogelijk na collectie</li>
<li><b>Cloud ready check</b>: Voorkomt nutteloze verzendpogingen</li>
<li><b>Graceful degradation</b>: Bij error stopt cyclus, queue behoudt data</li>
<li><b>Timing Module controleert</b>: Send interval instelbaar (default 30 min)</li>
</ul>
<p><b>Error Handling</b>:</p><ul>
<li><b>JSON build error</b>: Drop message, continue met volgende (data mogelijk corrupt)</li>
<li><b>nrf_cloud_send() error</b>: Stop cyclus, break uit loop<ul>
<li>Queue behoudt remaining messages</li>
<li>Volgende <span class="tt">DATA_SEND_REQUEST</span> probeert opnieuw</li>
<li>Voorkomt queue drain bij persistente netwerk issues</li>
</ul>
</li>
</ul>
<hr  />
<h2 class="doxsection"><a class="anchor" id="autotoc_md144"></a>
Timestamp Strategy</h2>
<p><b>Design Problem</b>: Device kan data acquisitie doen <b>zonder netwerk verbinding</b>. Tijdens acquisitie hebben we geen Unix epoch tijd (geen NTP/date_time sync).</p>
<p><b>Solution</b>: Two-stage timestamp approach:</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md145"></a>
1. Acquisitie: Uptime Timestamps</h3>
<p><b>Tijdens data collectie</b> (P1, Pulse modules):</p><ul>
<li>Timestamp = <span class="tt">k_uptime_get()</span> (system uptime milliseconds)</li>
<li>Stored in <span class="tt"><a class="el" href="structcombined__energy__msg.html#affe80cb3bbd8ce6236f13501df5e06f7">combined_energy_msg.uptime_ms</a></span></li>
<li><b>Rationale</b>: Uptime is altijd beschikbaar, ook zonder netwerk</li>
<li><b>Field naming</b>: <span class="tt">uptime_ms</span> suffix maakt duidelijk dat het systeem uptime is</li>
</ul>
<p><b>P1 Exception - Meter Epoch Timestamps</b>:</p><ul>
<li>P1 DSMR meter heeft <b>eigen klok</b> (OBIS 0-0:1.0.0)</li>
<li>P1 timestamp = Unix epoch seconds FROM METER (niet system uptime!)</li>
<li>Stored intern als <span class="tt">timestamp_epoch_localtime_s</span> (seconds)</li>
<li>Converted to milliseconds bij output: <span class="tt">timestamp_epoch_ms</span></li>
<li>Peak timestamps: <span class="tt">power_consumed_max_timestamp_epoch_ms</span>, <span class="tt">power_delivered_max_timestamp_epoch_ms</span></li>
<li><b>Rationale</b>: Meter synchroniseert tijd via DSO (Distribution System Operator), accurater dan device RTC</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md146"></a>
2. Verzending: Unix Epoch Conversion</h3>
<p><b>Wanneer cloud verzending</b> (in <span class="tt"><a class="el" href="message__queue_8c.html#a16e0c8c199c4c428750fd989c79f437b" title="Build nRF Cloud JSON object from combined energy message.">build_combined_energy_json()</a></span>):</p><ul>
<li><b>IF</b> time_synced (via <span class="tt">date_time</span> library):<ul>
<li>Uptime â†’ Unix epoch via offset calculation</li>
<li>P1 meter timestamps blijven epoch (al correct)</li>
<li>Add <span class="tt">ts_sync: true</span> flag to JSON</li>
</ul>
</li>
<li><b>ELSE</b> niet gesynced:<ul>
<li>Timestamp = 0 (indicates invalid/unknown time)</li>
<li>Add <span class="tt">ts_sync: false</span> flag to JSON</li>
<li><b>Backend</b> weet dat timestamps invalid zijn</li>
</ul>
</li>
</ul>
<p><b>Time Sync State Tracking</b>: </p><div class="fragment"><div class="line"><span class="keyword">struct </span>{</div>
<div class="line">    <span class="keywordtype">bool</span> <a class="code hl_variable" href="message__queue_8c.html#af833b67b3ae9804347e263aecbc92b84">time_synced</a>;              <span class="comment">// Are we synchronized?</span></div>
<div class="line">    int64_t <a class="code hl_variable" href="message__queue_8c.html#a8f26a2e900c06ab2ba63387db37c70dc">unix_epoch_offset_ms</a>;  <span class="comment">// Offset between uptime and Unix epoch</span></div>
<div class="line">    int64_t <a class="code hl_variable" href="message__queue_8c.html#aa45ad6c345c6e5d5f777f2e625e76d3d">last_sync_uptime_ms</a>;   <span class="comment">// When did we last sync?</span></div>
<div class="line">} <a class="code hl_variable" href="message__queue_8c.html#a24f289b5acdd69f6969843364b8f96ac">time_sync_state</a>;</div>
<div class="ttc" id="amessage__queue_8c_html_a24f289b5acdd69f6969843364b8f96ac"><div class="ttname"><a href="message__queue_8c.html#a24f289b5acdd69f6969843364b8f96ac">time_sync_state</a></div><div class="ttdeci">static struct @011026170075000275243377367261353301102270032142 time_sync_state</div></div>
<div class="ttc" id="amessage__queue_8c_html_a8f26a2e900c06ab2ba63387db37c70dc"><div class="ttname"><a href="message__queue_8c.html#a8f26a2e900c06ab2ba63387db37c70dc">unix_epoch_offset_ms</a></div><div class="ttdeci">int64_t unix_epoch_offset_ms</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00187">message_queue.c:187</a></div></div>
<div class="ttc" id="amessage__queue_8c_html_aa45ad6c345c6e5d5f777f2e625e76d3d"><div class="ttname"><a href="message__queue_8c.html#aa45ad6c345c6e5d5f777f2e625e76d3d">last_sync_uptime_ms</a></div><div class="ttdeci">int64_t last_sync_uptime_ms</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00188">message_queue.c:188</a></div></div>
<div class="ttc" id="amessage__queue_8c_html_af833b67b3ae9804347e263aecbc92b84"><div class="ttname"><a href="message__queue_8c.html#af833b67b3ae9804347e263aecbc92b84">time_synced</a></div><div class="ttdeci">bool time_synced</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00186">message_queue.c:186</a></div></div>
</div><!-- fragment --><p><b>Sync Triggers</b>:</p><ol type="1">
<li><b>Initial sync</b>: On <span class="tt">NETWORK_EVER_CONNECTED</span> message (first connection)</li>
<li><b>Periodic re-sync</b>: Every 6 hours (TIME_RESYNC_INTERVAL_MS)<ul>
<li><b>Rationale</b>: RC oscillator drift compensation (Â±250 ppm = max Â±21.6s/day)</li>
<li>Triggered on <span class="tt">NETWORK_CONNECTED</span> if interval elapsed</li>
</ul>
</li>
</ol>
<p><b>Conversion Logic</b>: </p><div class="fragment"><div class="line">int64_t <a class="code hl_function" href="message__queue_8c.html#ac00cd01a7154d3dd81f1350d4f45f671">uptime_to_unix_epoch</a>(int64_t uptime_ms) {</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code hl_variable" href="message__queue_8c.html#a24f289b5acdd69f6969843364b8f96ac">time_sync_state</a>.time_synced) {</div>
<div class="line">        <span class="keywordflow">return</span> 0;  <span class="comment">// Not synced yet</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> uptime_ms + <a class="code hl_variable" href="message__queue_8c.html#a24f289b5acdd69f6969843364b8f96ac">time_sync_state</a>.unix_epoch_offset_ms;</div>
<div class="line">}</div>
<div class="ttc" id="amessage__queue_8c_html_ac00cd01a7154d3dd81f1350d4f45f671"><div class="ttname"><a href="message__queue_8c.html#ac00cd01a7154d3dd81f1350d4f45f671">uptime_to_unix_epoch</a></div><div class="ttdeci">static int64_t uptime_to_unix_epoch(int64_t uptime_ms)</div><div class="ttdoc">Convert uptime to Unix epoch timestamp.</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00201">message_queue.c:201</a></div></div>
</div><!-- fragment --><p><b>Field Naming Convention</b>:</p><ul>
<li><span class="tt">uptime_ms</span>: System uptime milliseconds (k_uptime_get)</li>
<li><span class="tt">timestamp_epoch_ms</span>: Unix epoch milliseconds (converted or from P1)</li>
<li><span class="tt">timestamp_epoch_s</span>: Unix epoch seconds (P1 internal storage)</li>
<li>Suffix clearly indicates unit AND time base</li>
</ul>
<p><b>Benefits</b>:</p><ul>
<li>âœ… Data acquisitie onafhankelijk van netwerkstatus</li>
<li>âœ… Buffering werkt offline</li>
<li>âœ… Accurate timestamps zodra tijd gesynchroniseerd is</li>
<li>âœ… Backend kan invalid timestamps detecteren (<span class="tt">ts_sync: false</span>)</li>
<li>âœ… Drift compensatie via periodic re-sync</li>
<li>âœ… P1 meter timestamps behouden originele nauwkeurigheid</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md148"></a>
Cloud Message Format</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md149"></a>
External Interface Contract</h2>
<p>De Message Queue module produceert JSON berichten die naar nRF Cloud gestuurd worden via MQTT. Dit is een <b>externe interface</b> - de cloud/backend moet dit formaat begrijpen voor data processing.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md150"></a>
Message Structure</h2>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;appId&quot;: &quot;DINNIS&quot;,</div>
<div class="line">  &quot;messageType&quot;: &quot;DATA&quot;,</div>
<div class="line">  &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">  &quot;ts_sync&quot;: &lt;boolean&gt;,</div>
<div class="line">  &quot;data&quot;: {</div>
<div class="line">    &quot;p1&quot;: {</div>
<div class="line">      &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">      &quot;ec1&quot;: &lt;energy_consumed_tariff1_wh&gt;,</div>
<div class="line">      &quot;ec2&quot;: &lt;energy_consumed_tariff2_wh&gt;,</div>
<div class="line">      &quot;ed1&quot;: &lt;energy_delivered_tariff1_wh&gt;,</div>
<div class="line">      &quot;ed2&quot;: &lt;energy_delivered_tariff2_wh&gt;,</div>
<div class="line">      &quot;gdm3&quot;: &lt;gas_consumed_cubic_decimeters&gt;,</div>
<div class="line">      &quot;pca&quot;: &lt;power_consumed_avg_w&gt;,</div>
<div class="line">      &quot;pcx&quot;: &lt;power_consumed_max_w&gt;,</div>
<div class="line">      &quot;pcxts&quot;: &lt;power_consumed_max_timestamp_ms&gt;,</div>
<div class="line">      &quot;pcn&quot;: &lt;power_consumed_min_w&gt;,</div>
<div class="line">      &quot;pda&quot;: &lt;power_delivered_avg_w&gt;,</div>
<div class="line">      &quot;pdx&quot;: &lt;power_delivered_max_w&gt;,</div>
<div class="line">      &quot;pdxts&quot;: &lt;power_delivered_max_timestamp_ms&gt;,</div>
<div class="line">      &quot;pdn&quot;: &lt;power_delivered_min_w&gt;</div>
<div class="line">    },</div>
<div class="line">    &quot;pulse&quot;: {</div>
<div class="line">      &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">      &quot;ch1&quot;: &lt;channel1_pulse_count&gt;,</div>
<div class="line">      &quot;ch2&quot;: &lt;channel2_pulse_count&gt;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md151"></a>
Field Definitions</h2>
<p><b>Root Level:</b></p><ul>
<li><span class="tt">appId</span>: Application identifier - <span class="tt">"DINNIS"</span> (device name)</li>
<li><span class="tt">messageType</span>: Message type - <span class="tt">"DATA"</span> (telemetry data)</li>
<li><span class="tt">ts</span>: Message creation timestamp (milliseconds since Unix epoch)</li>
<li><span class="tt">ts_sync</span>: Time synchronization status - <span class="tt">true</span> if timestamps valid, <span class="tt">false</span> if not synced (ts = 0)</li>
</ul>
<p><b>P1 DSMR Data</b> (optional - alleen aanwezig als P1 data ontvangen):</p><ul>
<li><span class="tt">ts</span>: P1 data acquisition timestamp (from meter OBIS 0-0:1.0.0, Unix epoch ms)</li>
<li><span class="tt">ec1</span>/<span class="tt">ec2</span>: Energy Consumed tariff 1/2 (Wh) - cumulative counters</li>
<li><span class="tt">ed1</span>/<span class="tt">ed2</span>: Energy Delivered tariff 1/2 (Wh) - cumulative counters (solar/generation)</li>
<li><span class="tt">gdm3</span>: Gas consumption (dmÂ³ = liters) - 1 dmÂ³ = 0.001 mÂ³ = 1 liter</li>
<li><span class="tt">pca</span>/<span class="tt">pcx</span>/<span class="tt">pcn</span>: Power Consumed Average/Maximum/Minimum (W)</li>
<li><span class="tt">pcxts</span>: Timestamp when maximum power consumption occurred (from P1 meter, Unix epoch ms)</li>
<li><span class="tt">pda</span>/<span class="tt">pdx</span>/<span class="tt">pdn</span>: Power Delivered Average/Maximum/Minimum (W)</li>
<li><span class="tt">pdxts</span>: Timestamp when maximum power delivery occurred (from P1 meter, Unix epoch ms)</li>
</ul>
<p><b>Pulse Counter Data</b> (optional - alleen aanwezig als Pulse data ontvangen):</p><ul>
<li><span class="tt">ts</span>: Pulse data acquisition timestamp (converted from system uptime to Unix epoch ms)</li>
<li><span class="tt">ch1</span>/<span class="tt">ch2</span>: Pulse counts for channel 1 and 2 - cumulative counters (uint64_t)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md152"></a>
Design Rationale: Short Key Names</h2>
<p><b>Probleem</b>: LTE-M bandbreedte is beperkt en kostbaar.</p>
<p><b>Design Keuze</b>: Gebruik 2-5 character key names in plaats van descriptieve namen.</p>
<p><b>Voorbeelden</b>:</p><ul>
<li><span class="tt">ec1</span> in plaats van <span class="tt">energy_consumed_tariff1_wh</span> (30 bytes â†’ 3 bytes)</li>
<li><span class="tt">gdm3</span> in plaats van <span class="tt">gas_consumed_cubic_decimeters</span> (33 bytes â†’ 4 bytes)</li>
<li><span class="tt">pcxts</span> in plaats van <span class="tt">power_consumed_max_timestamp</span> (29 bytes â†’ 5 bytes)</li>
</ul>
<p><b>Impact</b>:</p><ul>
<li>Bericht grootte: ~200 bytes (vs ~400 bytes met lange namen)</li>
<li>Bandbreedte besparing: ~50%</li>
<li>Bij 144 berichten/dag: ~29 KB/dag (vs ~58 KB/dag)</li>
<li>Maandelijks: ~870 KB (vs ~1.74 MB)</li>
</ul>
<p><b>Trade-off</b>: Leesbaarheid vs bandbreedte. Documentatie compenseert voor afkortingen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md153"></a>
Message Presence Scenarios</h2>
<p>De <span class="tt">data</span> sectie kan P1 en/of Pulse data bevatten, afhankelijk van welke data ontvangen werd:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Scenario  </th><th class="markdownTableHeadNone">P1 Aanwezig  </th><th class="markdownTableHeadNone">Pulse Aanwezig  </th><th class="markdownTableHeadNone">Situatie  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Complete  </td><td class="markdownTableBodyNone">âœ…  </td><td class="markdownTableBodyNone">âœ…  </td><td class="markdownTableBodyNone">Beide data sources ontvangen (ideaal)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">P1 Only  </td><td class="markdownTableBodyNone">âœ…  </td><td class="markdownTableBodyNone">â—  </td><td class="markdownTableBodyNone">Alleen slimme meter data  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Pulse Only  </td><td class="markdownTableBodyNone">â—  </td><td class="markdownTableBodyNone">âœ…  </td><td class="markdownTableBodyNone">Alleen puls-tellers data  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Empty  </td><td class="markdownTableBodyNone">â—  </td><td class="markdownTableBodyNone">â—  </td><td class="markdownTableBodyNone">Geen data ontvangen (error conditie)  </td></tr>
</table>
<p><b>Rationale</b>: Module stuurt altijd een bericht, ook als slechts Ã©Ã©n data source beschikbaar is. Dit voorkomt data loss en geeft visibility in data acquisition problemen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md154"></a>
Transport Details</h2>
<ul>
<li><b>Protocol</b>: MQTT over TLS</li>
<li><b>QoS Level</b>: QoS 1 (At-least-once delivery) - garanteert delivery met acknowledgment</li>
<li><b>Topic</b>: <span class="tt">NRF_CLOUD_TOPIC_MESSAGE</span> (nRF Cloud device-to-cloud messages endpoint)</li>
<li><b>Encoding</b>: UTF-8 JSON</li>
<li><b>Max Message Size</b>: ~512 bytes (ruim binnen MQTT packet limits)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md155"></a>
Gas Unit Clarification</h2>
<p><b>Belangrijk</b>: <span class="tt">gdm3</span> gebruikt <b>kubieke decimeters</b> (dmÂ³):</p><ul>
<li>1 dmÂ³ = 1 liter = 0.001 mÂ³</li>
</ul>
<p><b>Voorbeeld</b>: Waarde <span class="tt">1500</span> betekent 1500 dmÂ³ = 1500 liter = 1.5 mÂ³ gas verbruik.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md157"></a>
Queue Overflow Gedrag</h1>
<p><b>Probleem</b>: Queue kan vol raken bij langdurige cloud outage (&gt; 24 uur).</p>
<p><b>Design Keuze</b>: FIFO drop (First In, First Out) - oudste bericht wordt gedropped.</p>
<p><b>Implementatie</b> (in <span class="tt"><a class="el" href="message__queue_8c.html#af7e68654facf8babc9920ba337d98b3f" title="Queue a combined energy message with FIFO drop-oldest strategy.">queue_combined_message()</a></span>): </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (k_msgq_num_free_get(&amp;combined_energy_msgq) == 0) {</div>
<div class="line">    <span class="keyword">struct </span><a class="code hl_struct" href="structcombined__energy__msg.html">combined_energy_msg</a> dropped;</div>
<div class="line">    err = k_msgq_get(&amp;combined_energy_msgq, &amp;dropped, K_NO_WAIT);</div>
<div class="line">    LOG_WRN(<span class="stringliteral">&quot;Queue full, dropped oldest message (timestamp: %lld)&quot;</span>, </div>
<div class="line">            dropped.timestamp);</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Rationale</b>:</p><ul>
<li>Nieuwste data is relevanter dan oude data (energie metingen zijn time-series)</li>
<li><span class="tt">LOG_WRN</span> voor visibility (monitoring kan alerts triggeren)</li>
<li>Alternatief (block/crash) is slechter: hele systeem hangt</li>
<li>Graceful degradation: systeem blijft functioneren</li>
</ul>
<p><b>Praktijk</b>:</p><ul>
<li>Typische collectie interval: 10 minuten (6 berichten/uur)</li>
<li>Buffer capacity: 144 berichten = 24 uur buffering</li>
<li>Bij 2 uur cloud outage: 12 berichten gebufferd (~8% van capacity)</li>
<li>Overflow verwachting: &lt; 0.1% van de tijd (alleen bij multi-day outages)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md159"></a>
Configuratie</h1>
<p>Alle configuratie via Kconfig (<span class="tt">Kconfig.message_queue</span>):</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Parameter  </th><th class="markdownTableHeadNone">Default  </th><th class="markdownTableHeadNone">Beschrijving  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">CONFIG_APP_MESSAGE_QUEUE_MODULE_QUEUE_SIZE</span>  </td><td class="markdownTableBodyNone">144  </td><td class="markdownTableBodyNone">Queue capacity (berichten) - 24u buffering bij 10min interval  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">CONFIG_APP_MESSAGE_QUEUE_MODULE_THREAD_STACK_SIZE</span>  </td><td class="markdownTableBodyNone">2048  </td><td class="markdownTableBodyNone">Stack size module thread  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">CONFIG_APP_MESSAGE_QUEUE_MODULE_WATCHDOG_TIMEOUT_SECONDS</span>  </td><td class="markdownTableBodyNone">660  </td><td class="markdownTableBodyNone">Task watchdog timeout (11 minuten)  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">CONFIG_APP_MESSAGE_QUEUE_MODULE_MSG_PROCESSING_TIME_SECONDS</span>  </td><td class="markdownTableBodyNone">60  </td><td class="markdownTableBodyNone">Max message processing time  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">CONFIG_NRF_CLOUD_DINNIS_DATA_MSG_APPID</span>  </td><td class="markdownTableBodyNone">"DINNIS"  </td><td class="markdownTableBodyNone">nRF Cloud appId voor data messages  </td></tr>
</table>
<p><b>Hardcoded Constants</b> (in code):</p><ul>
<li><span class="tt">COLLECTION_TIMEOUT_MS</span> = 1000 (collectie window)</li>
<li><span class="tt">MAX_MSGS_PER_CYCLE</span> = 10 (max berichten per send cyclus)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md161"></a>
Toekomstige Uitbreidingen</h1>
<ul>
<li>â³ <b>Persistent queue</b> - Flash backed queue voor reboot safety (NVS storage)</li>
<li>â³ <b>Compression</b> - LZ4/ZSTD compressie voor cloud payload (bandwidth besparing)</li>
<li>â³ <b>Priority levels</b> - Kritieke berichten (errors, alerts) voorrang</li>
<li>â³ <b>Adaptive send strategy</b> - Dynamisch send interval op basis van queue depth</li>
<li>â³ <b>Collection window tuning</b> - Configureerbare timeout via Kconfig</li>
<li>â³ <b>Send batch size tuning</b> - Configureerbare <span class="tt">MAX_MSGS_PER_CYCLE</span> via Kconfig</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md163"></a>
Zie Ook</h1>
<ul>
<li><a class="el" href="message__queue_8c.html">message_queue.c</a> - Implementatie</li>
<li><a class="el" href="message__queue__zbus_8h.html">message_queue_zbus.h</a> - ZBUS interfaces</li>
<li><a class="el" href="group__p__one.html">P1 DSMR - API Referentie</a> - P1 module (data producer)</li>
<li><a class="el" href="group__energy__pulse.html">Energy Pulse - API Referentie</a> - Pulse module (data producer)</li>
<li><a class="el" href="group__cloud.html">Cloud - API Referentie</a> - Cloud module (connection management) </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
