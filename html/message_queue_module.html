<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Message Queue Module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('message_queue_module.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Message Queue Module </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Combineert, buffert en verzendt energiemetingen naar de cloud.</p>
<h1 class="doxsection"><a class="anchor" id="mq_overview"></a>
Overzicht</h1>
<p>De <span class="tt">message_queue</span> module fungeert als het centrale data-aggregatiepunt van de firmware. Het combineert metingen van de <span class="tt">p_one</span> (slimme meter) en <span class="tt">energy_pulse</span> (puls-tellers) modules, buffert deze in een robuuste wachtrij en verzendt ze naar nRF Cloud. De timing van dataverzameling en verzending wordt aangestuurd door de <span class="tt">timing</span> module.</p>
<p>De belangrijkste functionaliteiten zijn:</p><ul>
<li><b>Gecoördineerde Dataverzameling</b>: Gebruikt een "collection window" om P1- en pulsdata te synchroniseren.</li>
<li><b>Robuuste Buffering</b>: Maakt gebruik van een Zephyr Message Queue (<span class="tt">k_msgq</span>) om tot 24 uur aan data te bufferen bij een cloud-onderbreking.</li>
<li><b>State Machine</b>: Een SMF-gebaseerde state machine beheert de dataverzameling en verzendpogingen.</li>
<li><b>Intelligente Timestamping</b>: Hanteert een tweeledige timestamp-strategie om data offline te kunnen verzamelen en later te voorzien van een accurate Unix epoch timestamp.</li>
<li><b>Efficiënt Cloudformaat</b>: Gebruikt een geoptimaliseerd JSON-formaat met korte sleutelnamen om datagebruik te minimaliseren.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="mq_dataflow"></a>
Data Flow &amp; State Machine</h1>
<p>De module doorloopt een cyclus van data verzamelen en verzenden, aangestuurd door de <span class="tt">timing</span> module.</p>
<div class="fragment"><div class="line">                    ┌────────────────────┐</div>
<div class="line">         ┌──────────┤ STATE_OPERATIONAL  ├─────────┐</div>
<div class="line">         │          │ (wacht op events)  │         │</div>
<div class="line">         │          └─────────┬──────────┘         │</div>
<div class="line">         │                    │                    │</div>
<div class="line">(DATA_PUBLISH_REQUEST)        │                    │ (DATA_SEND_REQUEST + cloud is gereed)</div>
<div class="line">         │                    │                    │</div>
<div class="line">         │          ┌─────────▼──────────┐         │</div>
<div class="line">         │          │STATE_COLLECTING_DATA         │</div>
<div class="line">         │          │(1000ms window)     │         │</div>
<div class="line">         │          └─────────┬──────────┘         │</div>
<div class="line">         │                    │                    │</div>
<div class="line">         │ (Timeout of beide   │                    │</div>
<div class="line">         │   berichten ontvangen)                   │</div>
<div class="line">         │                    │                    │</div>
<div class="line">         │          ┌─────────▼──────────┐         │</div>
<div class="line">         └─────────►│STATE_SEND_MSG_ATTEMPT◄─────────┘</div>
<div class="line">                    │(verzendt tot 10   │</div>
<div class="line">                    │ berichten)         │</div>
<div class="line">                    └────────────────────┘</div>
<div class="line">                             │</div>
<div class="line">                             │ (Keert altijd direct</div>
<div class="line">                             │  terug naar OPERATIONAL)</div>
<div class="line">                             ▼</div>
</div><!-- fragment --><ol type="1">
<li><b><span class="tt">STATE_OPERATIONAL</span></b>: De standaardtoestand. De module wacht op ZBUS-berichten.</li>
<li><b><span class="tt">STATE_COLLECTING_DATA</span></b>:<ul>
<li><b>Trigger</b>: Een <span class="tt"><a class="el" href="structtiming__event__msg.html" title="Timing event message structure.">timing_event_msg</a></span> op <span class="tt">DATA_PUBLISH_REQUEST_CHAN</span>.</li>
<li><b>Actie</b>: Een 1000ms timer start. De module wacht op berichten op <span class="tt">P_ONE_CHAN</span> en <span class="tt">ENERGY_PULSE_CHAN</span>.</li>
<li><b>Exit</b>: De state eindigt wanneer beide berichten zijn ontvangen, of wanneer de 1000ms timer afloopt. De ontvangen data wordt gecombineerd tot een <span class="tt"><a class="el" href="structcombined__energy__msg.html" title="Combined energy message structure.">combined_energy_msg</a></span> en in de <span class="tt">combined_energy_msgq</span> geplaatst.</li>
</ul>
</li>
<li><b><span class="tt">STATE_SEND_MSG_ATTEMPT</span></b>:<ul>
<li><b>Trigger</b>: Een <span class="tt"><a class="el" href="structtiming__event__msg.html" title="Timing event message structure.">timing_event_msg</a></span> op <span class="tt">DATA_SEND_REQUEST_CHAN</span>, <b>alleen</b> als de cloudverbinding gereed is (<span class="tt">is_cloud_ready</span>).</li>
<li><b>Actie</b>: De module haalt tot 10 berichten uit de wachtrij en verzendt ze één voor één naar nRF Cloud. Als een verzending mislukt, stopt de cyclus en blijft de rest van de wachtrij intact voor de volgende poging.</li>
<li><b>Exit</b>: De state keert onmiddellijk terug naar <span class="tt">STATE_OPERATIONAL</span>.</li>
</ul>
</li>
</ol>
<h1 class="doxsection"><a class="anchor" id="mq_zbus"></a>
ZBUS Interface</h1>
<ul>
<li><b>Publiceert op</b>:<ul>
<li>Geen. De module communiceert direct met de nRF Cloud SDK.</li>
</ul>
</li>
<li><b>Luistert naar</b>:<ul>
<li><span class="tt">CLOUD_CHAN</span>: Om de <span class="tt">is_cloud_ready</span> status bij te houden.</li>
<li><span class="tt">NETWORK_CHAN</span>: Om de netwerkstatus te volgen voor het synchroniseren van de tijd.</li>
<li><span class="tt">P_ONE_CHAN</span>: Ontvangt <span class="tt"><a class="el" href="structp__one__msg.html" title="P_ONE module message structure.">p_one_msg</a></span> tijdens de <span class="tt">STATE_COLLECTING_DATA</span> state.</li>
<li><span class="tt">ENERGY_PULSE_CHAN</span>: Ontvangt <span class="tt"><a class="el" href="structenergy__pulse__msg.html" title="Energy pulse message.">energy_pulse_msg</a></span> tijdens de <span class="tt">STATE_COLLECTING_DATA</span> state.</li>
<li><span class="tt">DATA_PUBLISH_REQUEST_CHAN</span>: Start de <span class="tt">STATE_COLLECTING_DATA</span> state.</li>
<li><span class="tt">DATA_SEND_REQUEST_CHAN</span>: Start de <span class="tt">STATE_SEND_MSG_ATTEMPT</span> state.</li>
</ul>
</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="mq_timestamp"></a>
Timestamp Strategie</h1>
<p>Omdat het apparaat data kan verzamelen zonder actieve netwerkverbinding (en dus zonder kennis van de actuele tijd), wordt een tweeledige aanpak gebruikt:</p>
<ol type="1">
<li><b>Acquisitie (Offline)</b>:<ul>
<li>Alle metingen worden primair getimed met <span class="tt">k_uptime_get()</span>, de systeemtijd sinds de laatste boot.</li>
<li><b>Uitzondering</b>: De P1-meter levert zijn eigen, zeer accurate Unix epoch timestamp. Deze wordt direct gebruikt.</li>
</ul>
</li>
<li><b>Synchronisatie &amp; Verzending (Online)</b>:<ul>
<li>Bij de <b>eerste</b> netwerkverbinding wordt via de <span class="tt">date_time</span> library (die NTP gebruikt) de actuele Unix-tijd opgevraagd.</li>
<li>Het verschil tussen de Unix-tijd en de huidige <span class="tt">uptime</span> wordt berekend en opgeslagen als <span class="tt">unix_epoch_offset_ms</span>.</li>
<li>Om klokdrift van de interne RC-oscillator te compenseren, wordt deze synchronisatie <b>elke 6 uur</b> herhaald.</li>
<li>Bij het verzenden van data wordt de opgeslagen <span class="tt">uptime_ms</span> van een meting omgezet naar een Unix epoch timestamp met behulp van de <span class="tt">unix_epoch_offset_ms</span>.</li>
<li>De JSON-payload bevat een <span class="tt">ts_sync: true/false</span> vlag, zodat de backend weet of de timestamps betrouwbaar zijn.</li>
</ul>
</li>
</ol>
<p>Deze aanpak garandeert dat data altijd verzameld kan worden, terwijl de timestamps zo accuraat mogelijk zijn zodra het apparaat online komt.</p>
<h1 class="doxsection"><a class="anchor" id="mq_cloudformat"></a>
Cloud Message Format</h1>
<p>De module produceert een JSON-bericht dat via MQTT naar nRF Cloud wordt gestuurd.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;appId&quot;: &quot;DINNIS&quot;,</div>
<div class="line">  &quot;messageType&quot;: &quot;DATA&quot;,</div>
<div class="line">  &quot;dataFormatVersion&quot;: &quot;DINNIS_V1&quot;,</div>
<div class="line">  &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">  &quot;ts_sync&quot;: &lt;boolean&gt;,</div>
<div class="line">  &quot;data&quot;: {</div>
<div class="line">    &quot;p1&quot;: {</div>
<div class="line">      &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">      &quot;ec1&quot;: &lt;energy_consumed_tariff1_wh&gt;,</div>
<div class="line">      &quot;ec2&quot;: &lt;energy_consumed_tariff2_wh&gt;,</div>
<div class="line">      &quot;ed1&quot;: &lt;energy_delivered_tariff1_wh&gt;,</div>
<div class="line">      &quot;ed2&quot;: &lt;energy_delivered_tariff2_wh&gt;,</div>
<div class="line">      &quot;gdm3&quot;: &lt;gas_consumed_cubic_decimeters&gt;,</div>
<div class="line">      &quot;pca&quot;: &lt;power_consumed_avg_w&gt;,</div>
<div class="line">      &quot;pcx&quot;: &lt;power_consumed_max_w&gt;,</div>
<div class="line">      &quot;pcxts&quot;: &lt;power_consumed_max_timestamp_ms&gt;,</div>
<div class="line">      &quot;pcn&quot;: &lt;power_consumed_min_w&gt;,</div>
<div class="line">      &quot;pda&quot;: &lt;power_delivered_avg_w&gt;,</div>
<div class="line">      &quot;pdx&quot;: &lt;power_delivered_max_w&gt;,</div>
<div class="line">      &quot;pdxts&quot;: &lt;power_delivered_max_timestamp_ms&gt;,</div>
<div class="line">      &quot;pdn&quot;: &lt;power_delivered_min_w&gt;</div>
<div class="line">    },</div>
<div class="line">    &quot;pulse&quot;: {</div>
<div class="line">      &quot;ts&quot;: &lt;unix_epoch_milliseconds&gt;,</div>
<div class="line">      &quot;ch1&quot;: &lt;channel1_pulse_count_wh&gt;,</div>
<div class="line">      &quot;ch2&quot;: &lt;channel2_pulse_count_wh&gt;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Belangrijkste Velden:</b></p><ul>
<li><span class="tt">appId</span>: Identificeert de applicatie/board (bv. <span class="tt">"DINNIS"</span>).</li>
<li><span class="tt">dataFormatVersion</span>: Versie van de payload, bv. <span class="tt">"DINNIS_V1"</span>. Maakt toekomstige aanpassingen mogelijk zonder de backend te breken.</li>
<li><span class="tt">ts</span>: Timestamp van het bericht (Unix epoch in ms).</li>
<li><span class="tt">ts_sync</span>: <span class="tt">true</span> als de tijd gesynchroniseerd is, anders <span class="tt">false</span>.</li>
<li><span class="tt">data</span>: Bevat de geneste <span class="tt">p1</span> en/of <span class="tt">pulse</span> objecten.</li>
<li><b>Korte Sleutelnamen</b>: Namen als <span class="tt">ec1</span> (i.p.v. <span class="tt">energy_consumed_tariff1_wh</span>) worden gebruikt om datagebruik te minimaliseren.</li>
</ul>
<h1 class="doxsection"><a class="anchor" id="mq_buffering"></a>
Buffering en Wachtrij</h1>
<ul>
<li><b>Wachtrij</b>: Een <span class="tt">k_msgq</span> met een standaardcapaciteit van 144 berichten. Bij een interval van 10 minuten is dit genoeg voor <b>24 uur</b> aan data.</li>
<li><b>Overflow</b>: Als de wachtrij vol is (bv. bij een langdurige storing), wordt het <b>oudste</b> bericht verwijderd om plaats te maken voor het nieuwste (FIFO drop-strategie). Dit wordt gelogd als een waarschuwing.</li>
<li><b>Verzendstrategie</b>: De module probeert maximaal 10 berichten per cyclus te verzenden. Dit voorkomt dat de verbinding te lang bezet wordt gehouden en geeft andere modules (zoals FOTA) ook een kans. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
