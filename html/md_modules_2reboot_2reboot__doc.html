<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: &lt;!--</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_modules_2reboot_2reboot__doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"></div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>title: Reboot Module parent: Modules </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md141"></a>
grand_parent: Design</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md142"></a>
Reboot Module</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md143"></a>
Inhoudsopgave</h2>
<ul>
<li>Overzicht</li>
<li>Waarom een Reboot Module?</li>
<li>Functionaliteit</li>
<li>Shutdown Protocol</li>
<li>Architectuur en Gedrag</li>
<li>Betrouwbaarheid</li>
<li>Implementatie Vereisten voor Modules</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md144"></a>
Overzicht</h2>
<p>De <span class="tt">reboot</span> module orkestreert een <em>graceful shutdown</em> en herstart van het systeem. Het zorgt ervoor dat alle andere modules de kans krijgen om hun taken netjes af te ronden, data op te slaan en verbindingen te sluiten voordat het systeem daadwerkelijk herstart. Dit voorkomt dataverlies, corrupte state en problemen bij het herverbinden met de cloud.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md145"></a>
Waarom een Reboot Module?</h2>
<p>Een directe aanroep van <span class="tt">sys_reboot()</span> kan leiden tot een "dirty" shutdown, met diverse problemen tot gevolg:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Probleem  </th><th class="markdownTableHeadNone">Gevolg  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Dataverlies</b>  </td><td class="markdownTableBodyNone">De <span class="tt">p_one</span> module heeft een half-ontvangen P1-telegram in zijn buffer.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><b>Verbindingsproblemen</b>  </td><td class="markdownTableBodyNone">De <span class="tt">cloud</span> module heeft een open TCP-socket; de server ziet een trage timeout.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><b>Flash Corruptie</b>  </td><td class="markdownTableBodyNone">De <span class="tt">settings</span> module heeft data in de cache die nog niet naar flash is geschreven.  </td></tr>
</table>
<p>De <span class="tt">reboot</span> module lost dit op door een gecoördineerd shutdown-protocol af te dwingen, wat resulteert in een "clean" reboot.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md146"></a>
Functionaliteit</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md147"></a>
Reboot Types</h3>
<p>De module handelt twee soorten reboot-verzoeken af, die beide dezelfde graceful shutdown procedure starten:</p>
<ul>
<li><b><span class="tt">REBOOT_TYPE_FOTA</span></b>: Wordt aangevraagd na een succesvolle download van een firmware-update.</li>
<li><b><span class="tt">REBOOT_TYPE_ERROR</span></b>: Wordt aangevraagd door een module die een kritieke, maar mogelijk herstelbare, fout detecteert die een herstart vereist.</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md148"></a>
ZBUS Protocol</h3>
<p>De module gebruikt één ZBUS-kanaal, <span class="tt">REBOOT_CHAN</span>, voor alle communicatie, met drie verschillende berichttypes:</p>
<ol type="1">
<li><b><span class="tt">REBOOT_REQ</span></b><ul>
<li><b>Gepubliceerd door</b>: Elke module die een herstart wil initiëren (bv. <span class="tt">cloud</span> na FOTA, of een module die een fatale fout detecteert).</li>
<li><b>Inhoud</b>: <span class="tt"><a class="el" href="group__reboot.html#gac6444349816e68cc7912753237f2b1dc" title="Reboot types.">reboot_type</a></span> (<span class="tt">REBOOT_TYPE_FOTA</span> of <span class="tt">REBOOT_TYPE_ERROR</span>).</li>
<li><b>Actie</b>: Start de graceful shutdown sequentie in de <span class="tt">reboot</span> module.</li>
</ul>
</li>
<li><b><span class="tt">SHUTDOWN_REQ</span></b><ul>
<li><b>Gepubliceerd door</b>: De <span class="tt">reboot</span> module zelf, als reactie op een <span class="tt">REBOOT_REQ</span>.</li>
<li><b>Actie</b>: Een broadcast naar alle andere modules om hun shutdown-procedures te starten.</li>
</ul>
</li>
<li><b><span class="tt">SHUTDOWN_ACK</span></b><ul>
<li><b>Gepubliceerd door</b>: Elke module, nadat deze zijn cleanup-taken heeft voltooid.</li>
<li><b>Inhoud</b>: Een pointer naar de ZBUS-observer van de module (<span class="tt">observer</span>).</li>
<li><b>Actie</b>: De <span class="tt">reboot</span> module gebruikt dit om bij te houden welke modules klaar zijn.</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md149"></a>
Shutdown Protocol</h2>
<p>De graceful shutdown volgt een strikt protocol dat wordt gemedieerd door ZBUS.</p>
<div class="fragment"><div class="line">sequenceDiagram</div>
<div class="line">    participant Andere Module</div>
<div class="line">    participant ZBUS</div>
<div class="line">    participant Reboot Module</div>
<div class="line">    participant Work Queue</div>
<div class="line">    participant System</div>
<div class="line"> </div>
<div class="line">    Andere Module-&gt;&gt;+ZBUS: Publish(REBOOT_CHAN, {type: REBOOT_REQ})</div>
<div class="line">    ZBUS--&gt;&gt;-Reboot Module: Ontvangt REBOOT_REQ</div>
<div class="line">    </div>
<div class="line">    Reboot Module-&gt;&gt;+Work Queue: Schedule reboot_work (met lange timeout)</div>
<div class="line">    Reboot Module-&gt;&gt;+ZBUS: Publish(REBOOT_CHAN, {type: SHUTDOWN_REQ})</div>
<div class="line">    </div>
<div class="line">    ZBUS--&gt;&gt;Andere Module: Ontvangt SHUTDOWN_REQ</div>
<div class="line">    Note right of Andere Module: Start cleanup: &lt;br/&gt;- Stop timers/interrupts&lt;br/&gt;- Sla data op&lt;br/&gt;- Sluit verbindingen</div>
<div class="line">    Andere Module-&gt;&gt;+ZBUS: Publish(REBOOT_CHAN, {type: SHUTDOWN_ACK})</div>
<div class="line">    </div>
<div class="line">    ZBUS--&gt;&gt;-Reboot Module: Ontvangt SHUTDOWN_ACK</div>
<div class="line">    Reboot Module-&gt;&gt;Reboot Module: Disables observer, telt resterende ACKs</div>
<div class="line">    </div>
<div class="line">    Note over Reboot Module: Herhaalt voor elke module...</div>
<div class="line">    </div>
<div class="line">    Reboot Module-&gt;&gt;Reboot Module: Alle ACKs ontvangen!</div>
<div class="line">    Reboot Module-&gt;&gt;+Work Queue: Reschedule reboot_work (met korte timeout, bv. 3s)</div>
<div class="line">    </div>
<div class="line">    Work Queue--&gt;&gt;-Reboot Module: Voert reboot_work_fn uit</div>
<div class="line">    Reboot Module-&gt;&gt;System: sys_reboot()</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md150"></a>
Architectuur en Gedrag</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md151"></a>
State Machine</h3>
<p>De module heeft een uiterst minimale state machine met slechts één state: <span class="tt">STATE_OPERATIONAL</span>. Alle logica wordt afgehandeld binnen de <span class="tt">run</span> functie van deze state. De timing en de uiteindelijke reboot-actie worden gedelegeerd aan een work queue, waardoor de state machine zelf eenvoudig en niet-blokkerend blijft.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md152"></a>
Acknowledgement (ACK) Tracking</h3>
<p>De module gebruikt een slim mechanisme om bij te houden welke modules hun shutdown hebben bevestigd, zonder een expliciete teller-variabele te gebruiken.</p>
<ol type="1">
<li>Wanneer de <span class="tt">reboot</span> module een <span class="tt">SHUTDOWN_REQ</span> uitzendt, zijn alle relevante modules actieve observers op <span class="tt">REBOOT_CHAN</span>.</li>
<li>Wanneer een module een <span class="tt">SHUTDOWN_ACK</span> stuurt, voegt hij een pointer naar zijn eigen ZBUS-observer toe aan het bericht.</li>
<li>De <span class="tt">reboot</span> module ontvangt de ACK en deactiveert de observer van de zendende module met <span class="tt">zbus_obs_set_enable(observer, false)</span>.</li>
<li>Vervolgens telt de <span class="tt">reboot</span> module het aantal nog actieve observers op het kanaal met een lokale helper-functie <span class="tt"><a class="el" href="reboot_8c.html#af8dc2f56ec10b29d09795b6316eb91f0" title="Count enabled observers on a ZBUS channel.">zbus_chan_enabled_obs_count()</a></span>.</li>
<li>Zodra het aantal actieve observers <span class="tt">1</span> is (alleen de <span class="tt">reboot</span> module zelf is nog actief), zijn alle ACKs ontvangen.</li>
</ol>
<p>Dit patroon is robuust, thread-safe en past zich dynamisch aan de modules die in de firmware zijn ingeschakeld.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md153"></a>
Work Queue en Timeout Mechanisme</h3>
<p>De daadwerkelijke <span class="tt">sys_reboot()</span> aanroep is blokkerend en mag nooit rechtstreeks vanuit een ZBUS-callback worden uitgevoerd. Daarom wordt deze taak gedelegeerd aan een <span class="tt">k_work_delayable</span> item.</p>
<p>Dit patroon fungeert tevens als een <b>watchdog voor het shutdown-proces</b>:</p>
<ol type="1">
<li><b>Bij <span class="tt">REBOOT_REQ</span></b>: De reboot-taak wordt ingepland met een ruime timeout (bv. 60 seconden, geconfigureerd via Kconfig <span class="tt">CONFIG_APP_REBOOT_MODULE_ERROR_TIMEOUT_SECONDS</span>).</li>
<li><b>Bij alle ACKs ontvangen</b>: De taak wordt <em>vervroegd</em> en opnieuw ingepland met een korte vertraging (bv. 3 seconden), wat een snelle, gecontroleerde herstart mogelijk maakt.</li>
<li><b>Indien niet alle ACKs binnen de timeout worden ontvangen</b>: De oorspronkelijk ingeplande taak wordt alsnog uitgevoerd. Dit forceert een herstart en voorkomt dat het systeem oneindig blijft hangen als een module niet reageert.</li>
</ol>
<p>De work queue draait op <span class="tt">K_HIGHEST_APPLICATION_THREAD_PRIO</span> om te garanderen dat de reboot-procedure voorrang krijgt op andere applicatietaken.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md154"></a>
Betrouwbaarheid</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md155"></a>
Fatale Foutafhandeling</h3>
<p>De <span class="tt">reboot</span> module zelf is essentieel voor de stabiliteit van het systeem. Als er binnen deze module een onherstelbare fout optreedt (bv. de eigen watchdog van de module wordt getriggerd, of het inplannen van de reboot-taak mislukt), wordt de <span class="tt"><a class="el" href="reboot_8c.html#a2c4433540d1e262b8927b4ac7d676fdb">REBOOT_MODULE_FATAL_ERROR_HANDLE()</a></span> macro aangeroepen. Deze macro:</p><ol type="1">
<li>Logt een paniekbericht.</li>
<li>Wacht 10 seconden om de logs te laten verwerken.</li>
<li>Forceert een onmiddellijke, "warme" herstart (<span class="tt">sys_reboot(SYS_REBOOT_WARM)</span>).</li>
</ol>
<p>Dit is het laatste redmiddel om het systeem te herstellen.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md156"></a>
Graceful vs. Geforceerde Shutdown</h3>
<ul>
<li><b>Normaal scenario</b>: Alle modules sturen een ACK. De totale shutdown-tijd is kort (bv. ~5 seconden) en het risico op dataverlies is minimaal.</li>
<li><b>Foutscenario</b>: Eén module reageert niet. De shutdown-timeout wordt bereikt en de reboot wordt geforceerd. Alleen de niet-reagerende module loopt risico op dataverlies; de andere modules hebben hun cleanup al voltooid.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md157"></a>
Implementatie Vereisten voor Modules</h2>
<p>Elke module die een schone shutdown vereist, moet het volgende implementeren:</p>
<ol type="1">
<li><b>Abonneren op <span class="tt">REBOOT_CHAN</span></b>.</li>
<li>Een handler implementeren voor het <span class="tt">SHUTDOWN_REQ</span> bericht. In deze handler: a. Stop alle actieve operaties (timers, interrupts, etc.). b. Sla kritieke data op (bv. via de <span class="tt">settings</span> API). c. Sluit externe verbindingen (bv. netwerk-sockets). d. Roep <span class="tt">shutdown_acknowledge_publish(&amp;jouw_subscriber)</span> aan om de ACK te versturen.</li>
</ol>
<p><b>Voorbeeld (conceptueel):</b> </p><div class="fragment"><div class="line"><span class="comment">// In de ZBUS message handler van een module</span></div>
<div class="line"><span class="keywordflow">if</span> (msg-&gt;type == <a class="code hl_enumvalue" href="group__reboot.html#gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323">SHUTDOWN_REQ</a>) {</div>
<div class="line">    <span class="comment">// 1. Stop operaties</span></div>
<div class="line">    k_timer_stop(&amp;my_timer);</div>
<div class="line">    uart_rx_disable(<a class="code hl_variable" href="p__one_8c.html#a660f23134aaae43c9ff2c6096fa59342">uart_dev</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 2. Sla state op</span></div>
<div class="line">    settings_save(<span class="stringliteral">&quot;my_module/my_value&quot;</span>, &amp;<a class="code hl_variable" href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a>, <span class="keyword">sizeof</span>(<a class="code hl_variable" href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a>));</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// 3. Stuur ACK</span></div>
<div class="line">    <a class="code hl_function" href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650">shutdown_acknowledge_publish</a>(&amp;my_subscriber);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__reboot_html_gac92d45e2bf7302d8b7691195e0d23650"><div class="ttname"><a href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650">shutdown_acknowledge_publish</a></div><div class="ttdeci">void shutdown_acknowledge_publish(const struct zbus_observer *observer)</div><div class="ttdoc">Publish shutdown acknowledgment to ZBUS.</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8c_source.html#l00088">reboot_zbus.c:88</a></div></div>
<div class="ttc" id="agroup__reboot_html_gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323"><div class="ttname"><a href="group__reboot.html#gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323">SHUTDOWN_REQ</a></div><div class="ttdeci">@ SHUTDOWN_REQ</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8h_source.html#l00055">reboot_zbus.h:55</a></div></div>
<div class="ttc" id="ap__one_8c_html_a354b99b030bdfe136490f848c05d4788"><div class="ttname"><a href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a></div><div class="ttdeci">obis_fixed_point_t value</div><div class="ttdef"><b>Definition</b> <a href="p__one_8c_source.html#l00256">p_one.c:256</a></div></div>
<div class="ttc" id="ap__one_8c_html_a660f23134aaae43c9ff2c6096fa59342"><div class="ttname"><a href="p__one_8c.html#a660f23134aaae43c9ff2c6096fa59342">uart_dev</a></div><div class="ttdeci">static const struct device * uart_dev</div><div class="ttdef"><b>Definition</b> <a href="p__one_8c_source.html#l00222">p_one.c:222</a></div></div>
</div><!-- fragment --><p>Een <b>checklist</b> voor elke nieuwe module:</p><ul class="check">
<li class="unchecked">Geabonneerd op <span class="tt">REBOOT_CHAN</span>?</li>
</ul>
<ul class="check">
<li class="unchecked">Handler voor <span class="tt">SHUTDOWN_REQ</span> geïmplementeerd?</li>
</ul>
<ul class="check">
<li class="unchecked">Worden alle resources (timers, verbindingen) opgeschoond?</li>
</ul>
<ul class="check">
<li class="unchecked">Wordt kritieke state opgeslagen?</li>
</ul>
<ul class="check">
<li class="unchecked">Wordt <span class="tt"><a class="el" href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650" title="Publish shutdown acknowledgment to ZBUS.">shutdown_acknowledge_publish()</a></span> aangeroepen?</li>
</ul>
<ul class="check">
<li class="unchecked">Is de shutdown-procedure getest en voltooit deze binnen de Kconfig-timeout? --&gt; </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
