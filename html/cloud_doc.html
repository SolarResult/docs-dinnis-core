<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Cloud Module - Documentatie</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('cloud_doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Cloud Module - Documentatie </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_modules_2cloud_2cloud__doc"></a></p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md17"></a>
ğŸ”— Navigatie</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Sectie  </th><th class="markdownTableHeadNone">Link  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“š <b>API Referentie</b>  </td><td class="markdownTableBodyNone"><a class="el" href="group__cloud.html">Cloud - API Referentie</a> - Module groep met alle functies, structs, en macros  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ğŸ“„ <b>Source Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="cloud_8c.html">cloud.c</a> - Implementatie  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“„ <b>Header Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="cloud__zbus_8h.html">cloud_zbus.h</a> - Public API en ZBUS definities  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Overzicht</h1>
<p>De Cloud module beheert de connectie met nRF Cloud en implementeert een state machine voor robuuste cloud connectiviteit met retry logica. De module is verantwoordelijk voor:</p>
<ul>
<li><b>nRF Cloud SDK integratie</b> - Gebruikt Nordic's nRF Cloud MQTT library</li>
<li><b>State machine</b> - Connectie beheer met states: disconnected, connecting, ready</li>
<li><b>Event handling</b> - Reageert op cloud events (connected, disconnected, FOTA events)</li>
<li><b>Retry logica</b> - Exponential backoff bij connectie failures</li>
<li><b>FOTA orchestratie</b> - FOTA event monitoring en boot confirmation</li>
<li><b>ZBUS interface</b> - Publiceert cloud en FOTA status updates</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
ZBUS Channels</h2>
<p><b>Subscribed</b>:</p><ul>
<li><span class="tt">NETWORK_CHAN</span> - Wacht op network voordat cloud connectie start</li>
<li><span class="tt">CLOUD_CHAN</span> - Voor interne cloud event processing</li>
<li><span class="tt">REBOOT_CHAN</span> - Graceful shutdown notificatie</li>
<li><span class="tt">PRIV_CLOUD_CHAN</span> - <b>Private internal channel</b> voor async callbacks â†’ state machine communicatie</li>
</ul>
<p><b>Published</b>:</p><ul>
<li><span class="tt">CLOUD_CHAN</span> - Cloud connectie status updates (CLOUD_READY / CLOUD_NOT_READY)</li>
<li><span class="tt">FOTA_CHAN</span> - FOTA event status (start, progress, done, error)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md22"></a>
Waarom? (Motivatie)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md23"></a>
Cloud Connectiviteit</h2>
<p><b>Probleem:</b> IoT devices moeten betrouwbare verbinding hebben met backend services. Netwerk instabiliteit en momentele outages zijn common.</p>
<p><b>Oplossing:</b> State machine met retry logica:</p><ul>
<li>Automatisch reconnect na netwerk loss</li>
<li>Exponential backoff: 1s â†’ 2s â†’ 4s â†’ 8s (geen stampede)</li>
<li>Boot confirmation after FOTA: garanteert rollback prevention</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md24"></a>
FOTA Orchestratie</h2>
<p><b>Wat is FOTA?</b> Firmware Over-The-Air updates - firmware upgrade via MQTT zonder USB/UART.</p>
<p><b>Design:</b> Nordic's <span class="tt">CONFIG_NRF_CLOUD_FOTA</span> library handelt automatisch af:</p><ul>
<li>Job receptie via MQTT topic</li>
<li>Firmware download via HTTPS (streaming â†’ flash)</li>
<li>Image validatie (MCUboot signature check)</li>
</ul>
<p><b>Applicatie rol:</b> Cloud module observeert FOTA events en:</p><ol type="1">
<li>Publiceert LED feedback (4Hz groen = downloading)</li>
<li>Confirmeert boot na FOTA (prevent rollback)</li>
<li>TODO: Triggert graceful reboot</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md26"></a>
Wat? (Functionaliteit)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md27"></a>
Cloud Connectie State Machine</h2>
<p>De module gebruikt een <b>hiÃ«rarchische state machine</b> (SMF) met 6 states:</p>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚     OPERATIONAL         â”‚ (parent state)</div>
<div class="line">â”‚                         â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚ WAITING_FOR_     â”‚   â”‚ (initial state)</div>
<div class="line">â”‚  â”‚ MODEM            â”‚â—„â”€â”€â”¼â”€â”€â”€ Boot</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â”‚           â”‚              â”‚</div>
<div class="line">â”‚           â”‚ modem_ready  â”‚</div>
<div class="line">â”‚           â†“              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚ DISCONNECTED     â”‚   â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â”‚           â”‚              â”‚</div>
<div class="line">â”‚           â”‚ network_readyâ”‚</div>
<div class="line">â”‚           â†“              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚ CONNECTING       â”‚   â”‚ (composite state)</div>
<div class="line">â”‚  â”‚                  â”‚   â”‚</div>
<div class="line">â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚</div>
<div class="line">â”‚  â”‚ â”‚ CONNECTING_  â”‚ â”‚   â”‚</div>
<div class="line">â”‚  â”‚ â”‚ ATTEMPT      â”‚ â”‚   â”‚ (child state)</div>
<div class="line">â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚</div>
<div class="line">â”‚  â”‚        â”‚ (5s     â”‚   â”‚</div>
<div class="line">â”‚  â”‚        â”‚  timeout)â”‚   â”‚</div>
<div class="line">â”‚  â”‚        â†“          â”‚   â”‚</div>
<div class="line">â”‚  â”‚   PRIV_CLOUD_    â”‚   â”‚</div>
<div class="line">â”‚  â”‚   READY_TIMEOUT  â”‚   â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â”‚           â”‚ retry/       â”‚</div>
<div class="line">â”‚           â”‚ backoff      â”‚</div>
<div class="line">â”‚           â†“              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚ CLOUD_READY      â”‚   â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â”‚           â”‚              â”‚</div>
<div class="line">â”‚           â”‚ disconnect   â”‚</div>
<div class="line">â”‚           â”‚ event        â”‚</div>
<div class="line">â”‚           â†“              â”‚</div>
<div class="line">â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚</div>
<div class="line">â”‚  â”‚ DISCONNECTED     â”‚   â”‚</div>
<div class="line">â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><p><b>State Descriptions:</b></p>
<ol type="1">
<li><b>OPERATIONAL</b> (parent)<ul>
<li>Top-level parent state voor alle child states</li>
<li>Initialiseert workqueue</li>
<li>Handelt network disconnect events af (transition naar DISCONNECTED)</li>
</ul>
</li>
<li><b>WAITING_FOR_MODEM</b> (initial child)<ul>
<li>Entry state na boot</li>
<li>Wacht op network module modem initialization</li>
<li>Bij <span class="tt">network_ready=true</span> â†’ DISCONNECTED</li>
</ul>
</li>
<li><b>DISCONNECTED</b><ul>
<li>Cloud niet verbonden</li>
<li>Wacht op network connectivity</li>
<li>Bij <span class="tt">network_ready=true</span> â†’ CONNECTING</li>
</ul>
</li>
<li><b>CONNECTING</b> (composite state)<ul>
<li>Entry: Reset connection attempts counter</li>
<li>Bevat child state CONNECTING_ATTEMPT</li>
<li>Exit: Cancel readiness check work</li>
</ul>
</li>
<li><b>CONNECTING_ATTEMPT</b> (child van CONNECTING)<ul>
<li>Start cloud connectie poging</li>
<li>Start 5s timeout timer (k_work_delayable)</li>
<li>Bij timeout â†’ <span class="tt">PRIV_CLOUD_READY_TIMEOUT</span> â†’ retry met backoff</li>
<li>Bij success (NRF_CLOUD_EVT_READY) â†’ CLOUD_READY</li>
</ul>
</li>
<li><b>CLOUD_READY</b><ul>
<li>MQTT verbonden met nRF Cloud</li>
<li>Perform FOTA boot confirmation</li>
<li>Publiceert <span class="tt">CLOUD_READY</span> status</li>
<li>Bij disconnect event â†’ DISCONNECTED</li>
</ul>
</li>
</ol>
<p><b>Timing:</b></p><ul>
<li>Connection attempt timeout: 5 seconds</li>
<li>Backoff sequence: 1s, 2s, 4s, 8s, 16s, 32s (capped, exponential)</li>
<li>Recovery: Automatic retry when network restored</li>
</ul>
<p><b>Private Channel (<span class="tt">PRIV_CLOUD_CHAN</span>):</b> Gebruikt voor interne communicatie tussen async callbacks en state machine:</p><ul>
<li><span class="tt">PRIV_CLOUD_READY_TIMEOUT</span> - Connectie timeout, trigger retry</li>
<li><span class="tt">PRIV_CLOUD_DISCONNECTED</span> - Disconnect event van nRF Cloud library</li>
</ul>
<p><b>Rationale:</b> nRF Cloud callbacks draaien in ISR/callback context, maar SMF transitions moeten gebeuren in thread context. Private channel zorgt voor veilige thread-safe communicatie.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md28"></a>
FOTA Event Flow</h2>
<p><b>Event Sequence (Normal Update):</b></p>
<div class="fragment"><div class="line">1. Device boot â†’ network ready â†’ cloud READY</div>
<div class="line">   â””â”€&gt; fota_boot_confirm() called</div>
<div class="line">       â””â”€&gt; Checks if last boot was FOTA image</div>
<div class="line">           â””â”€&gt; Yes: boot_write_img_confirmed() â†’ marks confirmed</div>
<div class="line">           â””â”€&gt; No: logs &quot;already confirmed&quot;</div>
<div class="line"> </div>
<div class="line">2. FOTA job available in nRF Cloud</div>
<div class="line">   â””â”€&gt; Library detects â†’ NRF_CLOUD_EVT_FOTA_START event</div>
<div class="line"> </div>
<div class="line">3. Cloud module event handler</div>
<div class="line">   â””â”€&gt; case NRF_CLOUD_EVT_FOTA_START:</div>
<div class="line">       â””â”€&gt; Publish FOTA_CHAN: { status=DOWNLOADING, progress=0 }</div>
<div class="line">           â””â”€&gt; LED module subscribes â†’ 4Hz groen blink</div>
<div class="line"> </div>
<div class="line">4. Download progress (every 10%)</div>
<div class="line">   â””â”€&gt; NRF_CLOUD_EVT_FOTA_PROGRESS</div>
<div class="line">   â””â”€&gt; (logged, no action required)</div>
<div class="line"> </div>
<div class="line">5. Download completes</div>
<div class="line">   â””â”€&gt; NRF_CLOUD_EVT_FOTA_DONE</div>
<div class="line">   â””â”€&gt; Publish FOTA_CHAN: { status=READY, progress=100 }</div>
<div class="line">   â””â”€&gt; âœ… Publish REBOOT_CHAN: { type=REBOOT_TYPE_FOTA }</div>
<div class="line">       â””â”€&gt; Reboot module handelt graceful shutdown af</div>
<div class="line"> </div>
<div class="line">6. Reboot â†’ MCUboot swap â†’ new firmware boots</div>
<div class="line">   â””â”€&gt; fota_boot_confirm() called â†’ marks confirmed</div>
</div><!-- fragment --><p><b>Error Handling:</b></p>
<div class="fragment"><div class="line">Download failure:</div>
<div class="line">  NRF_CLOUD_EVT_FOTA_ERROR</div>
<div class="line">  â””â”€&gt; Publish FOTA_CHAN: { status=ERROR, progress=0 }</div>
<div class="line">  â””â”€&gt; LED reflects error status</div>
<div class="line">  â””â”€&gt; Download can resume on next job</div>
<div class="line"> </div>
<div class="line">Boot failure (rollback):</div>
<div class="line">  New firmware crashes within 3 boot attempts</div>
<div class="line">  â””â”€&gt; MCUboot automatic rollback â†’ old firmware restored</div>
<div class="line">  â””â”€&gt; Boot counter reset</div>
<div class="line">  â””â”€&gt; Device recovery: automatic, ~90 seconds max</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md29"></a>
LED Integration</h2>
<p>FOTA publiceert status via <span class="tt">FOTA_CHAN</span> â†’ LED module observes:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Event  </th><th class="markdownTableHeadNone">LED Pattern  </th><th class="markdownTableHeadNone">Duration  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">FOTA_STATUS_DOWNLOADING</span>  </td><td class="markdownTableBodyNone">ğŸŸ¢ 4Hz green blink  </td><td class="markdownTableBodyNone">Until done/error  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">FOTA_STATUS_READY</span>  </td><td class="markdownTableBodyNone">Return to base pattern  </td><td class="markdownTableBodyNone">-  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">FOTA_STATUS_ERROR</span>  </td><td class="markdownTableBodyNone">Return to error pattern  </td><td class="markdownTableBodyNone">-  </td></tr>
</table>
<p><b>Rationale:</b> User sees device is busy (4Hz = clearly visible, non-intrusive).</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md31"></a>
How? (Implementatie)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md32"></a>
Boot Confirmation</h2>
<p><b>Function:</b> <span class="tt"><a class="el" href="cloud_8c.html#ac3e7f5cd788004a96c9e78594caf2454" title="Confirm successful boot after FOTA update.">fota_boot_confirm()</a></span> (called at <span class="tt">NRF_CLOUD_EVT_READY</span>)</p>
<div class="fragment"><div class="line">Purpose: Confirm that new firmware (after FOTA) is stable</div>
<div class="line">Mechanism: Use MCUboot API to mark image as confirmed</div>
<div class="line">Timing: Called when MQTT connects (proves connectivity works)</div>
<div class="line">Result: Prevents MCUboot rollback after 3 boot failures</div>
</div><!-- fragment --><p><b>Scenario 1 - First Boot After FOTA:</b> </p><div class="fragment"><div class="line">MCUboot detects: secondary slot has pending image</div>
<div class="line">Execute swap: copy secondary â†’ primary</div>
<div class="line">Set: boot_counter=1, image_status=test</div>
<div class="line">Boot new firmware</div>
<div class="line"> </div>
<div class="line">Application starts:</div>
<div class="line">  nrf_cloud_connect() â†’ eventually NRF_CLOUD_EVT_READY</div>
<div class="line">  fota_boot_confirm() called</div>
<div class="line">    â†’ boot_is_img_confirmed() == false (test image!)</div>
<div class="line">    â†’ boot_write_img_confirmed() called</div>
<div class="line">    â†’ boot_counter reset to 0</div>
<div class="line">    â†’ image marked CONFIRMED</div>
<div class="line">  LOG: &quot;Boot confirmed - FOTA update successful!&quot;</div>
<div class="line"> </div>
<div class="line">Next boot: &quot;Boot already confirmed (not FOTA update)&quot;</div>
</div><!-- fragment --><p><b>Scenario 2 - Boot Loop (Bug in New Firmware):</b> </p><div class="fragment"><div class="line">Boot 1: New firmware crashes before fota_boot_confirm()</div>
<div class="line">  â†’ Watchdog reboot</div>
<div class="line">Boot 2: Same crash</div>
<div class="line">  â†’ Watchdog reboot</div>
<div class="line">Boot 3: Same crash</div>
<div class="line">  â†’ Watchdog reboot</div>
<div class="line">Boot 4: MCUboot detects boot_counter &gt;= 3</div>
<div class="line">  â†’ Automatic rollback swap: restore primary from secondary</div>
<div class="line">  â†’ Reset boot counter</div>
<div class="line">  â†’ Boot old (confirmed) image</div>
<div class="line">  â†’ Old firmware starts successfully</div>
<div class="line">  â†’ fota_boot_confirm() succeeds</div>
<div class="line">  LOG: &quot;Boot already confirmed&quot;</div>
<div class="line">  â†’ Device recovers automatically (no user action needed)</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md33"></a>
FOTA Channel Publishing</h2>
<p><b>Cloud module publishes FOTA status:</b></p>
<div class="fragment"><div class="line"><span class="comment">// Case NRF_CLOUD_EVT_FOTA_START</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structfota__msg.html">fota_msg</a> <a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a> = {</div>
<div class="line">    .status = <a class="code hl_enumvalue" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16aa0ddec79ffd80fb4bc49a3d0f05225bc">FOTA_STATUS_DOWNLOADING</a>,</div>
<div class="line">    .progress = 0,</div>
<div class="line">};</div>
<div class="line">zbus_chan_pub(&amp;FOTA_CHAN, &amp;<a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a>, K_NO_WAIT);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Case NRF_CLOUD_EVT_FOTA_DONE</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structfota__msg.html">fota_msg</a> <a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a> = {</div>
<div class="line">    .status = <a class="code hl_enumvalue" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16a0cf1677b0094446d9d898d2835e14c86">FOTA_STATUS_READY</a>,</div>
<div class="line">    .progress = 100,</div>
<div class="line">};</div>
<div class="line">zbus_chan_pub(&amp;FOTA_CHAN, &amp;<a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a>, K_NO_WAIT);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Trigger graceful reboot</span></div>
<div class="line"><a class="code hl_function" href="group__reboot.html#ga87f85e14d0d9ee938e640881ee58b65c">reboot_request_publish</a>(<a class="code hl_enumvalue" href="group__reboot.html#ggac6444349816e68cc7912753237f2b1dca2f17a0e369418b1dfba24ddeb214c593">REBOOT_TYPE_FOTA</a>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Case NRF_CLOUD_EVT_FOTA_ERROR</span></div>
<div class="line"><span class="keyword">struct </span><a class="code hl_struct" href="structfota__msg.html">fota_msg</a> <a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a> = {</div>
<div class="line">    .status = <a class="code hl_enumvalue" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16acec86faf8d28d0e7cf18d31c57f0d91d">FOTA_STATUS_ERROR</a>,</div>
<div class="line">    .progress = 0,</div>
<div class="line">};</div>
<div class="line">zbus_chan_pub(&amp;FOTA_CHAN, &amp;<a class="code hl_enumeration" href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a>, K_NO_WAIT);</div>
<div class="ttc" id="afota__zbus_8h_html_a4385e49fc59115658df51c4e330e4f16"><div class="ttname"><a href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16">fota_status</a></div><div class="ttdeci">fota_status</div><div class="ttdoc">FOTA status types.</div><div class="ttdef"><b>Definition</b> <a href="fota__zbus_8h_source.html#l00013">fota_zbus.h:13</a></div></div>
<div class="ttc" id="afota__zbus_8h_html_a4385e49fc59115658df51c4e330e4f16a0cf1677b0094446d9d898d2835e14c86"><div class="ttname"><a href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16a0cf1677b0094446d9d898d2835e14c86">FOTA_STATUS_READY</a></div><div class="ttdeci">@ FOTA_STATUS_READY</div><div class="ttdoc">FOTA ready for reboot.</div><div class="ttdef"><b>Definition</b> <a href="fota__zbus_8h_source.html#l00017">fota_zbus.h:17</a></div></div>
<div class="ttc" id="afota__zbus_8h_html_a4385e49fc59115658df51c4e330e4f16aa0ddec79ffd80fb4bc49a3d0f05225bc"><div class="ttname"><a href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16aa0ddec79ffd80fb4bc49a3d0f05225bc">FOTA_STATUS_DOWNLOADING</a></div><div class="ttdeci">@ FOTA_STATUS_DOWNLOADING</div><div class="ttdoc">FOTA download in progress.</div><div class="ttdef"><b>Definition</b> <a href="fota__zbus_8h_source.html#l00015">fota_zbus.h:15</a></div></div>
<div class="ttc" id="afota__zbus_8h_html_a4385e49fc59115658df51c4e330e4f16acec86faf8d28d0e7cf18d31c57f0d91d"><div class="ttname"><a href="fota__zbus_8h.html#a4385e49fc59115658df51c4e330e4f16acec86faf8d28d0e7cf18d31c57f0d91d">FOTA_STATUS_ERROR</a></div><div class="ttdeci">@ FOTA_STATUS_ERROR</div><div class="ttdoc">FOTA error occurred.</div><div class="ttdef"><b>Definition</b> <a href="fota__zbus_8h_source.html#l00018">fota_zbus.h:18</a></div></div>
<div class="ttc" id="agroup__reboot_html_ga87f85e14d0d9ee938e640881ee58b65c"><div class="ttname"><a href="group__reboot.html#ga87f85e14d0d9ee938e640881ee58b65c">reboot_request_publish</a></div><div class="ttdeci">void reboot_request_publish(const enum reboot_type type)</div><div class="ttdoc">Publish reboot request to ZBUS.</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8c_source.html#l00063">reboot_zbus.c:63</a></div></div>
<div class="ttc" id="agroup__reboot_html_ggac6444349816e68cc7912753237f2b1dca2f17a0e369418b1dfba24ddeb214c593"><div class="ttname"><a href="group__reboot.html#ggac6444349816e68cc7912753237f2b1dca2f17a0e369418b1dfba24ddeb214c593">REBOOT_TYPE_FOTA</a></div><div class="ttdeci">@ REBOOT_TYPE_FOTA</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8h_source.html#l00063">reboot_zbus.h:63</a></div></div>
<div class="ttc" id="astructfota__msg_html"><div class="ttname"><a href="structfota__msg.html">fota_msg</a></div><div class="ttdoc">FOTA message structure.</div><div class="ttdef"><b>Definition</b> <a href="fota__zbus_8h_source.html#l00024">fota_zbus.h:24</a></div></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md35"></a>
Edge Cases</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md36"></a>
Netwerk Loss During FOTA</h2>
<p><b>Scenario:</b> WiFi/LTE disconnect mid-download.</p>
<p><b>Behavior:</b></p><ol type="1">
<li>HTTPS connection timeout detected by library</li>
<li><span class="tt">NRF_CLOUD_EVT_FOTA_ERROR</span> event sent</li>
<li>Download progress saved in flash (CONFIG_DFU_TARGET_STREAM_SAVE_PROGRESS)</li>
<li>On next FOTA job: Library resumes from last saved offset</li>
<li>Recovery: Automatic, no application intervention</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md37"></a>
Corrupte Firmware Image</h2>
<p><b>Scenario:</b> Firmware binary has corruption or invalid signature.</p>
<p><b>Stages:</b></p><ul>
<li><b>During download:</b> DFU target validates MCUboot image header<ul>
<li>Invalid header â†’ FOTA_ERROR event</li>
</ul>
</li>
<li><b>After download:</b> MCUboot validates signature at boot<ul>
<li>Invalid signature â†’ boot refused, no swap</li>
</ul>
</li>
<li><b>After swap:</b> MCUboot validates image header again<ul>
<li>Invalid â†’ automatic rollback</li>
</ul>
</li>
</ul>
<p><b>Result:</b> System remains on old firmware, new FOTA job required.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md38"></a>
Flash Capacity</h2>
<p><b>Current Layout (1MB nRF9161):</b></p><ul>
<li>MCUboot: 40KB</li>
<li>Primary slot: 476KB (current 307KB + headroom)</li>
<li>Secondary slot: 476KB</li>
<li>Settings: 32KB</li>
</ul>
<p><b>Risk:</b> Application growth &gt; 476KB will overflow.</p>
<p><b>Mitigation:</b></p><ul>
<li>CI/CD build checks (size tool validation)</li>
<li>Safety threshold: alert if &gt; 400KB</li>
<li>Future: Migrate to external flash 3-slot layout</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md39"></a>
Boot Loop Protection</h2>
<p><b>Max boot attempts:</b> 3 (CONFIG_MCUBOOT_BOOT_MAX_BOOT_COUNT)</p>
<p><b>Timeline:</b></p><ul>
<li>Boot 1: New firmware crashes before <a class="el" href="cloud_8c.html#ac3e7f5cd788004a96c9e78594caf2454" title="Confirm successful boot after FOTA update.">fota_boot_confirm()</a> â†’ watchdog reboot (60s)</li>
<li>Boot 2: Same crash â†’ watchdog reboot</li>
<li>Boot 3: Same crash â†’ watchdog reboot</li>
<li>Boot 4: MCUboot detects counter â‰¥ 3 â†’ automatic rollback</li>
<li><b>Total recovery time:</b> ~90 seconds (worst case)</li>
</ul>
<p><b>Watchdog</b>: 60 second timeout configured system-wide.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md41"></a>
Dependencies</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md42"></a>
Inbound (FOTA Requires)</h2>
<ul>
<li><b>nRF Cloud Library</b> (<span class="tt">CONFIG_NRF_CLOUD_FOTA=y</span>)<ul>
<li>Automatic with MQTT enabled</li>
<li>Handles job reception, download, validation</li>
</ul>
</li>
<li><b>MCUboot Bootloader</b> (<span class="tt">CONFIG_BOOTLOADER_MCUBOOT=y</span>)<ul>
<li>Image swap, signature verification, rollback</li>
<li>Configured in <span class="tt">sysbuild.conf</span> with ED25519 signing</li>
</ul>
</li>
<li><b>DFU Target</b> (<span class="tt">CONFIG_DFU_TARGET_STREAM=y</span>)<ul>
<li>Streaming writes to secondary slot (no full RAM buffering)</li>
<li>Resume support: <span class="tt">CONFIG_DFU_TARGET_STREAM_SAVE_PROGRESS=y</span></li>
</ul>
</li>
<li><b>Static Partition Layout</b> (<span class="tt">pm_static.yml</span>)<ul>
<li>Optimized 2-slot layout fits in 1MB flash</li>
<li>Primary/Secondary must be exactly same size</li>
</ul>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md43"></a>
Outbound (Using FOTA)</h2>
<ul>
<li><b>LED Module</b> - Subscribes FOTA_CHAN for download feedback (4Hz green blink)</li>
<li><b>Reboot Module</b> - âœ… Subscribes REBOOT_CHAN for graceful shutdown after FOTA download</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md45"></a>
Configuratie</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md46"></a>
Kconfig (prj.conf)</h2>
<div class="fragment"><div class="line"># MCUboot Bootloader</div>
<div class="line">CONFIG_BOOTLOADER_MCUBOOT=y</div>
<div class="line">CONFIG_MCUBOOT_IMG_MANAGER=y</div>
<div class="line"> </div>
<div class="line"># FOTA Download</div>
<div class="line">CONFIG_FOTA_DOWNLOAD=y</div>
<div class="line">CONFIG_FOTA_DOWNLOAD_PROGRESS_EVT=y</div>
<div class="line">CONFIG_DOWNLOAD_CLIENT_HTTP_FRAG_SIZE=2048</div>
<div class="line"> </div>
<div class="line"># DFU Target (Flash Writing)</div>
<div class="line">CONFIG_DFU_TARGET=y</div>
<div class="line">CONFIG_DFU_TARGET_MCUBOOT=y</div>
<div class="line">CONFIG_DFU_TARGET_STREAM=y</div>
<div class="line">CONFIG_DFU_TARGET_STREAM_SAVE_PROGRESS=y</div>
<div class="line"> </div>
<div class="line"># nRF Cloud FOTA Library</div>
<div class="line">CONFIG_NRF_CLOUD_FOTA=y</div>
<div class="line">CONFIG_NRF_CLOUD_FOTA_PROGRESS_PCT_INCREMENT=10</div>
<div class="line">CONFIG_NRF_CLOUD_FOTA_DOWNLOAD_FRAGMENT_SIZE=2048</div>
<div class="line">CONFIG_NRF_CLOUD_FOTA_AUTO_START_JOB=y</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md47"></a>
Sysbuild (sysbuild.conf)</h2>
<div class="fragment"><div class="line"># MCUboot Signing &amp; Boot Strategy</div>
<div class="line">SB_CONFIG_MCUBOOT_SIGNATURE_TYPE_ED25519=y</div>
<div class="line">SB_CONFIG_MCUBOOT_MODE_SWAP_USING_MOVE=y</div>
<div class="line">SB_CONFIG_MCUBOOT_BOOT_MAX_BOOT_COUNT=3</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md48"></a>
Partition Layout (pm_static.yml)</h2>
<div class="fragment"><div class="line">mcuboot:              0x0000 - 0xA000   (40 KB)</div>
<div class="line">mcuboot_primary:      0xA000 - 0x81000  (476 KB)</div>
<div class="line">mcuboot_secondary:    0x81000 - 0xF8000 (476 KB)</div>
<div class="line">settings_storage:     0xF8000 - 0x100000 (32 KB)</div>
<div class="line">Total:                1 MB (exactly)</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md50"></a>
Testing</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md51"></a>
Build Validation</h2>
<div class="fragment"><div class="line"># Check application size</div>
<div class="line">size build/application/zephyr/zephyr.elf</div>
<div class="line"> </div>
<div class="line"># Expected: text + data &lt; 476KB (487424 bytes)</div>
<div class="line"># Current: ~307KB (169KB headroom = 35% margin)</div>
<div class="line"> </div>
<div class="line"># Verify partition layout</div>
<div class="line">cat build/partitions.yml</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md52"></a>
FOTA End-to-End Test</h2>
<ol type="1">
<li>Bump firmware version</li>
<li>Build &amp; sign new image</li>
<li>Upload to nRF Cloud</li>
<li>Create FOTA job for device</li>
<li>Monitor serial console:<ul>
<li><span class="tt">FOTA download started</span> â†’ device downloading</li>
<li>LED 4Hz green</li>
<li><span class="tt">FOTA download completed</span> â†’ done</li>
</ul>
</li>
<li>Wait for graceful reboot (triggered automatically by cloud module)</li>
<li>Monitor reboot: <span class="tt">Boot confirmed - FOTA update successful!</span></li>
<li>Verify functionality: MQTT connect, data publish</li>
</ol>
<p><b>Expected duration:</b> 10-30 minutes (network dependent).</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md53"></a>
Rollback Test (Warning: Intentional Crash)</h2>
<ol type="1">
<li>Inject crash in firmware: <span class="tt">void <a class="el" href="cloud_8c.html#ac3e7f5cd788004a96c9e78594caf2454" title="Confirm successful boot after FOTA update.">fota_boot_confirm(void)</a> { k_panic(); }</span></li>
<li>Upload &amp; trigger FOTA</li>
<li>Monitor automatic rollback after 3 boot attempts (~90s)</li>
<li>Verify recovery: Device boots old firmware successfully</li>
<li>Remove crash, rebuild, redeploy</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md55"></a>
Timing &amp; Performance</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md56"></a>
Download Duration</h2>
<p><b>Typical 300KB firmware:</b></p><ul>
<li>4G LTE (1 Mbps): 5-10 minutes (overhead included)</li>
<li>2G fallback (50 Kbps): 20-30 minutes</li>
</ul>
<p><b>Flash write:</b> 1.5 seconds (streaming to secondary slot)</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md57"></a>
MCUboot Swap Duration</h2>
<p><b>Swap-using-move strategy:</b></p><ul>
<li>Read/write/erase per 512B block</li>
<li>300KB image = 600 blocks Ã— 100ms = 60-90 seconds</li>
<li>Device appears unresponsive during swap (normal!)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md58"></a>
Boot Confirmation Window</h2>
<p><b>Max rollback time:</b> 3 boot attempts Ã— 45s/attempt = 135 seconds worst case.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md60"></a>
Toekomstige Uitbreidingen</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md61"></a>
Priority 1: External Flash Support</h2>
<ul>
<li>Support 3-slot layout with golden image fallback</li>
<li>Modem FOTA (3MB binary needs external storage)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md62"></a>
Priority 2: Scheduled FOTA Windows</h2>
<ul>
<li>Limit updates to specific time windows (e.g., 02:00-04:00)</li>
<li>Defer jobs outside window (manual trigger available)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md63"></a>
Priority 3: Delta Updates</h2>
<ul>
<li>Differential FOTA to reduce download size</li>
<li>Especially useful for modem firmware updates</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md65"></a>
Zie Ook</h1>
<ul>
<li><a class="el" href="cloud_8c.html">cloud.c</a> - Implementatie details</li>
<li><a class="el" href="cloud__zbus_8h.html">cloud_zbus.h</a> - ZBUS interfaces</li>
<li><a class="el" href="fota__zbus_8h.html">fota_zbus.h</a> - FOTA message structure</li>
<li><a class="el" href="led_doc.html">LED Module</a> - Visual feedback integration</li>
<li>nRF Cloud SDK: <a href="https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/libraries/modem/nrf_cloud_fota.html">https://docs.nordicsemi.com/bundle/ncs-latest/page/nrf/libraries/modem/nrf_cloud_fota.html</a></li>
<li>MCUboot: <a href="https://docs.mcuboot.com/">https://docs.mcuboot.com/</a></li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md67"></a>
Zie Ook</h1>
<ul>
<li><a class="el" href="cloud_8c.html">cloud.c</a> - Implementatie</li>
<li><a class="el" href="cloud__zbus_8h.html">cloud_zbus.h</a> - ZBUS interfaces</li>
<li>nRF Cloud SDK documentatie </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
