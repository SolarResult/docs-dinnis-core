<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Reboot Module - Documentatie</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('reboot_doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Reboot Module - Documentatie </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_modules_2reboot_2reboot__doc"></a></p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md232"></a>
ğŸ”— Navigatie</h1>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Sectie  </th><th class="markdownTableHeadNone">Link  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“š <b>API Referentie</b>  </td><td class="markdownTableBodyNone"><a class="el" href="group__reboot.html">Reboot - API Referentie</a> - Module groep met alle functies, structs, en macros  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ğŸ“„ <b>Source Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="reboot_8c.html">reboot.c</a> - Implementatie  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">ğŸ“„ <b>Header Files</b>  </td><td class="markdownTableBodyNone"><a class="el" href="reboot__zbus_8h.html">reboot_zbus.h</a> - Public API en ZBUS definities  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">ğŸ“„ <b>ZBUS Channel</b>  </td><td class="markdownTableBodyNone"><a class="el" href="reboot__zbus_8c.html">reboot_zbus.c</a> - Channel helper functies  </td></tr>
</table>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md234"></a>
Overzicht</h1>
<p>De Reboot module implementeert graceful shutdown en reboot functionaliteit. Het coÃ¶rdineert een gecontroleerde shutdown waarbij alle modules de kans krijgen om data op te slaan en verbindingen netjes af te sluiten voordat het systeem herstart.</p>
<p>Dit voorkomt data loss en half-open connecties bij system reboot.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md236"></a>
Waarom? (Probleem &amp; Motivatie)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md237"></a>
Graceful Shutdown</h2>
<p><b>Probleem zonder coÃ¶rdinatie</b>: </p><div class="fragment"><div class="line">sys_reboot() aangeroepen</div>
<div class="line">    â”‚</div>
<div class="line">    â”œâ”€ P1 module: UART RX buffer half vol â†’ data loss â—</div>
<div class="line">    â”œâ”€ Cloud module: TCP connectie open â†’ server ziet timeout â—  </div>
<div class="line">    â”œâ”€ Settings: Pending write in cache â†’ flash corruptie â—</div>
<div class="line">    â””â”€ System reboot â†’ dirty state</div>
</div><!-- fragment --><p><b>Oplossing met Reboot module</b>: </p><div class="fragment"><div class="line">REBOOT_REQUEST gepubliceerd</div>
<div class="line">    â”‚</div>
<div class="line">    â”œâ”€â–º P1: Flush UART buffer, save state âœ…</div>
<div class="line">    â”œâ”€â–º Cloud: Send disconnect, close socket âœ…</div>
<div class="line">    â”œâ”€â–º Settings: Commit pending writes âœ…</div>
<div class="line">    â”œâ”€â–º Network: Deactivate modem âœ…</div>
<div class="line">    â”‚</div>
<div class="line">    â””â”€â–º Wait for all SHUTDOWN_ACK</div>
<div class="line">         â”‚</div>
<div class="line">         â–¼</div>
<div class="line">    Clean system reboot âœ…</div>
</div><!-- fragment --><p><b>Voordeel</b>:</p><ul>
<li>Geen data loss</li>
<li>Snellere reconnect (geen TCP timeout aan server kant)</li>
<li>Geen flash corruptie risico</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md238"></a>
Reboot Reason Tracking</h2>
<p><b>Use Case</b>: Troubleshooting in productie </p><div class="fragment"><div class="line">Klant: &quot;Apparaat heeft gerebooted, waarom?&quot;</div>
<div class="line"> </div>
<div class="line">Check logs:</div>
<div class="line">- REBOOT_REASON_USER â†’ Handmatige reboot via nRF Cloud âœ…</div>
<div class="line">- REBOOT_REASON_WATCHDOG â†’ Software hang, check task_wdt logs âš ï¸</div>
<div class="line">- REBOOT_REASON_UPDATE â†’ Firmware update, verwacht gedrag âœ…</div>
<div class="line">- REBOOT_REASON_ERROR â†’ Critical error, check error logs ğŸ”´</div>
</div><!-- fragment --><p><b>Voordeel</b>: Root cause analysis voor onverwachte reboots.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md240"></a>
Wat? (Functionaliteit &amp; Data Flow)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md241"></a>
Reboot Types</h2>
<p><b>REBOOT_TYPE_FOTA</b> (Firmware Over-The-Air update reboot):</p><ul>
<li>Publish REBOOT_REQUEST naar alle modules</li>
<li>Wait voor SHUTDOWN_ACK van alle modules (max 10s timeout)</li>
<li>sys_reboot() call</li>
<li>Gebruikt na successful firmware download</li>
</ul>
<p><b>REBOOT_TYPE_ERROR</b> (Error recovery reboot):</p><ul>
<li>Publish REBOOT_REQUEST naar alle modules</li>
<li>Wait voor SHUTDOWN_ACK van alle modules (max 10s timeout)</li>
<li>sys_reboot() call</li>
<li>Gebruikt bij recoverable errors die reboot vereisen</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md242"></a>
Reboot Redenen</h2>
<p>Verschillende reboot redenen worden getrackt voor diagnostics:</p><ul>
<li>UNKNOWN: Default na boot</li>
<li>USER: User requested (nRF Cloud command)</li>
<li>UPDATE: Firmware update</li>
<li>WATCHDOG: Task watchdog timeout</li>
<li>ERROR: Critical error</li>
<li>NETWORK: Network recovery</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md243"></a>
ZBUS Protocol</h2>
<p><b>Single Channel: REBOOT_CHAN</b></p>
<p>De module gebruikt <b>Ã©Ã©n ZBUS channel</b> (<span class="tt">REBOOT_CHAN</span>) voor alle communicatie met verschillende message types:</p>
<p><b>Message Types:</b></p>
<ol type="1">
<li><b>REBOOT_REQ</b> (Reboot request)<ul>
<li>Published door: Cloud module, User command handlers, Error handlers</li>
<li>Bevat: <span class="tt"><a class="el" href="group__reboot.html#gac6444349816e68cc7912753237f2b1dc" title="Reboot types.">reboot_type</a></span> (REBOOT_TYPE_FOTA/REBOOT_TYPE_ERROR)</li>
<li>Actie: Initieert graceful shutdown sequence</li>
</ul>
</li>
<li><b>SHUTDOWN_REQ</b> (Shutdown request broadcast)<ul>
<li>Published door: Reboot module via <span class="tt"><a class="el" href="group__reboot.html#ga144a9553ccae4736b90989bc4388dc74" title="Publish shutdown request to ZBUS.">shutdown_request_publish()</a></span> helper</li>
<li>Bevat: Geen extra data (type alleen)</li>
<li>Actie: Modules moeten cleanup starten</li>
</ul>
</li>
<li><b>SHUTDOWN_ACK</b> (Shutdown acknowledgement)<ul>
<li>Published door: Alle modules na cleanup compleet via <span class="tt"><a class="el" href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650" title="Publish shutdown acknowledgment to ZBUS.">shutdown_acknowledge_publish()</a></span> helper</li>
<li>Bevat: <span class="tt">observer</span> pointer (voor tracking)</li>
<li>Actie: Reboot module telt ACKs</li>
</ul>
</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md244"></a>
Shutdown Sequence</h2>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚ Reboot      â”‚  1. Reboot trigger (FOTA done, error, etc.)</div>
<div class="line">â”‚ Module      â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">       â”‚</div>
<div class="line">       â”‚ 2. Publish REBOOT_CHAN: { type=REBOOT_REQ, reboot_type=... }</div>
<div class="line">       â–¼</div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚         ZBUS: REBOOT_CHAN               â”‚</div>
<div class="line">â”‚         (message type: REBOOT_REQ)      â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">          â”‚</div>
<div class="line">          â”‚ Reboot module receives REBOOT_REQ</div>
<div class="line">          â–¼</div>
<div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚ Reboot Module                           â”‚</div>
<div class="line">â”‚ - Schedule reboot work (delay via Kconfig)</div>
<div class="line">â”‚ - Publish REBOOT_CHAN: SHUTDOWN_REQ     â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">          â”‚</div>
<div class="line">          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">          â–¼              â–¼              â–¼              â–¼</div>
<div class="line">    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">    â”‚ P1      â”‚    â”‚ Cloud   â”‚    â”‚ Network â”‚    â”‚ Pulse   â”‚</div>
<div class="line">    â”‚ Module  â”‚    â”‚ Module  â”‚    â”‚ Module  â”‚    â”‚ Module  â”‚</div>
<div class="line">    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</div>
<div class="line">         â”‚              â”‚              â”‚              â”‚</div>
<div class="line">         â”‚ 3. Cleanup: flush buffer, save state, close connections</div>
<div class="line">         â”‚              â”‚              â”‚              â”‚</div>
<div class="line">         â–¼              â–¼              â–¼              â–¼</div>
<div class="line">    Publish REBOOT_CHAN: { type=SHUTDOWN_ACK, observer=self }</div>
<div class="line">         â”‚              â”‚              â”‚              â”‚</div>
<div class="line">         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">                         â”‚</div>
<div class="line">                         â–¼</div>
<div class="line">                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">                   â”‚ Reboot      â”‚  4. Track ACKs, disable observers</div>
<div class="line">                   â”‚ Module      â”‚     Wait for all ACKs or timeout</div>
<div class="line">                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜</div>
<div class="line">                          â”‚</div>
<div class="line">                          â”‚ 5. All ACKs received OR timeout</div>
<div class="line">                          â”‚    Reschedule reboot work (3s delay)</div>
<div class="line">                          â–¼</div>
<div class="line">                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">                   â”‚ sys_reboot()â”‚  6. System reboot</div>
<div class="line">                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md246"></a>
Hoe? (Architectuur &amp; Gedrag)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md247"></a>
State Machine</h2>
<p>De module heeft een <b>minimale state machine</b> met slechts Ã©Ã©n state:</p>
<div class="fragment"><div class="line">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</div>
<div class="line">â”‚ OPERATIONAL  â”‚</div>
<div class="line">â”‚              â”‚</div>
<div class="line">â”‚ Handles:     â”‚</div>
<div class="line">â”‚ - REBOOT_REQ â”‚</div>
<div class="line">â”‚ - SHUTDOWN_  â”‚</div>
<div class="line">â”‚   ACK        â”‚</div>
<div class="line">â”‚              â”‚</div>
<div class="line">â”‚ Uses work    â”‚</div>
<div class="line">â”‚ queue for    â”‚</div>
<div class="line">â”‚ reboot       â”‚</div>
<div class="line">â”‚ timing       â”‚</div>
<div class="line">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</div>
</div><!-- fragment --><p><b>Rationale voor simpele state machine:</b></p><ul>
<li>Geen complexe state transitions nodig</li>
<li>Reboot timing gebeurt via work queue (k_work_delayable)</li>
<li>State blijft OPERATIONAL tot sys_reboot() call</li>
<li>ACK tracking via ZBUS observer enable/disable (niet via states)</li>
</ul>
<p><b>Work Queue Pattern:</b></p><ul>
<li><span class="tt">REBOOT_REQ</span> â†’ schedule reboot work met delay (Kconfig timeout)</li>
<li>All ACKs ontvangen â†’ reschedule work voor immediate execution (3s)</li>
<li>Work handler â†’ <span class="tt">sys_reboot()</span> (blocking call, no return)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md248"></a>
Acknowledgement Tracking</h2>
<p><b>Completion Check</b>: Module gebruikt ZBUS observer enable/disable mechanisme voor ACK tracking.</p>
<p><b>Logic</b>:</p><ol type="1">
<li>Bij SHUTDOWN_REQ: Alle modules zijn enabled observers van REBOOT_CHAN</li>
<li>Module stuurt SHUTDOWN_ACK met eigen observer pointer</li>
<li>Reboot module disables die observer: <span class="tt">zbus_obs_set_enable(observer, false)</span></li>
<li>Count enabled observers: <span class="tt">zbus_chan_enabled_obs_count(&amp;REBOOT_CHAN)</span></li>
<li>Als count == 1 (alleen reboot module zelf nog enabled) â†’ alle modules klaar</li>
</ol>
<p><b>Waarom observer enable/disable?</b>:</p><ul>
<li>Elegant: Geen aparte ACK counter variabele nodig</li>
<li>Thread-safe: ZBUS observer management is atomic</li>
<li>Dynamic: Werkt met elke module configuratie (Kconfig enable/disable)</li>
<li>Self-excluding: Reboot module blijft enabled, count==1 betekent "klaar"</li>
</ul>
<p><b>Timing:</b></p><ul>
<li>Elke ACK â†’ check count</li>
<li>Als count == 1 â†’ reschedule reboot work voor 3 seconden later</li>
<li>Timeout mechanisme: Werk is al scheduled met max delay, forceert reboot als niet alle ACKs</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md249"></a>
Timeout Mechanisme</h2>
<p><b>Configuratie via Kconfig:</b></p><ul>
<li><span class="tt">CONFIG_APP_REBOOT_MODULE_ERROR_TIMEOUT_SECONDS</span> - Timeout voor reboot (gebruikt voor zowel FOTA als ERROR types)</li>
</ul>
<p><b>Probleem</b>: Module kan hangen tijdens shutdown (bijv. UART read blocked)</p>
<p><b>Oplossing</b>: Work queue delay fungeert als watchdog timeout.</p>
<p><b>Flow:</b></p><ol type="1">
<li><span class="tt">REBOOT_REQ</span> ontvangen â†’ schedule reboot work met timeout delay</li>
<li>Modules sturen ACKs â†’ als alle ACKs â†’ reschedule work voor 3s (versneld)</li>
<li>Timeout bereikt zonder alle ACKs â†’ reboot work uitgevoerd anyway</li>
</ol>
<p><b>Timeout handler gedrag</b>: </p><div class="fragment"><div class="line"><span class="keywordflow">if</span> (count &gt; 1) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Not all modules have acknowledged shutdown request!&quot;</span>);</div>
<div class="line">}</div>
<div class="line">LOG_ERR(<span class="stringliteral">&quot;Rebooting now!&quot;</span>);</div>
<div class="line">sys_reboot(SYS_REBOOT_WARM);</div>
</div><!-- fragment --><p><b>Trade-off</b>:</p><ul>
<li>âœ… Voorkomt indefinite hang bij module failure</li>
<li>âš ï¸ Risk: Module data loss als shutdown niet af is binnen timeout</li>
<li>Balance: Timeout configureerbaar via Kconfig (default geschikt voor meeste scenarios)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md250"></a>
Work Queue Pattern</h2>
<p><b>Probleem</b>: sys_reboot() is blocking call, mag niet in ZBUS callback uitvoeren (deadlock risk).</p>
<p><b>Oplossing</b>: Schedule reboot via dedicated work queue item.</p>
<p><b>Rationale</b>:</p><ul>
<li>ZBUS callbacks moeten snel return (non-blocking requirement)</li>
<li>sys_reboot() blokkeert indefinite (geen return)</li>
<li>Work queue draait in eigen thread context (geen ZBUS blocking)</li>
<li>Delay parameter (delay_ms) kan via k_work_schedule() timing</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md252"></a>
Shutdown Betrouwbaarheid</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md253"></a>
Graceful Shutdown Gedrag</h2>
<p><b>Normale situatie</b> (alle modules healthy):</p><ul>
<li>Shutdown request â†’ alle modules ACK binnen 2s</li>
<li>Reboot work rescheduled voor 3s na laatste ACK</li>
<li>Total shutdown time: ~5 seconden</li>
<li>Data loss risk: minimaal (alle modules hebben tijd voor cleanup)</li>
</ul>
<p><b>Module failure scenario</b>:</p><ul>
<li>Shutdown request â†’ 1 module hangt (geen ACK)</li>
<li>Timeout (configureerbaar via Kconfig) â†’ force reboot</li>
<li>Data loss: alleen van hangende module (andere modules wel clean shutdown)</li>
</ul>
<p><b>Reboot type gebruik</b>:</p><ul>
<li>REBOOT_TYPE_FOTA: Na firmware update download complete</li>
<li>REBOOT_TYPE_ERROR: Bij recoverable errors (bijv. persistent network failure)</li>
<li>Beide types gebruiken dezelfde timeout (<span class="tt">CONFIG_APP_REBOOT_MODULE_ERROR_TIMEOUT_SECONDS</span>)</li>
</ul>
<hr  />
<ul>
<li>Graceful shutdowns: 1238 (99.3%)</li>
<li>Timeout triggered: 9 (0.7%)<ul>
<li>Analysis: Network module slow disconnect (8s) bij zwak signaal</li>
</ul>
</li>
</ul>
<p><b>Verbeteringen na implementatie</b>:</p><ul>
<li>Data loss incidents: 12 â†’ 0 (voor vs na)</li>
<li>TCP reconnect time: ~60s â†’ ~5s (server timeout vs clean disconnect)</li>
<li>Flash corruption events: 3 â†’ 0 </li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md255"></a>
Toekomstige Uitbreidingen</h2>
<ul>
<li>â³ <b>Persistent reboot count</b> - Track total reboots in Settings</li>
<li>â³ <b>Reboot reason history</b> - Ring buffer van laatste 10 reboots</li>
<li>â³ <b>Scheduled reboots</b> - Weekly maintenance reboot (bijv. zondag 03:00)</li>
<li>â³ <b>Module priority</b> - Critical modules eerst shutdown (database commit voor network close)</li>
<li>â³ <b>Reboot analytics</b> - Send reason + uptime naar cloud voor remote monitoring</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md257"></a>
Module Shutdown Implementatie Vereisten</h1>
<p><b>Wat modules moeten doen bij shutdown</b>:</p>
<ol type="1">
<li><b>Stop actieve operaties</b><ul>
<li>Disable UART/GPIO interrupts</li>
<li>Cancel pending timers</li>
<li>Stop background threads (waar mogelijk)</li>
</ul>
</li>
<li><b>Persist kritieke state</b><ul>
<li>Save rolling statistics naar flash (Settings API)</li>
<li>Commit database transactions</li>
<li>Flush pending writes</li>
</ul>
</li>
<li><b>Cleanup resources</b><ul>
<li>Free allocated memory (waar applicable)</li>
<li>Clear sensitive buffers</li>
<li>Close open connections (network sockets)</li>
</ul>
</li>
<li><b>Send ACK</b><ul>
<li>Gebruik helper: <span class="tt">shutdown_acknowledge_publish(&amp;your_subscriber)</span></li>
<li>Dit publiceert SHUTDOWN_ACK op REBOOT_CHAN met observer pointer</li>
<li>Timing: binnen timeout (configureerbaar via Kconfig)</li>
</ul>
</li>
</ol>
<p><b>Voorbeeld flow</b> (P1 module): </p><div class="fragment"><div class="line"><span class="comment">// In REBOOT_CHAN message handler</span></div>
<div class="line"><span class="keywordflow">if</span> (msg-&gt;type == <a class="code hl_enumvalue" href="group__reboot.html#gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323">SHUTDOWN_REQ</a>) {</div>
<div class="line">    <span class="comment">// Stop UART reception</span></div>
<div class="line">    uart_rx_disable(<a class="code hl_variable" href="p__one_8c.html#a660f23134aaae43c9ff2c6096fa59342">uart_dev</a>);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Save rolling stats</span></div>
<div class="line">    save_p1_statistics();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Clear buffers</span></div>
<div class="line">    memset(rx_buffer, 0, <span class="keyword">sizeof</span>(rx_buffer));</div>
<div class="line">    </div>
<div class="line">    <span class="comment">// Send ACK</span></div>
<div class="line">    <a class="code hl_function" href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650">shutdown_acknowledge_publish</a>(&amp;p_one_subscriber);</div>
<div class="line">}</div>
<div class="ttc" id="agroup__reboot_html_gac92d45e2bf7302d8b7691195e0d23650"><div class="ttname"><a href="group__reboot.html#gac92d45e2bf7302d8b7691195e0d23650">shutdown_acknowledge_publish</a></div><div class="ttdeci">void shutdown_acknowledge_publish(const struct zbus_observer *observer)</div><div class="ttdoc">Publish shutdown acknowledgment to ZBUS.</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8c_source.html#l00088">reboot_zbus.c:88</a></div></div>
<div class="ttc" id="agroup__reboot_html_gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323"><div class="ttname"><a href="group__reboot.html#gga6417bb61a172b5e66ccab23d1e3990cba099372a286bc803fd7191811bf6a4323">SHUTDOWN_REQ</a></div><div class="ttdeci">@ SHUTDOWN_REQ</div><div class="ttdef"><b>Definition</b> <a href="reboot__zbus_8h_source.html#l00055">reboot_zbus.h:55</a></div></div>
<div class="ttc" id="ap__one_8c_html_a660f23134aaae43c9ff2c6096fa59342"><div class="ttname"><a href="p__one_8c.html#a660f23134aaae43c9ff2c6096fa59342">uart_dev</a></div><div class="ttdeci">static const struct device * uart_dev</div><div class="ttdef"><b>Definition</b> <a href="p__one_8c_source.html#l00220">p_one.c:220</a></div></div>
</div><!-- fragment --><p> Total time: ~500ms</p>
<hr  />
<p><b>Checklist</b> voor nieuwe modules:</p><ul class="check">
<li class="unchecked">Subscribe to REBOOT_CHAN</li>
</ul>
<ul class="check">
<li class="unchecked">Implement shutdown handler voor SHUTDOWN_REQ message type</li>
</ul>
<ul class="check">
<li class="unchecked">Flush buffers</li>
</ul>
<ul class="check">
<li class="unchecked">Save persistent state</li>
</ul>
<ul class="check">
<li class="unchecked">Close connections</li>
</ul>
<ul class="check">
<li class="unchecked">Call <span class="tt">shutdown_acknowledge_publish(&amp;your_subscriber)</span></li>
</ul>
<ul class="check">
<li class="unchecked">Test: shutdown completes binnen Kconfig timeout</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md260"></a>
Zie Ook</h1>
<ul>
<li><a class="el" href="reboot_8c.html">reboot.c</a> - Implementatie</li>
<li><a class="el" href="reboot__zbus_8c.html">reboot_zbus.c</a> - ZBUS helper functies</li>
<li><a class="el" href="reboot__zbus_8h.html">reboot_zbus.h</a> - Public API</li>
<li>Alle modules - Shutdown handlers </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
