<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: &lt;!--</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_modules_2timing_2timing__doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"></div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>title: Timing Module parent: Modules </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md158"></a>
grand_parent: Design</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md159"></a>
Timing Module</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md160"></a>
Inhoudsopgave</h2>
<ul>
<li>Overzicht</li>
<li>Waarom een Timing Module?</li>
<li>Functionaliteit en Data Flow</li>
<li>Architectuur en Gedrag</li>
<li>Resultaten en Impact</li>
<li>Gerelateerde Modules</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md161"></a>
Overzicht</h2>
<p>De <span class="tt">timing</span> module is de centrale timing-coördinator van het systeem. Het publiceert periodieke, gesynchroniseerde events via ZBUS die worden gebruikt voor gecoördineerde data-acquisitie, het samenstellen van statistieken en het verzenden van data naar de cloud.</p>
<p>De module garandeert een drift-vrije timing door gebruik te maken van de periodieke modus van Zephyr's <span class="tt">k_timer</span> en voorkomt racecondities door een intelligent offset-mechanisme toe te passen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md162"></a>
Waarom een Timing Module?</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md163"></a>
Gecoördineerde Timing</h3>
<p>Zonder een centrale timing-bron kunnen individuele timers in verschillende modules gaan driften, wat leidt tot synchronisatieproblemen.</p>
<p><b>Probleem zonder centrale timing:</b> </p><div class="fragment"><div class="line">P1 module: eigen timer (30s) → drift +0.5s per uur</div>
<div class="line">Pulse module: eigen timer (30s) → drift -0.3s per uur</div>
<div class="line">Message Queue: eigen timer (10min) → drift +2s per uur</div>
<div class="line"> </div>
<div class="line">Resultaat na 24 uur:</div>
<div class="line">- P1 en Pulse zijn niet meer gesynchroniseerd (19s verschil).</div>
<div class="line">- Publishing gebeurt terwijl acquisitie nog bezig is (raceconditie).</div>
<div class="line">- De cloudverzending mist de meest recente data sample.</div>
</div><!-- fragment --><p><b>Oplossing</b>: Eén enkele, betrouwbare timing-bron publiceert events waar alle andere modules op reageren. Dit elimineert drift en zorgt ervoor dat alle acties gesynchroniseerd blijven.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md164"></a>
Het Offset Mechanisme</h3>
<p>Zelfs met een centrale timer kunnen acquisitie en publicatie met elkaar in conflict komen als ze op exact hetzelfde moment worden getriggerd.</p>
<p><b>Probleem zonder offset:</b> </p><div class="fragment"><div class="line">Timeline:</div>
<div class="line">t=600s:  ACQ_TRIGGER → P1 start UART read (duurt ~5s)</div>
<div class="line">t=600s:  PUBLISH_REQUEST → Message Queue wil data publiceren</div>
<div class="line">         ❗ P1 data is nog niet klaar! Raceconditie!</div>
</div><!-- fragment --><p><b>Oplossing</b>: Een offset toepassen op de publish-trigger.</p>
<p><b>Timeline met een offset van -15s:</b> </p><div class="fragment"><div class="line">Timeline:</div>
<div class="line">t=570s:  ACQ_TRIGGER → P1 voert laatste acquisitie uit (klaar rond t=575s)</div>
<div class="line">t=585s:  PUBLISH_REQUEST → P1 data is al 10s beschikbaar ✅</div>
<div class="line">t=600s:  ACQ_TRIGGER → Start van de nieuwe acquisitiecyclus</div>
</div><!-- fragment --><p><b>Voordeel</b>: Er is een buffer van 15 seconden tussen de laatste acquisitie en de publicatie, wat garandeert dat de data altijd compleet en consistent is.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md165"></a>
Functionaliteit en Data Flow</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md166"></a>
ZBUS Kanalen (Publicaties)</h3>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Kanaal  </th><th class="markdownTableHeadNone">Interval  </th><th class="markdownTableHeadNone">Offset  </th><th class="markdownTableHeadNone">Abonnees  </th><th class="markdownTableHeadNone">Doel  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">DATA_ACQUISITION_TRIGGER_CHAN</span>  </td><td class="markdownTableBodyNone">30s  </td><td class="markdownTableBodyNone">0s  </td><td class="markdownTableBodyNone"><span class="tt">p_one</span>  </td><td class="markdownTableBodyNone">Frequente data-acquisitie.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><span class="tt">DATA_PUBLISH_REQUEST_CHAN</span>  </td><td class="markdownTableBodyNone">600s (10min)  </td><td class="markdownTableBodyNone">-15s  </td><td class="markdownTableBodyNone"><span class="tt">p_one</span>, <span class="tt">energy_pulse</span>  </td><td class="markdownTableBodyNone">Data publiceren naar de <span class="tt">message_queue</span>.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><span class="tt">DATA_SEND_REQUEST_CHAN</span>  </td><td class="markdownTableBodyNone">1800s (30min)  </td><td class="markdownTableBodyNone">0s  </td><td class="markdownTableBodyNone"><span class="tt">message_queue</span>  </td><td class="markdownTableBodyNone">Gebufferde data naar de cloud verzenden.  </td></tr>
</table>
<p><b>Berichtstructuur</b>: Alle kanalen publiceren een <span class="tt">struct <a class="el" href="structtiming__event__msg.html" title="Timing event message structure.">timing_event_msg</a> { int64_t uptime_ms; }</span>, die de systeem-uptime bevat op het moment van publicatie.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md167"></a>
Complete Systeem Tijdlijn</h3>
<div class="fragment"><div class="line">timeline</div>
<div class="line">    title Systeem Events over Tijd</div>
<div class="line">    section Acquisitie</div>
<div class="line">        0s : ACQ_TRIGGER</div>
<div class="line">        30s : ACQ_TRIGGER</div>
<div class="line">        60s : ACQ_TRIGGER</div>
<div class="line">        ...</div>
<div class="line">        570s : ACQ_TRIGGER</div>
<div class="line">        600s : ACQ_TRIGGER</div>
<div class="line">        630s : ACQ_TRIGGER</div>
<div class="line">        ...</div>
<div class="line">    section Publicatie</div>
<div class="line">        585s : PUBLISH_REQUEST</div>
<div class="line">        1185s : PUBLISH_REQUEST</div>
<div class="line">        1785s : PUBLISH_REQUEST</div>
<div class="line">    section Verzending</div>
<div class="line">        1800s : SEND_REQUEST</div>
</div><!-- fragment --><ul>
<li><b>Acquisitie (elke 30s)</b>: De <span class="tt">p_one</span> module leest de slimme meter uit en werkt interne statistieken bij.</li>
<li><b>Publicatie (elke 10 min, 15s vóór het einde van de cyclus)</b>: De <span class="tt">p_one</span> en <span class="tt">energy_pulse</span> modules publiceren hun verzamelde data naar de <span class="tt">message_queue</span>.</li>
<li><b>Verzending (elke 30 min)</b>: De <span class="tt">message_queue</span> stuurt de gebufferde berichten (in dit geval 3 sets van 10-minuten data) naar de cloud.</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md168"></a>
Architectuur en Gedrag</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md169"></a>
Architectuur: Interrupt/Thread Scheiding</h3>
<p>De module volgt een robuust ontwerpprincipe door de afhandeling van timer-events te scheiden van de (potentieel blokkerende) ZBUS-publicaties.</p>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    A[k_timer verloopt&lt;br/&gt;(interrupt context)] --&gt; B{Submit work&lt;br/&gt;(non-blocking)};</div>
<div class="line">    B --&gt; C[Work handler&lt;br/&gt;(thread context)];</div>
<div class="line">    C --&gt; D[ZBUS publish&lt;br/&gt;(blokkeren toegestaan)];</div>
<div class="line">    D --&gt; E((Abonnees));</div>
<div class="line"> </div>
<div class="line">    style A fill:#f9f,stroke:#333,stroke-width:2px</div>
<div class="line">    style C fill:#cde4ff,stroke:#333,stroke-width:2px</div>
<div class="line">    style D fill:#ffe6cc,stroke:#333,stroke-width:2px</div>
</div><!-- fragment --><p><b>Rationale</b>: Een ZBUS-publicatie kan potentieel blokkeren als een abonnee de bus bezet houdt. Door de publicatie uit te voeren in een work queue handler (die in een thread context draait) in plaats van direct in de timer-interrupt, wordt voorkomen dat het timingsysteem wordt verstoord.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md170"></a>
Timer Configuratie</h3>
<ul>
<li><b><span class="tt">fast_acquisition_timer</span></b>: Een periodieke <span class="tt">k_timer</span> met een interval van 30 seconden. De timer herstart zichzelf automatisch.</li>
<li><b><span class="tt">slow_publish_timer</span></b>: Een periodieke <span class="tt">k_timer</span> met een interval van 10 minuten. Deze wordt gestart met een initiële vertraging die rekening houdt met de offset (<span class="tt">585s</span>), zodat de publicatie 15 seconden vóór het einde van de acquisitiecyclus plaatsvindt.</li>
<li><b><span class="tt">send_timer</span></b>: Een periodieke <span class="tt">k_timer</span> met een interval van 30 minuten.</li>
</ul>
<p><b>Drift-vrije Garantie</b>: De periodieke modus van Zephyr's <span class="tt">k_timer</span> compenseert automatisch voor de executietijd van de callback, waardoor er geen cumulatieve drift optreedt.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md171"></a>
State Machine</h3>
<p>De module heeft <b>geen state machine</b>. Het is een pure timing-generator. De state wordt bijgehouden door de modules die op de timing-events reageren.</p>
<h3 class="doxsection"><a class="anchor" id="autotoc_md172"></a>
Configuratie (Kconfig)</h3>
<p>De intervallen en offset zijn volledig configureerbaar via Kconfig:</p><ul>
<li><span class="tt">CONFIG_APP_TIMING_MODULE_FAST_INTERVAL_SECONDS</span></li>
<li><span class="tt">CONFIG_APP_TIMING_MODULE_SLOW_INTERVAL_SECONDS</span></li>
<li><span class="tt">CONFIG_APP_TIMING_MODULE_PUBLISH_OFFSET_SECONDS</span></li>
<li><span class="tt">CONFIG_APP_TIMING_MODULE_SEND_INTERVAL_SECONDS</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md173"></a>
Resultaten en Impact</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md174"></a>
Geheugen en Performance</h3>
<ul>
<li><b>RAM</b>: ~600 bytes (voor 3 <span class="tt">k_timer</span> objecten, 3 <span class="tt">k_work</span> items en de thread stack).</li>
<li><b>Flash</b>: ~2 KB.</li>
<li><b>CPU-overhead</b>: Zeer laag. De timer-callbacks duren &lt; 10 µs en de ZBUS-publicaties ~50 µs.</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md175"></a>
Timingnauwkeurigheid</h3>
<p>Metingen met een logic analyzer tonen aan:</p><ul>
<li><b>Jitter</b>: &lt; 1 ms (dankzij hardware-ondersteuning voor <span class="tt">k_timer</span>).</li>
<li><b>Drift</b>: 0 ppm (de periodieke modus compenseert perfect).</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md176"></a>
Gerelateerde Modules</h2>
<ul>
<li><b><span class="tt">p_one</span></b>: Abonneert zich op <span class="tt">DATA_ACQUISITION_TRIGGER_CHAN</span> en <span class="tt">DATA_PUBLISH_REQUEST_CHAN</span>.</li>
<li><b><span class="tt">energy_pulse</span></b>: Abonneert zich op <span class="tt">DATA_PUBLISH_REQUEST_CHAN</span>.</li>
<li><b><span class="tt">message_queue</span></b>: Abonneert zich op <span class="tt">DATA_SEND_REQUEST_CHAN</span>. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
