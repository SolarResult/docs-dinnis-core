<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Best Practices - Praktische Richtlijnen</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2home_2ruben_2Documents_2solarresult_2firmware_2dinnis-core_2guidelines_2best-practices.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Best Practices - Praktische Richtlijnen </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md374"></a></p>
<p>Dit document bevat best practices en veelvoorkomende patronen voor het Dinnis Core firmware project.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md376"></a>
Error Handling en Return Values</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md377"></a>
Error Variable Declaratie</h2>
<p><b>Declareer <span class="tt">err</span> variabele waar nodig, niet altijd bovenin:</b></p>
<div class="fragment"><div class="line"><span class="comment">/* Correct - declareer waar je het gebruikt */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> function_name(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Early validation - geen err nodig */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!device_is_ready(dev)) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Device not ready&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;  <span class="comment">/* Direct returnen */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Declareer err voor functie calls */</span></div>
<div class="line">    <span class="keywordtype">int</span> err = some_function();</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Function failed: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Meer code... */</span></div>
<div class="line">    err = another_function();</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Another function failed: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;  <span class="comment">/* Success */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Fout - onnodig bovenin declareren */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> function_name(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err;  <span class="comment">/* ❗ Te vroeg, wordt pas later gebruikt */</span></div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!device_is_ready(dev)) {</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    err = some_function();</div>
<div class="line">    <span class="comment">/* ... */</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md378"></a>
Return Patterns</h2>
<p><b>1. Direct returnen bij simpele checks:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Correct */</span></div>
<div class="line"><span class="keywordflow">if</span> (!device_is_ready(dev)) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Device not ready&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">if</span> (ptr == NULL) {</div>
<div class="line">    <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>2. Via <span class="tt">err</span> variabele bij functie calls:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Correct - gebruik err voor functie resultaten */</span></div>
<div class="line"><span class="keywordtype">int</span> err = zbus_chan_pub(&amp;CHAN, &amp;msg, K_NO_WAIT);</div>
<div class="line"><span class="keywordflow">if</span> (err) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Failed to publish: %d&quot;</span>, err);</div>
<div class="line">    <span class="keywordflow">return</span> err;  <span class="comment">/* Propageer error */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Ook goed - inline assignment en check */</span></div>
<div class="line"><span class="keywordflow">if</span> ((err = some_function()) != 0) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Failed: %d&quot;</span>, err);</div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
</div><!-- fragment --><p><b>3. Void functies - log maar return niet:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Correct voor void functies */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> callback(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err = some_operation();</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Operation failed: %d&quot;</span>, err);</div>
<div class="line">        <span class="comment">/* Eventueel cleanup, maar geen return value */</span></div>
<div class="line">        <span class="keywordflow">return</span>;  <span class="comment">/* Early exit zonder waarde */</span></div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Rest van functie */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p><b>4. Cleanup pattern met goto (voor complexe functies):</b> </p><div class="fragment"><div class="line"><span class="comment">/* Correct voor functies met cleanup */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> complex_function(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err = 0;</div>
<div class="line">    <span class="keywordtype">void</span> *buffer = NULL;</div>
<div class="line"> </div>
<div class="line">    buffer = k_malloc(SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (!buffer) {</div>
<div class="line">        err = -ENOMEM;</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    err = operation1(buffer);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Operation 1 failed: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    err = operation2(buffer);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Operation 2 failed: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">goto</span> cleanup;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">cleanup:</div>
<div class="line">    <span class="keywordflow">if</span> (buffer) {</div>
<div class="line">        k_free(buffer);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md379"></a>
Return Value Conventies</h2>
<p><b>Success:</b></p><ul>
<li><span class="tt">return 0;</span> voor success (Zephyr/POSIX conventie)</li>
</ul>
<p><b>Errors:</b></p><ul>
<li>Gebruik Zephyr errno waarden: <span class="tt">-EINVAL</span>, <span class="tt">-ENOMEM</span>, <span class="tt">-ENODEV</span>, <span class="tt">-ETIMEDOUT</span>, etc.</li>
<li>NOOIT positieve error codes gebruiken</li>
<li><span class="tt">return err;</span> om error door te geven</li>
</ul>
<p><b>Pointer Returns:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Return NULL bij error, pointer bij success */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span><a class="code hl_variable" href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a> *get_data(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (error_condition) {</div>
<div class="line">        <span class="keywordflow">return</span> NULL;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> &amp;valid_data;</div>
<div class="line">}</div>
<div class="ttc" id="amessage__queue_8c_html_afe1b4b4eb80224902d335e63ace502af"><div class="ttname"><a href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a></div><div class="ttdeci">struct p_one_msg data</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00157">message_queue.c:157</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md380"></a>
Logging Bij Errors</h2>
<p><b>Altijd loggen waar error ontstaat:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Correct */</span></div>
<div class="line"><span class="keywordtype">int</span> err = device_init();</div>
<div class="line"><span class="keywordflow">if</span> (err) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Failed to initialize device: %d&quot;</span>, err);  <span class="comment">/* Log hier */</span></div>
<div class="line">    <span class="keywordflow">return</span> err;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Fout - geen log bij error */</span></div>
<div class="line"><span class="keywordtype">int</span> err = device_init();</div>
<div class="line"><span class="keywordflow">if</span> (err) {</div>
<div class="line">    <span class="keywordflow">return</span> err;  <span class="comment">/* ❗ Caller weet niet wat er mis ging */</span></div>
<div class="line">}</div>
</div><!-- fragment --><p><b>Error levels:</b></p><ul>
<li><span class="tt">LOG_ERR()</span> - Voor echte fouten die actie vereisen</li>
<li><span class="tt">LOG_WRN()</span> - Voor herstelbare situaties of degraded mode</li>
<li><span class="tt">LOG_DBG()</span> - Voor debug informatie tijdens development</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md381"></a>
Void vs Int Return</h2>
<p><b>Gebruik <span class="tt">void</span> wanneer:</b></p><ul>
<li>Functie kan niet falen (pure computation, void callbacks)</li>
<li>Error handling intern afgehandeld wordt (callbacks die alleen loggen)</li>
</ul>
<p><b>Gebruik <span class="tt">int</span> (of specifiek type) wanneer:</b></p><ul>
<li>Functie kan falen en caller moet dit weten</li>
<li>Functie communiceert met hardware/OS</li>
<li>Functie alloceert resources</li>
<li>Caller moet beslissingen maken op basis van resultaat</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/* Void - kan niet falen */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> update_statistics(<span class="keywordtype">int</span> <a class="code hl_variable" href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a>)</div>
<div class="line">{</div>
<div class="line">    stats.count++;</div>
<div class="line">    stats.total += <a class="code hl_variable" href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Int - kan falen */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> send_message(<span class="keyword">const</span> <span class="keyword">struct</span> msg *msg)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> err = zbus_chan_pub(&amp;CHAN, msg, K_NO_WAIT);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Failed to send: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="ap__one_8c_html_a354b99b030bdfe136490f848c05d4788"><div class="ttname"><a href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a></div><div class="ttdeci">obis_fixed_point_t value</div><div class="ttdef"><b>Definition</b> <a href="p__one_8c_source.html#l00254">p_one.c:254</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md382"></a>
Assertions</h2>
<div class="fragment"><div class="line"><span class="comment">/* Build-time assertions */</span></div>
<div class="line"><a class="code hl_function" href="p__one_8c.html#a3f48fcbc19fe59b24bda25731cea5c00">BUILD_ASSERT</a>(CONFIG_X &gt; CONFIG_Y, <span class="stringliteral">&quot;X must be greater than Y&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Runtime assertions (alleen in debug builds) */</span></div>
<div class="line">__ASSERT(ptr != NULL, <span class="stringliteral">&quot;Pointer must not be NULL&quot;</span>);</div>
<div class="ttc" id="ap__one_8c_html_a3f48fcbc19fe59b24bda25731cea5c00"><div class="ttname"><a href="p__one_8c.html#a3f48fcbc19fe59b24bda25731cea5c00">BUILD_ASSERT</a></div><div class="ttdeci">BUILD_ASSERT(((8191 *(unsigned long)(1000 *1000/(DT_PROP(DT_NODELABEL(uart3), current_speed)/10)+1) *1.1)/1000)&lt;(CONFIG_APP_P_ONE_MODULE_WATCHDOG_TIMEOUT_SECONDS *1000), &quot;UART timeout must be less than watchdog timeout&quot;)</div></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md384"></a>
ZBUS Patterns</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md385"></a>
MSG_SUBSCRIBER Pattern</h2>
<p>Voor modules die op meerdere channels luisteren:</p>
<div class="fragment"><div class="line"><span class="comment">/* Register zbus msg subscriber */</span></div>
<div class="line"><a class="code hl_function" href="cloud_8c.html#ade047e15067f565b91685b93e16656da">ZBUS_MSG_SUBSCRIBER_DEFINE</a>(module_subscriber);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define the channels that the module subscribes to */</span></div>
<div class="line"><span class="preprocessor">#define CHANNEL_LIST(X) \</span></div>
<div class="line"><span class="preprocessor">    X(NETWORK_CHAN, struct network_msg) \</span></div>
<div class="line"><span class="preprocessor">    X(CLOUD_CHAN, struct cloud_msg)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Calculate the maximum message size from the list of channels */</span></div>
<div class="line"><span class="preprocessor">#define MAX_MSG_SIZE MAX_MSG_SIZE_FROM_LIST(CHANNEL_LIST)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Add the subscriber as observer to all the channels */</span></div>
<div class="line"><span class="preprocessor">#define ADD_OBSERVERS(_chan, _type) ZBUS_CHAN_ADD_OBS(_chan, module_subscriber, 0);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Expand to a call to ZBUS_CHAN_ADD_OBS for each channel */</span></div>
<div class="line"><a class="code hl_define" href="cloud_8c.html#a3b5933d01a8c2ba7a93b5e6aa71593b8">CHANNEL_LIST</a>(<a class="code hl_define" href="cloud_8c.html#a848ed8b7e0fb0c3ef37659dd114b7a48">ADD_OBSERVERS</a>)</div>
<div class="ttc" id="acloud_8c_html_a3b5933d01a8c2ba7a93b5e6aa71593b8"><div class="ttname"><a href="cloud_8c.html#a3b5933d01a8c2ba7a93b5e6aa71593b8">CHANNEL_LIST</a></div><div class="ttdeci">#define CHANNEL_LIST(X)</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00064">cloud.c:64</a></div></div>
<div class="ttc" id="acloud_8c_html_a848ed8b7e0fb0c3ef37659dd114b7a48"><div class="ttname"><a href="cloud_8c.html#a848ed8b7e0fb0c3ef37659dd114b7a48">ADD_OBSERVERS</a></div><div class="ttdeci">#define ADD_OBSERVERS(_chan, _type)</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00073">cloud.c:73</a></div></div>
<div class="ttc" id="acloud_8c_html_ade047e15067f565b91685b93e16656da"><div class="ttname"><a href="cloud_8c.html#ade047e15067f565b91685b93e16656da">ZBUS_MSG_SUBSCRIBER_DEFINE</a></div><div class="ttdeci">ZBUS_MSG_SUBSCRIBER_DEFINE(cloud_subscriber)</div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md386"></a>
LISTENER Pattern</h2>
<p>Voor modules die op eigen channel luisteren:</p>
<div class="fragment"><div class="line"><span class="comment">/* Forward declaration of callback */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> zbus_callback(<span class="keyword">const</span> <span class="keyword">struct</span> zbus_channel *chan);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Register zbus listener */</span></div>
<div class="line"><a class="code hl_function" href="app_8c.html#a741988180fb21aef6f753e5f09e4b887">ZBUS_LISTENER_DEFINE</a>(module_listener, zbus_callback);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define channel with listener as observer */</span></div>
<div class="line"><a class="code hl_function" href="app_8c.html#a19084703653c2a15bf7091510af4ea13">ZBUS_CHAN_DEFINE</a>(MODULE_CHAN, <span class="keyword">struct</span> module_msg, NULL, NULL,</div>
<div class="line">                 ZBUS_OBSERVERS(module_listener), ZBUS_MSG_INIT(0));</div>
<div class="ttc" id="aapp_8c_html_a19084703653c2a15bf7091510af4ea13"><div class="ttname"><a href="app_8c.html#a19084703653c2a15bf7091510af4ea13">ZBUS_CHAN_DEFINE</a></div><div class="ttdeci">ZBUS_CHAN_DEFINE(TRIGGER_CHAN, struct trigger_msg, NULL, NULL, ZBUS_OBSERVERS_EMPTY, ZBUS_MSG_INIT(0))</div></div>
<div class="ttc" id="aapp_8c_html_a741988180fb21aef6f753e5f09e4b887"><div class="ttname"><a href="app_8c.html#a741988180fb21aef6f753e5f09e4b887">ZBUS_LISTENER_DEFINE</a></div><div class="ttdeci">ZBUS_LISTENER_DEFINE(zbus_monitor, zbus_monitor_callback)</div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md387"></a>
Publishing Messages</h2>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> publish_status(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>module_msg msg = {0};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Fill message */</span></div>
<div class="line">    msg.field1 = value1;</div>
<div class="line">    msg.field2 = value2;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Publish with K_NO_WAIT to avoid blocking */</span></div>
<div class="line">    <span class="keywordtype">int</span> err = zbus_chan_pub(&amp;MODULE_CHAN, &amp;msg, K_NO_WAIT);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Failed to publish status: %d&quot;</span>, err);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md388"></a>
Message Processing in Thread</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> module_thread(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>module_state_object state_obj = {0};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Attach ZBUS observer to thread for priority handling (REQUIRED!) */</span></div>
<div class="line">    zbus_obs_attach_to_thread(&amp;module_subscriber);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Initialize state machine */</span></div>
<div class="line">    smf_set_initial(SMF_CTX(&amp;state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_INIT]);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="comment">/* Wait for ZBUS message */</span></div>
<div class="line">        <span class="keywordtype">int</span> err = zbus_sub_wait_msg(&amp;module_subscriber, &amp;state_obj.chan,</div>
<div class="line">                                   state_obj.msg_buf, K_FOREVER);</div>
<div class="line">        <span class="keywordflow">if</span> (err) {</div>
<div class="line">            LOG_ERR(<span class="stringliteral">&quot;zbus_sub_wait_msg failed: %d&quot;</span>, err);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Run state machine */</span></div>
<div class="line">        smf_run_state(SMF_CTX(&amp;state_obj));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="acloud_8c_html_a693d2ea076d2873522108af791cbf451"><div class="ttname"><a href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a></div><div class="ttdeci">static const struct smf_state states[]</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00172">cloud.c:172</a></div></div>
</div><!-- fragment --><p><b>Waarom <span class="tt">zbus_obs_attach_to_thread()</span> VERPLICHT is:</b></p><ul>
<li>ZBUS Highest Locker Protocol (HLP) vereist deze call</li>
<li>Zonder HLP: compile error (functie bestaat niet)</li>
<li>Met HLP: registreert thread priority voor correct priority boosting</li>
<li><b>ALTIJD toevoegen</b> na watchdog setup, voor main loop</li>
<li>Best practice zelfs als alle threads gelijke priority hebben</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md390"></a>
State Machine Patterns (SMF)</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md391"></a>
State Machine Setup</h2>
<div class="fragment"><div class="line"><span class="comment">/* Forward declarations */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_run(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_running_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_running_run(<span class="keywordtype">void</span> *o);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State enum */</span></div>
<div class="line"><span class="keyword">enum</span> module_states {</div>
<div class="line">    STATE_INIT,</div>
<div class="line">    STATE_RUNNING,</div>
<div class="line">    STATE_ERROR,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State table */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>smf_state <a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[] = {</div>
<div class="line">    [STATE_INIT] = SMF_CREATE_STATE(</div>
<div class="line">        state_init_entry,</div>
<div class="line">        state_init_run,</div>
<div class="line">        NULL,  <span class="comment">/* exit */</span></div>
<div class="line">        NULL,  <span class="comment">/* parent */</span></div>
<div class="line">        NULL   <span class="comment">/* initial transition */</span></div>
<div class="line">    ),</div>
<div class="line">    [STATE_RUNNING] = SMF_CREATE_STATE(</div>
<div class="line">        state_running_entry,</div>
<div class="line">        state_running_run,</div>
<div class="line">        NULL,</div>
<div class="line">        NULL,</div>
<div class="line">        NULL</div>
<div class="line">    ),</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State object - smf_ctx MUST be first field */</span></div>
<div class="line"><span class="keyword">struct </span>module_state_object {</div>
<div class="line">    <span class="keyword">struct </span>smf_ctx ctx;  <span class="comment">/* MUST be first */</span></div>
<div class="line">    <span class="keyword">const</span> <span class="keyword">struct </span>zbus_channel *chan;</div>
<div class="line">    uint8_t msg_buf[<a class="code hl_define" href="cloud_8c.html#a17e333794ae761cd55ec6fd6fc0f1bac">MAX_MSG_SIZE</a>];</div>
<div class="line">    <span class="comment">/* ... other state data ... */</span></div>
<div class="line">};</div>
<div class="ttc" id="acloud_8c_html_a17e333794ae761cd55ec6fd6fc0f1bac"><div class="ttname"><a href="cloud_8c.html#a17e333794ae761cd55ec6fd6fc0f1bac">MAX_MSG_SIZE</a></div><div class="ttdeci">#define MAX_MSG_SIZE</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00070">cloud.c:70</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md392"></a>
State Handler Functions</h2>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_entry(<span class="keywordtype">void</span> *o)</div>
<div class="line">{</div>
<div class="line">    ARG_UNUSED(o);</div>
<div class="line">    LOG_DBG(<span class="stringliteral">&quot;%s&quot;</span>, __func__);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Initialize resources */</span></div>
<div class="line">    <span class="comment">/* Schedule work, etc. */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_run(<span class="keywordtype">void</span> *o)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>module_state_object *state_obj = (<span class="keyword">struct </span>module_state_object *)o;</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Process message based on channel */</span></div>
<div class="line">    <span class="keywordflow">if</span> (state_obj-&gt;chan == &amp;NETWORK_CHAN) {</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span><a class="code hl_struct" href="structnetwork__msg.html">network_msg</a> *msg = <a class="code hl_define" href="group__network.html#ga3039bcfa8d98aa851c46c451ac970056">MSG_TO_NETWORK_MSG_PTR</a>(state_obj-&gt;msg_buf);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Handle network message */</span></div>
<div class="line">        <span class="keywordflow">if</span> (msg-&gt;<a class="code hl_variable" href="structnetwork__msg.html#a12c53526894a0b0352613e1498b976cf">status</a> == <a class="code hl_enumvalue" href="group__network.html#gga1d388be7b8bc84c14c1c37a93d4e4c55ad0d9cbede31a8edb50844d1c5558039e">NETWORK_CONNECTED</a>) {</div>
<div class="line">            <span class="comment">/* Transition to running state */</span></div>
<div class="line">            smf_set_state(SMF_CTX(state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_RUNNING]);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__network_html_ga3039bcfa8d98aa851c46c451ac970056"><div class="ttname"><a href="group__network.html#ga3039bcfa8d98aa851c46c451ac970056">MSG_TO_NETWORK_MSG_PTR</a></div><div class="ttdeci">#define MSG_TO_NETWORK_MSG_PTR(_msg)</div><div class="ttdef"><b>Definition</b> <a href="network__zbus_8h_source.html#l00024">network_zbus.h:24</a></div></div>
<div class="ttc" id="agroup__network_html_gga1d388be7b8bc84c14c1c37a93d4e4c55ad0d9cbede31a8edb50844d1c5558039e"><div class="ttname"><a href="group__network.html#gga1d388be7b8bc84c14c1c37a93d4e4c55ad0d9cbede31a8edb50844d1c5558039e">NETWORK_CONNECTED</a></div><div class="ttdeci">@ NETWORK_CONNECTED</div><div class="ttdef"><b>Definition</b> <a href="network__zbus_8h_source.html#l00039">network_zbus.h:39</a></div></div>
<div class="ttc" id="astructnetwork__msg_html"><div class="ttname"><a href="structnetwork__msg.html">network_msg</a></div><div class="ttdef"><b>Definition</b> <a href="network__zbus_8h_source.html#l00045">network_zbus.h:45</a></div></div>
<div class="ttc" id="astructnetwork__msg_html_a12c53526894a0b0352613e1498b976cf"><div class="ttname"><a href="structnetwork__msg.html#a12c53526894a0b0352613e1498b976cf">network_msg::status</a></div><div class="ttdeci">enum network_status status</div><div class="ttdef"><b>Definition</b> <a href="network__zbus_8h_source.html#l00050">network_zbus.h:50</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md393"></a>
State Transitions</h2>
<div class="fragment"><div class="line"><span class="comment">/* Set new state */</span></div>
<div class="line">smf_set_state(SMF_CTX(state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_RUNNING]);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Set state with custom initial state */</span></div>
<div class="line">smf_set_state(SMF_CTX(state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_PARENT_WITH_INITIAL]);</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md395"></a>
Resource Management</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md396"></a>
K_NO_WAIT voor Immediate Scheduling</h2>
<div class="fragment"><div class="line"><span class="comment">/* Correct - immediate scheduling */</span></div>
<div class="line">k_work_schedule(&amp;work, K_NO_WAIT);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Vermijd - arbitraire delay */</span></div>
<div class="line">k_work_schedule(&amp;work, K_MSEC(1));</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md397"></a>
Mutex Usage</h2>
<div class="fragment"><div class="line"><span class="comment">/* Correct - kort lock, schedule buiten lock */</span></div>
<div class="line">k_mutex_lock(&amp;mutex, K_FOREVER);</div>
<div class="line"><span class="comment">/* ... modify shared data ... */</span></div>
<div class="line">k_mutex_unlock(&amp;mutex);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Schedule work buiten mutex */</span></div>
<div class="line">k_work_schedule(&amp;work, K_NO_WAIT);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* FOUT - schedule binnen mutex kan deadlock veroorzaken */</span></div>
<div class="line">k_mutex_lock(&amp;mutex, K_FOREVER);</div>
<div class="line">k_work_schedule(&amp;work, K_NO_WAIT);  <span class="comment">/* ❗ Gevaarlijk */</span></div>
<div class="line">k_mutex_unlock(&amp;mutex);</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md398"></a>
Work Queue Handlers</h2>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> timer_work_fn(<span class="keyword">struct</span> k_work *work)</div>
<div class="line">{</div>
<div class="line">    ARG_UNUSED(work);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Process periodic work */</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Reschedule if needed */</span></div>
<div class="line">    k_work_schedule(&amp;timer_work, K_MSEC(PERIOD_MS));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Definition */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code hl_function" href="cloud_8c.html#a26d4bdb0f913821d08499ae4d88cad17">K_WORK_DELAYABLE_DEFINE</a>(timer_work, timer_work_fn);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Start in init */</span></div>
<div class="line">k_work_schedule(&amp;timer_work, K_NO_WAIT);</div>
<div class="ttc" id="acloud_8c_html_a26d4bdb0f913821d08499ae4d88cad17"><div class="ttname"><a href="cloud_8c.html#a26d4bdb0f913821d08499ae4d88cad17">K_WORK_DELAYABLE_DEFINE</a></div><div class="ttdeci">static K_WORK_DELAYABLE_DEFINE(cloud_readiness_check_work, cloud_readiness_check_work_fn)</div></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md400"></a>
Task Watchdog</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md401"></a>
Configuratie</h2>
<p><b>Global watchdog configuratie in <span class="tt">application/prj.conf</span>:</b> </p><div class="fragment"><div class="line"># Hardware Watchdog</div>
<div class="line">CONFIG_WATCHDOG=y</div>
<div class="line"> </div>
<div class="line"># Task Watchdog (software watchdog per thread)</div>
<div class="line">CONFIG_TASK_WDT=y</div>
<div class="line">CONFIG_TASK_WDT_CHANNELS=7          # Eén kanaal per module thread</div>
<div class="line">CONFIG_TASK_WDT_MIN_TIMEOUT=10000   # Minimum timeout (10 seconden)</div>
</div><!-- fragment --><p><b>⚠️ Belangrijk:</b> <span class="tt">CONFIG_TASK_WDT_CHANNELS</span> moet minimaal gelijk zijn aan het aantal modules met een eigen thread. Bij toevoegen van een nieuwe module met watchdog, verhoog dit aantal.</p>
<p><b>Huidige modules met watchdog (7):</b></p><ol type="1">
<li>app</li>
<li>cloud</li>
<li>energy_pulse</li>
<li>message_queue</li>
<li>network</li>
<li>p_one</li>
<li>reboot</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md402"></a>
Module Setup Pattern</h2>
<p><b>Elke module met een thread implementeert:</b></p>
<div class="fragment"><div class="line"><span class="comment">/* Includes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/task_wdt/task_wdt.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="task__wdt__util_8h.html">task_wdt_util.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Kconfig opties in Kconfig.&lt;module&gt; */</span></div>
<div class="line">menu <span class="stringliteral">&quot;Task Watchdog Configuration&quot;</span></div>
<div class="line"> </div>
<div class="line">config MODULE_NAME_WATCHDOG_TIMEOUT_SECONDS</div>
<div class="line">    <span class="keywordtype">int</span> <span class="stringliteral">&quot;Task watchdog timeout (seconds)&quot;</span></div>
<div class="line">    <span class="keywordflow">default</span> 660</div>
<div class="line">    help</div>
<div class="line">      Timeout voor de watchdog. Thread moet binnen deze tijd feeden.</div>
<div class="line"> </div>
<div class="line">config MODULE_NAME_MSG_PROCESSING_TIME_SECONDS</div>
<div class="line">    <span class="keywordtype">int</span> <span class="stringliteral">&quot;Message processing timeout (seconds)&quot;</span></div>
<div class="line">    <span class="keywordflow">default</span> 60</div>
<div class="line">    help</div>
<div class="line">      Maximale tijd voor verwerken van één bericht.</div>
<div class="line">      Moet kleiner zijn dan WATCHDOG_TIMEOUT_SECONDS.</div>
<div class="line"> </div>
<div class="line">endmenu</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Build assertion voor validatie */</span></div>
<div class="line"><a class="code hl_function" href="p__one_8c.html#a3f48fcbc19fe59b24bda25731cea5c00">BUILD_ASSERT</a>(CONFIG_MODULE_NAME_WATCHDOG_TIMEOUT_SECONDS &gt;</div>
<div class="line">             CONFIG_MODULE_NAME_MSG_PROCESSING_TIME_SECONDS,</div>
<div class="line">             <span class="stringliteral">&quot;Watchdog timeout must be greater than message processing time&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Callback functie */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code hl_function" href="app_8c.html#ad3667701d9e14f8b5fc4e3ee0131a27b">task_wdt_callback</a>(<span class="keywordtype">int</span> channel_id, <span class="keywordtype">void</span> *user_data)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">static</span> <span class="keywordtype">bool</span> reboot_requested = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!reboot_requested) {</div>
<div class="line">        reboot_requested = <span class="keyword">true</span>;</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Watchdog timeout occurred, Channel ID: %d, Thread: %s&quot;</span>,</div>
<div class="line">                channel_id, k_thread_name_get((k_tid_t)user_data));</div>
<div class="line">        <span class="comment">/* todo: reboot_request_publish(REBOOT_TYPE_ERROR); */</span></div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">        LOG_WRN(<span class="stringliteral">&quot;Watchdog timeout re-triggered for Channel ID: %d&quot;</span>, channel_id);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Thread implementatie */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> module_thread(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> uint32_t wdt_timeout_ms =</div>
<div class="line">            CONFIG_MODULE_NAME_WATCHDOG_TIMEOUT_SECONDS * MSEC_PER_SEC;</div>
<div class="line">    <span class="keyword">const</span> uint32_t msg_processing_ms =</div>
<div class="line">            CONFIG_MODULE_NAME_MSG_PROCESSING_TIME_SECONDS * MSEC_PER_SEC;</div>
<div class="line">    <span class="keyword">const</span> k_timeout_t zbus_wait_ms = K_MSEC(wdt_timeout_ms - msg_processing_ms);</div>
<div class="line">    <span class="keywordtype">int</span> err;</div>
<div class="line">    <span class="keywordtype">int</span> task_wdt_id;</div>
<div class="line"> </div>
<div class="line">    LOG_DBG(<span class="stringliteral">&quot;Module started - WDT: %u s, Processing: %u s, Wait: %u s&quot;</span>,</div>
<div class="line">            wdt_timeout_ms / MSEC_PER_SEC, msg_processing_ms / MSEC_PER_SEC,</div>
<div class="line">            (wdt_timeout_ms - msg_processing_ms) / MSEC_PER_SEC);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Setup watchdog */</span></div>
<div class="line">    task_wdt_id = <a class="code hl_function" href="task__wdt__util_8c.html#a3cd0fca4b68b6c6a7222cde37cf5b49f">task_wdt_util_setup</a>(wdt_timeout_ms, <a class="code hl_function" href="app_8c.html#ad3667701d9e14f8b5fc4e3ee0131a27b">task_wdt_callback</a>,</div>
<div class="line">                                      (<span class="keywordtype">void</span> *)k_current_get());</div>
<div class="line">    <span class="keywordflow">if</span> (task_wdt_id &lt; 0) {</div>
<div class="line">        <span class="comment">/* todo: reboot_request_publish(REBOOT_TYPE_ERROR); */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Attach ZBUS subscriber */</span></div>
<div class="line">    zbus_obs_attach_to_thread(&amp;module_subscriber);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Main loop */</span></div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="comment">/* ALTIJD aan begin van loop: feed watchdog */</span></div>
<div class="line">        err = task_wdt_feed(task_wdt_id);</div>
<div class="line">        <span class="keywordflow">if</span> (err) {</div>
<div class="line">            LOG_ERR(<span class="stringliteral">&quot;Failed to feed task watchdog, error: %d&quot;</span>, err);</div>
<div class="line">            <span class="comment">/* todo: reboot_request_publish(REBOOT_TYPE_ERROR); */</span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Wacht op berichten - timeout &lt; watchdog timeout! */</span></div>
<div class="line">        err = zbus_sub_wait_msg(&amp;module_subscriber, &amp;chan, msg_buf, zbus_wait_ms);</div>
<div class="line">        <span class="keywordflow">if</span> (err == -ENOMSG) {</div>
<div class="line">            <span class="keywordflow">continue</span>;  <span class="comment">/* Timeout, loop terug (feed watchdog weer) */</span></div>
<div class="line">        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err) {</div>
<div class="line">            LOG_ERR(<span class="stringliteral">&quot;zbus_sub_wait_msg, error: %d&quot;</span>, err);</div>
<div class="line">            <span class="comment">/* todo: reboot_request_publish(REBOOT_TYPE_ERROR); */</span></div>
<div class="line">            <span class="keywordflow">return</span>;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Verwerk bericht */</span></div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="aapp_8c_html_ad3667701d9e14f8b5fc4e3ee0131a27b"><div class="ttname"><a href="app_8c.html#ad3667701d9e14f8b5fc4e3ee0131a27b">task_wdt_callback</a></div><div class="ttdeci">static void task_wdt_callback(int channel_id, void *user_data)</div><div class="ttdoc">Watchdog timeout callback.</div><div class="ttdef"><b>Definition</b> <a href="app_8c_source.html#l00079">app.c:79</a></div></div>
<div class="ttc" id="atask__wdt__util_8c_html_a3cd0fca4b68b6c6a7222cde37cf5b49f"><div class="ttname"><a href="task__wdt__util_8c.html#a3cd0fca4b68b6c6a7222cde37cf5b49f">task_wdt_util_setup</a></div><div class="ttdeci">int task_wdt_util_setup(uint32_t timeout_ms, task_wdt_callback_t callback, void *user_data)</div><div class="ttdoc">Sets up a task watchdog channel for the calling thread.</div><div class="ttdef"><b>Definition</b> <a href="task__wdt__util_8c_source.html#l00016">task_wdt_util.c:16</a></div></div>
<div class="ttc" id="atask__wdt__util_8h_html"><div class="ttname"><a href="task__wdt__util_8h.html">task_wdt_util.h</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md403"></a>
Timing Berekening</h2>
<p><b>De watchdog moet VOOR timeout gevoed worden:</b></p>
<div class="fragment"><div class="line">zbus_wait_timeout = watchdog_timeout - msg_processing_time</div>
</div><!-- fragment --><p><b>Rationale:</b></p><ul>
<li>Thread wordt wakker (door bericht of timeout) VOOR watchdog timeout</li>
<li>Als geen bericht: <span class="tt">-ENOMSG</span> → <span class="tt">continue</span> → feed watchdog aan begin loop</li>
<li>Als wel bericht: verwerk binnen <span class="tt">msg_processing_time</span> → loop → feed watchdog</li>
<li>Thread geeft dus altijd binnen <span class="tt">watchdog_timeout</span> teken van leven</li>
</ul>
<p><b>Voorbeeld:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Watchdog timeout: 660 seconden (11 minuten) */</span></div>
<div class="line">CONFIG_MODULE_NAME_WATCHDOG_TIMEOUT_SECONDS=660</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Max processing tijd: 60 seconden (1 minuut) */</span></div>
<div class="line">CONFIG_MODULE_NAME_MSG_PROCESSING_TIME_SECONDS=60</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Zbus wait: 660 - 60 = 600 seconden (10 minuten) */</span></div>
<div class="line"><span class="keyword">const</span> k_timeout_t zbus_wait_ms = K_MSEC(wdt_timeout_ms - msg_processing_ms);</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md404"></a>
Checklist voor Nieuwe Module</h2>
<p>Wanneer je een nieuwe module met eigen thread toevoegt:</p>
<ul class="check">
<li class="unchecked">Verhoog <span class="tt">CONFIG_TASK_WDT_CHANNELS</span> in <span class="tt">application/prj.conf</span></li>
</ul>
<ul class="check">
<li class="unchecked">Include <span class="tt">&lt;zephyr/task_wdt/task_wdt.h&gt;</span> en <span class="tt">"task_wdt_util.h"</span></li>
</ul>
<ul class="check">
<li class="unchecked">Voeg Kconfig opties toe (timeout en processing time)</li>
</ul>
<ul class="check">
<li class="unchecked">Voeg <span class="tt">BUILD_ASSERT</span> toe voor timeout validatie</li>
</ul>
<ul class="check">
<li class="unchecked">Implementeer <span class="tt"><a class="el" href="app_8c.html#ad3667701d9e14f8b5fc4e3ee0131a27b" title="Watchdog timeout callback.">task_wdt_callback()</a></span> functie</li>
</ul>
<ul class="check">
<li class="unchecked">Roep <span class="tt"><a class="el" href="task__wdt__util_8c.html#a3cd0fca4b68b6c6a7222cde37cf5b49f" title="Sets up a task watchdog channel for the calling thread.">task_wdt_util_setup()</a></span> aan bij thread start</li>
</ul>
<ul class="check">
<li class="unchecked">Roep <span class="tt">task_wdt_feed()</span> aan in main loop (elke iteratie)</li>
</ul>
<ul class="check">
<li class="unchecked">Bereken <span class="tt">zbus_wait_ms</span> correct (wdt_timeout - processing_time)</li>
</ul>
<ul class="check">
<li class="unchecked">Gebruik <span class="tt">zbus_wait_ms</span> als timeout in <span class="tt">zbus_sub_wait_msg()</span></li>
</ul>
<ul class="check">
<li class="unchecked">Test dat thread wakker wordt bij timeout (log <span class="tt">-ENOMSG</span>)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md406"></a>
Hardware Interaction</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md407"></a>
Device Readiness Checks</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> module_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Always check device readiness */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!device_is_ready(device)) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Device not ready&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Configure device */</span></div>
<div class="line">    <span class="keywordtype">int</span> err = device_configure(device);</div>
<div class="line">    <span class="keywordflow">if</span> (err) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Failed to configure device: %d&quot;</span>, err);</div>
<div class="line">        <span class="keywordflow">return</span> err;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md408"></a>
GPIO Callbacks</h2>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> gpio_callback(<span class="keyword">const</span> <span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> gpio_callback *cb, uint32_t pins)</div>
<div class="line">{</div>
<div class="line">    ARG_UNUSED(dev);</div>
<div class="line">    ARG_UNUSED(cb);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Keep ISR short - schedule work */</span></div>
<div class="line">    <span class="keywordflow">if</span> (pins &amp; BIT(PIN_NUMBER)) {</div>
<div class="line">        k_work_submit(&amp;gpio_work);</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Setup GPIO callback */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>gpio_callback gpio_cb_data;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> setup_gpio(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    gpio_init_callback(&amp;gpio_cb_data, gpio_callback, BIT(PIN_NUMBER));</div>
<div class="line">    <span class="keywordflow">return</span> gpio_add_callback(gpio_dev, &amp;gpio_cb_data);</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md409"></a>
LED Control Patterns</h2>
<div class="fragment"><div class="line"><span class="comment">/* Expliciet aan/uitzetten */</span></div>
<div class="line"><span class="keywordflow">if</span> (brightness_red &gt; 0) {</div>
<div class="line">    led_set_brightness(<a class="code hl_variable" href="led_8c.html#a16989d704b66afb755235dc52390910e">led_pwm</a>, LED_RED, brightness_red);</div>
<div class="line">} <span class="keywordflow">else</span> {</div>
<div class="line">    led_off(<a class="code hl_variable" href="led_8c.html#a16989d704b66afb755235dc52390910e">led_pwm</a>, LED_RED);  <span class="comment">/* Expliciet off */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Niet alleen op brightness=0 vertrouwen */</span></div>
<div class="ttc" id="aled_8c_html_a16989d704b66afb755235dc52390910e"><div class="ttname"><a href="led_8c.html#a16989d704b66afb755235dc52390910e">led_pwm</a></div><div class="ttdeci">static const struct device * led_pwm</div><div class="ttdef"><b>Definition</b> <a href="led_8c_source.html#l00232">led.c:232</a></div></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md411"></a>
Undefined Behavior en Portability</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md412"></a>
Evaluatievolgorde</h2>
<p><b>Schrijf NOOIT code die afhankelijk is van evaluatievolgorde of side-effects:</b></p>
<div class="fragment"><div class="line"><span class="comment">/* FOUT - undefined behavior! */</span></div>
<div class="line">printf(<span class="stringliteral">&quot;%d %d\n&quot;</span>, i++, i);           <span class="comment">/* Volgorde van evaluatie ongedefinieerd */</span></div>
<div class="line">a[i] = i++;                          <span class="comment">/* Welke waarde van i wordt gebruikt? */</span></div>
<div class="line">x = f() + g();                       <span class="comment">/* Welke functie wordt eerst aangeroepen? */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* CORRECT - split in duidelijke stappen */</span></div>
<div class="line">printf(<span class="stringliteral">&quot;%d &quot;</span>, i);</div>
<div class="line">i++;</div>
<div class="line">printf(<span class="stringliteral">&quot;%d\n&quot;</span>, i);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* CORRECT - maak volgorde expliciet */</span></div>
<div class="line"><span class="keywordtype">int</span> val1 = f();</div>
<div class="line"><span class="keywordtype">int</span> val2 = g();</div>
<div class="line">x = val1 + val2;</div>
</div><!-- fragment --><p><b>Common pitfalls:</b></p><ul>
<li>Meerdere incrementen/decrements van dezelfde variabele in één expressie</li>
<li>Side-effects in functie-argumenten waar volgorde belangrijk is</li>
<li>Modificatie en lezen van dezelfde variabele zonder sequence point</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md413"></a>
Type Aannames</h2>
<p><b>Maak geen aannames over type groottes:</b></p>
<div class="fragment"><div class="line"><span class="comment">/* FOUT - aanname over grootte */</span></div>
<div class="line"><span class="keywordtype">int</span> x = 0x12345678;  <span class="comment">/* ❗ Kan niet werken als int 16-bit is */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* CORRECT - gebruik juiste type of check */</span></div>
<div class="line">int32_t x = 0x12345678;  <span class="comment">/* Expliciet 32-bit */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* FOUT - aanname over signed/unsigned */</span></div>
<div class="line"><span class="keywordtype">char</span> c = 255;  <span class="comment">/* ❗ char kan signed of unsigned zijn! */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* CORRECT */</span></div>
<div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c = 255;  <span class="comment">/* Expliciet unsigned */</span></div>
</div><!-- fragment --><p><b>Best practices:</b></p><ul>
<li>Gebruik <span class="tt">&lt;stdint.h&gt;</span> types voor specifieke groottes: <span class="tt">uint8_t</span>, <span class="tt">int32_t</span>, etc.</li>
<li>Gebruik <span class="tt">size_t</span> voor array indices en groottes</li>
<li>Test code op verschillende platformen als mogelijk</li>
<li>Documenteer platform-specifieke aannames</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md414"></a>
Pointer Arithmetic</h2>
<div class="fragment"><div class="line"><span class="comment">/* Wees voorzichtig met pointer arithmetic */</span></div>
<div class="line"><span class="keywordtype">int</span> array[10];</div>
<div class="line"><span class="keywordtype">int</span> *p = array;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Goed - check bounds */</span></div>
<div class="line"><span class="keywordflow">if</span> (p &gt;= array &amp;&amp; p &lt; array + 10) {</div>
<div class="line">    *p = 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* FOUT - undefined als p buiten array */</span></div>
<div class="line">*(p + 100) = 0;  <span class="comment">/* ❗ Undefined behavior */</span></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md416"></a>
Common Patterns</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md417"></a>
Thread Loop met ZBUS + SMF</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> module_thread(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">struct </span>module_state_object state_obj = {0};</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Attach ZBUS observer to this thread */</span></div>
<div class="line">    zbus_obs_attach_to_thread(&amp;module_subscriber);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Initialize state machine */</span></div>
<div class="line">    smf_set_initial(SMF_CTX(&amp;state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_INIT]);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Main loop */</span></div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">        <span class="comment">/* Wait for ZBUS message */</span></div>
<div class="line">        <span class="keywordtype">int</span> err = zbus_sub_wait_msg(&amp;module_subscriber, &amp;state_obj.chan,</div>
<div class="line">                                   state_obj.msg_buf, K_FOREVER);</div>
<div class="line">        <span class="keywordflow">if</span> (err) {</div>
<div class="line">            LOG_ERR(<span class="stringliteral">&quot;zbus_sub_wait_msg failed: %d&quot;</span>, err);</div>
<div class="line">            <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Process message via state machine */</span></div>
<div class="line">        smf_run_state(SMF_CTX(&amp;state_obj));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="app_8c.html#a0357560df82a39e9c631c79d57b612b2">K_THREAD_DEFINE</a>(module_thread_id, CONFIG_MODULE_THREAD_STACK_SIZE, module_thread,</div>
<div class="line">                NULL, NULL, NULL, K_LOWEST_APPLICATION_THREAD_PRIO, 0, 0);</div>
<div class="ttc" id="aapp_8c_html_a0357560df82a39e9c631c79d57b612b2"><div class="ttname"><a href="app_8c.html#a0357560df82a39e9c631c79d57b612b2">K_THREAD_DEFINE</a></div><div class="ttdeci">K_THREAD_DEFINE(app_thread_id, CONFIG_APP_MODULE_THREAD_STACK_SIZE, app_thread, NULL, NULL, NULL, CONFIG_APP_THREAD_PRIORITY_APP, 0, 0)</div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md418"></a>
Periodic Work Pattern</h2>
<div class="fragment"><div class="line"><span class="comment">/* Forward declaration */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> periodic_work_fn(<span class="keyword">struct</span> k_work *work);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define work */</span></div>
<div class="line"><span class="keyword">static</span> <a class="code hl_function" href="cloud_8c.html#a26d4bdb0f913821d08499ae4d88cad17">K_WORK_DELAYABLE_DEFINE</a>(periodic_work, periodic_work_fn);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Work function */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> periodic_work_fn(<span class="keyword">struct</span> k_work *work)</div>
<div class="line">{</div>
<div class="line">    ARG_UNUSED(work);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Do periodic task */</span></div>
<div class="line">    process_periodic_task();</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Reschedule */</span></div>
<div class="line">    k_work_schedule(&amp;periodic_work, K_MSEC(PERIOD_MS));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Start in init */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> module_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* ... other init ... */</span></div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Start periodic work */</span></div>
<div class="line">    k_work_schedule(&amp;periodic_work, K_NO_WAIT);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md419"></a>
Callback Pattern</h2>
<div class="fragment"><div class="line"><span class="comment">/* Forward declaration */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hardware_callback(<span class="keyword">const</span> <span class="keyword">struct</span> device *dev, <span class="keywordtype">void</span> *user_data);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Setup */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> setup_callback(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> hardware_register_callback(device, hardware_callback, NULL);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Callback - keep short, schedule work */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> hardware_callback(<span class="keyword">const</span> <span class="keyword">struct</span> device *dev, <span class="keywordtype">void</span> *user_data)</div>
<div class="line">{</div>
<div class="line">    ARG_UNUSED(dev);</div>
<div class="line">    ARG_UNUSED(user_data);</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Minimal processing in ISR context */</span></div>
<div class="line">    k_work_submit(&amp;processing_work);</div>
<div class="line">}</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md421"></a>
Performance en Optimization</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md422"></a>
Memory Usage</h2>
<div class="fragment"><div class="line"><span class="comment">/* Gebruik stack voor kleine, tijdelijke buffers */</span></div>
<div class="line">uint8_t temp_buf[64];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Gebruik static voor grotere, lange-termijn buffers */</span></div>
<div class="line"><span class="keyword">static</span> uint8_t rx_buffer[1024];</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Gebruik heap alleen wanneer echt nodig */</span></div>
<div class="line"><span class="keywordtype">void</span> *large_buf = k_malloc(LARGE_SIZE);</div>
<div class="line"><span class="keywordflow">if</span> (!large_buf) {</div>
<div class="line">    LOG_ERR(<span class="stringliteral">&quot;Out of memory&quot;</span>);</div>
<div class="line">    <span class="keywordflow">return</span> -ENOMEM;</div>
<div class="line">}</div>
<div class="line"><span class="comment">/* ... use buffer ... */</span></div>
<div class="line">k_free(large_buf);</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md423"></a>
Logging Levels</h2>
<div class="fragment"><div class="line"><span class="comment">/* Production - alleen errors en belangrijke info */</span></div>
<div class="line">LOG_ERR(<span class="stringliteral">&quot;Critical error: %d&quot;</span>, err);</div>
<div class="line">LOG_INF(<span class="stringliteral">&quot;Module initialized&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Development - debug info */</span></div>
<div class="line">LOG_DBG(<span class="stringliteral">&quot;Processing message type: %d&quot;</span>, type);</div>
<div class="line">LOG_DBG(<span class="stringliteral">&quot;State transition: %d -&gt; %d&quot;</span>, old_state, new_state);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Verbose debugging - alleen tijdelijk */</span></div>
<div class="line">LOG_DBG(<span class="stringliteral">&quot;Buffer content: %02x %02x %02x&quot;</span>, buf[0], buf[1], buf[2]);</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md425"></a>
Security en Safety</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md426"></a>
Input Validation</h2>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> process_data(<span class="keyword">const</span> uint8_t *<a class="code hl_variable" href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a>, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Validate inputs */</span></div>
<div class="line">    <span class="keywordflow">if</span> (<a class="code hl_variable" href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a> == NULL) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;NULL pointer&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">if</span> (len == 0 || len &gt; MAX_SIZE) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Invalid length: %zu&quot;</span>, len);</div>
<div class="line">        <span class="keywordflow">return</span> -EINVAL;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Process validated data */</span></div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md427"></a>
Buffer Overflow Prevention</h2>
<div class="fragment"><div class="line"><span class="comment">/* Gebruik size-limited functies */</span></div>
<div class="line">strncpy(dest, src, <span class="keyword">sizeof</span>(dest) - 1);</div>
<div class="line">dest[<span class="keyword">sizeof</span>(dest) - 1] = <span class="charliteral">&#39;\0&#39;</span>;  <span class="comment">/* Ensure null termination */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Check bounds voor array access */</span></div>
<div class="line"><span class="keywordflow">if</span> (index &lt; ARRAY_SIZE(array)) {</div>
<div class="line">    <a class="code hl_variable" href="p__one_8c.html#a354b99b030bdfe136490f848c05d4788">value</a> = array[index];</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Gebruik sizeof() correct */</span></div>
<div class="line">memset(buffer, 0, <span class="keyword">sizeof</span>(buffer));  <span class="comment">/* Niet sizeof(buffer*) */</span></div>
</div><!-- fragment --><hr  />
<p><em>Laatste update: 17 oktober 2025</em> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
