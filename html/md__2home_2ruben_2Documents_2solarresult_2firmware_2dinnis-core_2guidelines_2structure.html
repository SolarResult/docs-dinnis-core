<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: Code Structure - Organisatie en Volgorde</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   &#160;<span id="projectnumber">v1.0.0-unstable</span>
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md__2home_2ruben_2Documents_2solarresult_2firmware_2dinnis-core_2guidelines_2structure.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Code Structure - Organisatie en Volgorde </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md472"></a></p>
<p>Dit document beschrijft hoe code gestructureerd en georganiseerd moet worden in het Dinnis Core firmware project.</p>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md474"></a>
Toelichting</h1>
<p>Er zijn in dit document codevoorbeelden te vinden met commentaar in de code. Als een specifiek stukje commentaar is voorzien van de tekst "DESCRIPTION" dan dient deze enkel als uitleg over de relevante code, en dient dit commentaar niet letterlijk te worden overgenomen in de uiteindelijke code die jij schrijft. Bijvoorbeeld:</p>
<div class="fragment"><div class="line"><span class="comment">/* DESCRIPTION Includes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
</div><!-- fragment --><p>Hier dient <span class="tt">/* Includes */</span> niet overgenomen te worden, omdat er <span class="tt">DESCRIPTION</span> bij staat.</p>
<p>Andere commentaren dienen juist wel overgenomen te worden.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md475"></a>
Include Guards en Headers</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md476"></a>
Header Files (.h)</h2>
<p><b>Altijd include guards gebruiken:</b></p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2025 SolarResult B.V.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef MODULE_NAME_H_</span></div>
<div class="line"><span class="preprocessor">#define MODULE_NAME_H_</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* DESCRIPTION Includes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/kernel.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* DESCRIPTION Declarations */</span></div>
<div class="line"><span class="comment">/* ... */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MODULE_NAME_H_ */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><p><b>Naming conventie:</b></p><ul>
<li><b>Include guard moet exact de bestandsnaam matchen</b></li>
<li>Voor <span class="tt">module_name.h</span> → gebruik <span class="tt">MODULE_NAME_H_</span></li>
<li>Voor <span class="tt">module_name_zbus.h</span> → gebruik <span class="tt">MODULE_NAME_ZBUS_H_</span></li>
<li>Altijd <span class="tt">_H_</span> suffix</li>
<li>Altijd UPPERCASE</li>
</ul>
<p><b>Bestandsnaam conventie:</b></p><ul>
<li><span class="tt">*_zbus.h</span> - Voor headers die ZBUS channels en/of message structs definiëren</li>
<li><span class="tt">*.h</span> - Voor headers met andere module-specifieke types, enums, of functies (geen ZBUS)</li>
</ul>
<p><b>Voorbeelden:</b> </p><div class="fragment"><div class="line"><span class="comment">// Bestand: network_zbus.h</span></div>
<div class="line"><span class="preprocessor">#ifndef NETWORK_ZBUS_H_</span></div>
<div class="line"><span class="preprocessor">#define NETWORK_ZBUS_H_</span></div>
<div class="line"><span class="comment">// ... ZBUS channel en message definities</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* NETWORK_ZBUS_H_ */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Bestand: led.h  </span></div>
<div class="line"><span class="preprocessor">#ifndef LED_H_</span></div>
<div class="line"><span class="preprocessor">#define LED_H_</span></div>
<div class="line"><span class="comment">// ... LED status enums (geen ZBUS channel)</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* LED_H_ */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md477"></a>
Include Order (in .c files)</h2>
<p><b>Strikte volgorde voor overzicht:</b></p>
<p><b>Verplichte comment headers:</b> </p><div class="fragment"><div class="line"><span class="comment">/* Standard C library includes (indien nodig) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Zephyr RTOS includes */</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/drivers/gpio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/logging/log.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/zbus/zbus.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Nordic/external libraries (indien nodig) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;modem/nrf_modem_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;net/nrf_cloud.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Local/project includes */</span></div>
<div class="line"><span class="preprocessor">#include &quot;module_name_zbus.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="modules__common_8h.html">modules_common.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;other_module_zbus.h&quot;</span></div>
<div class="ttc" id="amodules__common_8h_html"><div class="ttname"><a href="modules__common_8h.html">modules_common.h</a></div></div>
</div><!-- fragment --><p><b>Regels:</b></p><ul>
<li><b>Altijd</b> comment headers gebruiken voor elke sectie die je hebt</li>
<li>Includes binnen elke sectie alfabetisch sorteren</li>
<li>Lege regel tussen secties</li>
<li>Standard C library sectie alleen toevoegen indien nodig</li>
<li>Nordic/external libraries sectie alleen toevoegen indien nodig</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md479"></a>
Forward Declarations</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md480"></a>
Wanneer Gebruiken</h2>
<p>Forward declarations zijn nodig voor:</p><ul>
<li>Callback functies gebruikt in struct/macro definities</li>
<li>State machine handler functies</li>
<li>Circular dependencies</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">/* Correct - forward declaration voor callback */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> zbus_callback(<span class="keyword">const</span> <span class="keyword">struct</span> zbus_channel *chan);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Listener gebruikt de callback */</span></div>
<div class="line">ZBUS_LISTENER_DEFINE(led_listener, zbus_callback);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Implementatie komt later */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> zbus_callback(<span class="keyword">const</span> <span class="keyword">struct</span> zbus_channel *chan)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* DESCRIPTION implementation */</span></div>
<div class="line">}</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md481"></a>
State Machine Forward Declarations</h2>
<div class="fragment"><div class="line"><span class="comment">/* DESCRIPTION Forward declarations - groepeer bij elkaar */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_init_run(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_running_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_running_run(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_error_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State table gebruikt deze functies */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>smf_state <a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[] = {</div>
<div class="line">    <span class="comment">/* DESCRIPTION ... */</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* DESCRIPTION Implementaties komen later in &quot;State Machine Handlers&quot; sectie */</span></div>
<div class="ttc" id="acloud_8c_html_a693d2ea076d2873522108af791cbf451"><div class="ttname"><a href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a></div><div class="ttdeci">static const struct smf_state states[]</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00172">cloud.c:172</a></div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md482"></a>
Volgorde</h2>
<ol type="1">
<li>Forward declarations eerst (indien nodig)</li>
<li>Dan macro's/structs die ze gebruiken</li>
<li>Implementaties komen in logische sectie later</li>
</ol>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md484"></a>
Sectie Headers</h1>
<p>Gebruik consistente sectie banners voor code organisatie:</p>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Section Name</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md485"></a>
Standaard Secties (in volgorde)</h2>
<p>De volgorde volgt een "top-down" principe: eerst declaraties en definities, dan resources, dan implementaties.</p>
<ol type="1">
<li><b>Constants and Definitions</b> - Alle #defines, macros, type definities</li>
<li><b>ZBUS</b> - Subscriber/listener setup, CHANNEL_LIST macro's, ADD_OBSERVERS</li>
<li><b>Module ZBUS</b> - Eigen ZBUS channel definities (ZBUS_CHAN_DEFINE)</li>
<li><b>Private ZBUS</b> - Interne channels (indien nodig)</li>
<li><b>State Machine Definition</b> - Forward declarations, enums, state table, state object struct (indien SMF gebruikt)</li>
<li><b>Module Resources</b> - Workqueues, timers, devices, semaphores, static state variables</li>
<li><b>Private Functions</b> - Interne helper functies (niet ZBUS/state handler gerelateerd)</li>
<li><b>ZBUS Functions</b> - Publish functies, ZBUS callbacks</li>
<li><b>Callbacks and Support Functions</b> - Hardware callbacks, event handlers</li>
<li><b>State Machine Handlers</b> - Entry/run/exit functies (indien SMF gebruikt)</li>
<li><b>Thread</b> - Main thread loop (indien dedicated thread)</li>
<li><b>Module Initialization</b> - Init functies + SYS_INIT</li>
</ol>
<p><b>Rationale:</b></p><ul>
<li>State machine <b>definitie</b> (structuur) vroeg, <b>implementatie</b> (handlers) laat</li>
<li>Resources gegroepeerd voor overzicht</li>
<li>Scheiding tussen declaratief (wat) en imperatief (hoe)</li>
<li>Thread en init onderaan (gebruiken alles wat eerder gedefinieerd is)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md487"></a>
File Structuur</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md488"></a>
Source File (.c) Template</h2>
<div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Module Name</span></div>
<div class="line"><span class="comment"> * Brief description of what this module does.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2025 SolarResult B.V.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Standard C library includes (indien nodig, alfabetisch) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;time.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Zephyr RTOS includes (alfabetisch) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/device.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/drivers/gpio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/logging/log.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/zbus/zbus.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Nordic/external libraries (indien nodig, alfabetisch) */</span></div>
<div class="line"><span class="preprocessor">#include &lt;modem/nrf_modem_lib.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;net/nrf_cloud.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Local/project includes (alfabetisch) */</span></div>
<div class="line"><span class="preprocessor">#include &quot;module_name_zbus.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="modules__common_8h.html">modules_common.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;other_module_zbus.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Register log module */</span></div>
<div class="line"><a class="code hl_function" href="app_8c.html#a0ab258b722731474493f07e1cbd1750d">LOG_MODULE_REGISTER</a>(module_name, CONFIG_MODULE_NAME_LOG_LEVEL);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Build assertions */</span></div>
<div class="line"><a class="code hl_function" href="p__one_8c.html#a3f48fcbc19fe59b24bda25731cea5c00">BUILD_ASSERT</a>(condition, <span class="stringliteral">&quot;Error message&quot;</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Constants and Definitions</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MODULE_BUFFER_SIZE 256</span></div>
<div class="line"><span class="preprocessor">#define MODULE_MAX_RETRIES 3</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * ZBUS</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Register zbus msg subscriber */</span></div>
<div class="line"><a class="code hl_function" href="cloud_8c.html#ade047e15067f565b91685b93e16656da">ZBUS_MSG_SUBSCRIBER_DEFINE</a>(module_subscriber);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define the channels that the module subscribes to */</span></div>
<div class="line"><span class="preprocessor">#define CHANNEL_LIST(X) \</span></div>
<div class="line"><span class="preprocessor">        X(NETWORK_CHAN, struct network_msg) \</span></div>
<div class="line"><span class="preprocessor">        X(CLOUD_CHAN, struct cloud_msg)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Calculate the maximum message size from the list of channels */</span></div>
<div class="line"><span class="preprocessor">#define MAX_MSG_SIZE MAX_MSG_SIZE_FROM_LIST(CHANNEL_LIST)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Add the subscriber as observer to all the channels */</span></div>
<div class="line"><span class="preprocessor">#define ADD_OBSERVERS(_chan, _type) ZBUS_CHAN_ADD_OBS(_chan, module_subscriber, 0);</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Expand to a call to ZBUS_CHAN_ADD_OBS for each channel */</span></div>
<div class="line"><a class="code hl_define" href="cloud_8c.html#a3b5933d01a8c2ba7a93b5e6aa71593b8">CHANNEL_LIST</a>(<a class="code hl_define" href="cloud_8c.html#a848ed8b7e0fb0c3ef37659dd114b7a48">ADD_OBSERVERS</a>)</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Module ZBUS</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define the module&#39;s own channel for publishing data */</span></div>
<div class="line"><a class="code hl_function" href="app_8c.html#a19084703653c2a15bf7091510af4ea13">ZBUS_CHAN_DEFINE</a>(MODULE_CHAN, <span class="keyword">struct</span> module_msg, NULL, NULL, </div>
<div class="line">                 ZBUS_OBSERVERS_EMPTY, ZBUS_MSG_INIT(0));</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * State Machine Definition</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Forward declarations of state handlers */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_example_entry(<span class="keywordtype">void</span> *o);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_example_run(<span class="keywordtype">void</span> *o);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Module states */</span></div>
<div class="line"><span class="keyword">enum</span> module_states {</div>
<div class="line">        STATE_EXAMPLE,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Construct state table */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>smf_state <a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[] = {</div>
<div class="line">        [STATE_EXAMPLE] = SMF_CREATE_STATE(</div>
<div class="line">                state_example_entry,</div>
<div class="line">                state_example_run,</div>
<div class="line">                NULL,  <span class="comment">/* exit */</span></div>
<div class="line">                NULL,  <span class="comment">/* parent */</span></div>
<div class="line">                NULL   <span class="comment">/* initial transition */</span></div>
<div class="line">        ),</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* State object structure */</span></div>
<div class="line"><span class="keyword">struct </span>module_state_object {</div>
<div class="line">        <span class="keyword">struct </span>smf_ctx ctx;  <span class="comment">/* MUST be first */</span></div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct </span>zbus_channel *chan;</div>
<div class="line">        uint8_t msg_buf[<a class="code hl_define" href="cloud_8c.html#a17e333794ae761cd55ec6fd6fc0f1bac">MAX_MSG_SIZE</a>];</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Module Resources</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Workqueue and timers */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> timer_work_fn(<span class="keyword">struct</span> k_work *work);</div>
<div class="line"><span class="keyword">static</span> <a class="code hl_function" href="cloud_8c.html#a26d4bdb0f913821d08499ae4d88cad17">K_WORK_DELAYABLE_DEFINE</a>(module_work, timer_work_fn);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Devices */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>device *module_device = DEVICE_DT_GET(DT_NODELABEL(device));</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Synchronization primitives */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>k_mutex module_mutex;</div>
<div class="line"><span class="keyword">static</span> <a class="code hl_function" href="network_8c.html#ac5f69bbbe9688f09884d4334a0c8d074">K_SEM_DEFINE</a>(module_sem, 0, 1);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Module state variables */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> module_ready = <span class="keyword">false</span>;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> retry_count = 0;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Private Functions</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> process_data(<span class="keyword">const</span> uint8_t *<a class="code hl_variable" href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a>, <span class="keywordtype">size_t</span> len)</div>
<div class="line">{</div>
<div class="line">        <span class="comment">/* implementation */</span></div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * ZBUS Functions</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> publish_status(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        <span class="keyword">struct </span>module_msg msg = {0};</div>
<div class="line">        </div>
<div class="line">        <span class="keywordtype">int</span> err = zbus_chan_pub(&amp;MODULE_CHAN, &amp;msg, K_NO_WAIT);</div>
<div class="line">        <span class="keywordflow">if</span> (err) {</div>
<div class="line">                LOG_ERR(<span class="stringliteral">&quot;Failed to publish status: %d&quot;</span>, err);</div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Callbacks and Support Functions</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> timer_work_fn(<span class="keyword">struct</span> k_work *work)</div>
<div class="line">{</div>
<div class="line">        ARG_UNUSED(work);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* implementation */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> gpio_callback(<span class="keyword">const</span> <span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> gpio_callback *cb, uint32_t pins)</div>
<div class="line">{</div>
<div class="line">        <span class="comment">/* implementation */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * State Machine Handlers</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_example_entry(<span class="keywordtype">void</span> *o)</div>
<div class="line">{</div>
<div class="line">        ARG_UNUSED(o);</div>
<div class="line">        LOG_DBG(<span class="stringliteral">&quot;%s&quot;</span>, __func__);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* implementation */</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> state_example_run(<span class="keywordtype">void</span> *o)</div>
<div class="line">{</div>
<div class="line">        <span class="keyword">struct </span>module_state_object *state_obj = (<span class="keyword">struct </span>module_state_object *)o;</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* implementation */</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Thread</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> module_thread(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        <span class="keyword">struct </span>module_state_object state_obj = {0};</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Attach ZBUS observer to thread */</span></div>
<div class="line">        zbus_obs_attach_to_thread(&amp;module_subscriber);</div>
<div class="line">        </div>
<div class="line">        <span class="comment">/* Initialize state machine */</span></div>
<div class="line">        smf_set_initial(SMF_CTX(&amp;state_obj), &amp;<a class="code hl_variable" href="cloud_8c.html#a693d2ea076d2873522108af791cbf451">states</a>[STATE_EXAMPLE]);</div>
<div class="line">        </div>
<div class="line">        <span class="keywordflow">while</span> (<span class="keyword">true</span>) {</div>
<div class="line">                <span class="comment">/* Wait for ZBUS message */</span></div>
<div class="line">                <span class="keywordtype">int</span> err = zbus_sub_wait_msg(&amp;module_subscriber, &amp;state_obj.chan,</div>
<div class="line">                                           state_obj.msg_buf, K_FOREVER);</div>
<div class="line">                <span class="keywordflow">if</span> (err) {</div>
<div class="line">                        LOG_ERR(<span class="stringliteral">&quot;zbus_sub_wait_msg failed: %d&quot;</span>, err);</div>
<div class="line">                        <span class="keywordflow">continue</span>;</div>
<div class="line">                }</div>
<div class="line">                </div>
<div class="line">                <span class="comment">/* Run state machine */</span></div>
<div class="line">                smf_run_state(SMF_CTX(&amp;state_obj));</div>
<div class="line">        }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="app_8c.html#a0357560df82a39e9c631c79d57b612b2">K_THREAD_DEFINE</a>(module_thread_id, CONFIG_MODULE_THREAD_STACK_SIZE, module_thread,</div>
<div class="line">                NULL, NULL, NULL, K_LOWEST_APPLICATION_THREAD_PRIO, 0, 0);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> * Module Initialization</span></div>
<div class="line"><span class="comment"> * =================================================================================</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> module_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">        <span class="keywordflow">if</span> (!device_is_ready(module_device)) {</div>
<div class="line">                LOG_ERR(<span class="stringliteral">&quot;Device not ready&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">        }</div>
<div class="line">        </div>
<div class="line">        k_mutex_init(&amp;module_mutex);</div>
<div class="line">        </div>
<div class="line">        LOG_INF(<span class="stringliteral">&quot;Module initialized&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="app_8c.html#ac59c4a1d8445ae57c02ba7c20d6dced5">SYS_INIT</a>(module_init, APPLICATION, CONFIG_MODULE_INIT_PRIORITY);</div>
<div class="ttc" id="aapp_8c_html_a0357560df82a39e9c631c79d57b612b2"><div class="ttname"><a href="app_8c.html#a0357560df82a39e9c631c79d57b612b2">K_THREAD_DEFINE</a></div><div class="ttdeci">K_THREAD_DEFINE(app_thread_id, CONFIG_APP_MODULE_THREAD_STACK_SIZE, app_thread, NULL, NULL, NULL, CONFIG_APP_THREAD_PRIORITY_APP, 0, 0)</div></div>
<div class="ttc" id="aapp_8c_html_a0ab258b722731474493f07e1cbd1750d"><div class="ttname"><a href="app_8c.html#a0ab258b722731474493f07e1cbd1750d">LOG_MODULE_REGISTER</a></div><div class="ttdeci">LOG_MODULE_REGISTER(app, CONFIG_APP_MODULE_LOG_LEVEL)</div></div>
<div class="ttc" id="aapp_8c_html_a19084703653c2a15bf7091510af4ea13"><div class="ttname"><a href="app_8c.html#a19084703653c2a15bf7091510af4ea13">ZBUS_CHAN_DEFINE</a></div><div class="ttdeci">ZBUS_CHAN_DEFINE(TRIGGER_CHAN, struct trigger_msg, NULL, NULL, ZBUS_OBSERVERS_EMPTY, ZBUS_MSG_INIT(0))</div></div>
<div class="ttc" id="aapp_8c_html_ac59c4a1d8445ae57c02ba7c20d6dced5"><div class="ttname"><a href="app_8c.html#ac59c4a1d8445ae57c02ba7c20d6dced5">SYS_INIT</a></div><div class="ttdeci">SYS_INIT(watchdog_init, POST_KERNEL, CONFIG_APPLICATION_INIT_PRIORITY)</div></div>
<div class="ttc" id="acloud_8c_html_a17e333794ae761cd55ec6fd6fc0f1bac"><div class="ttname"><a href="cloud_8c.html#a17e333794ae761cd55ec6fd6fc0f1bac">MAX_MSG_SIZE</a></div><div class="ttdeci">#define MAX_MSG_SIZE</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00070">cloud.c:70</a></div></div>
<div class="ttc" id="acloud_8c_html_a26d4bdb0f913821d08499ae4d88cad17"><div class="ttname"><a href="cloud_8c.html#a26d4bdb0f913821d08499ae4d88cad17">K_WORK_DELAYABLE_DEFINE</a></div><div class="ttdeci">static K_WORK_DELAYABLE_DEFINE(cloud_readiness_check_work, cloud_readiness_check_work_fn)</div></div>
<div class="ttc" id="acloud_8c_html_a3b5933d01a8c2ba7a93b5e6aa71593b8"><div class="ttname"><a href="cloud_8c.html#a3b5933d01a8c2ba7a93b5e6aa71593b8">CHANNEL_LIST</a></div><div class="ttdeci">#define CHANNEL_LIST(X)</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00064">cloud.c:64</a></div></div>
<div class="ttc" id="acloud_8c_html_a848ed8b7e0fb0c3ef37659dd114b7a48"><div class="ttname"><a href="cloud_8c.html#a848ed8b7e0fb0c3ef37659dd114b7a48">ADD_OBSERVERS</a></div><div class="ttdeci">#define ADD_OBSERVERS(_chan, _type)</div><div class="ttdef"><b>Definition</b> <a href="cloud_8c_source.html#l00073">cloud.c:73</a></div></div>
<div class="ttc" id="acloud_8c_html_ade047e15067f565b91685b93e16656da"><div class="ttname"><a href="cloud_8c.html#ade047e15067f565b91685b93e16656da">ZBUS_MSG_SUBSCRIBER_DEFINE</a></div><div class="ttdeci">ZBUS_MSG_SUBSCRIBER_DEFINE(cloud_subscriber)</div></div>
<div class="ttc" id="amessage__queue_8c_html_afe1b4b4eb80224902d335e63ace502af"><div class="ttname"><a href="message__queue_8c.html#afe1b4b4eb80224902d335e63ace502af">data</a></div><div class="ttdeci">struct p_one_msg data</div><div class="ttdef"><b>Definition</b> <a href="message__queue_8c_source.html#l00151">message_queue.c:151</a></div></div>
<div class="ttc" id="anetwork_8c_html_ac5f69bbbe9688f09884d4334a0c8d074"><div class="ttname"><a href="network_8c.html#ac5f69bbbe9688f09884d4334a0c8d074">K_SEM_DEFINE</a></div><div class="ttdeci">K_SEM_DEFINE(nrf_modem_initialized, 0, 1)</div></div>
<div class="ttc" id="ap__one_8c_html_a3f48fcbc19fe59b24bda25731cea5c00"><div class="ttname"><a href="p__one_8c.html#a3f48fcbc19fe59b24bda25731cea5c00">BUILD_ASSERT</a></div><div class="ttdeci">BUILD_ASSERT(((8191 *(unsigned long)(1000 *1000/(DT_PROP(DT_NODELABEL(uart3), current_speed)/10)+1) *1.1)/1000)&lt;(CONFIG_APP_P_ONE_MODULE_WATCHDOG_TIMEOUT_SECONDS *1000), &quot;UART timeout must be less than watchdog timeout&quot;)</div></div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md489"></a>
Header File (.h) Template</h2>
<p><b>Voor ZBUS headers (*_zbus.h):</b> </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2025 SolarResult B.V.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef MODULE_NAME_ZBUS_H_</span></div>
<div class="line"><span class="preprocessor">#define MODULE_NAME_ZBUS_H_</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/kernel.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;zephyr/zbus/zbus.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Channels provided by this module */</span></div>
<div class="line"><a class="code hl_function" href="group__app.html#ga22efa7ab8a139bb9deec0761182f5b41">ZBUS_CHAN_DECLARE</a>(MODULE_CHAN);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Cast a pointer to a message to a pointer to a module message */</span></div>
<div class="line"><span class="preprocessor">#define MSG_TO_MODULE_MSG_PTR(_msg) ((const struct module_msg *)(_msg))</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">struct </span>module_msg {</div>
<div class="line">    uint8_t field1;  <span class="comment">/* Description */</span></div>
<div class="line">    uint16_t field2; <span class="comment">/* Description */</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MODULE_NAME_ZBUS_H_ */</span><span class="preprocessor"></span></div>
<div class="ttc" id="agroup__app_html_ga22efa7ab8a139bb9deec0761182f5b41"><div class="ttname"><a href="group__app.html#ga22efa7ab8a139bb9deec0761182f5b41">ZBUS_CHAN_DECLARE</a></div><div class="ttdeci">ZBUS_CHAN_DECLARE(TRIGGER_CHAN)</div></div>
</div><!-- fragment --><p><b>Voor niet-ZBUS headers (*.h):</b> </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2025 SolarResult B.V.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifndef MODULE_NAME_H_</span></div>
<div class="line"><span class="preprocessor">#define MODULE_NAME_H_</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">enum</span> module_status {</div>
<div class="line">    MODULE_STATUS_IDLE = 0,</div>
<div class="line">    MODULE_STATUS_ACTIVE = 1,</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MODULE_NAME_H_ */</span><span class="preprocessor"></span></div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md491"></a>
ZBUS Conventies</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md492"></a>
Channel Naming</h2>
<ul>
<li>Format: <span class="tt">MODULE_CHAN</span> of <span class="tt">MODULE_NAME_CHAN</span></li>
<li>Uppercase met underscores</li>
<li>Voorbeelden: <span class="tt">LED_CHAN</span>, <span class="tt">NETWORK_CHAN</span>, <span class="tt">TRIGGER_CHAN</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md493"></a>
Message Structs</h2>
<ul>
<li><b>Altijd in header file</b> (<span class="tt">*.h</span>), niet in <span class="tt">.c</span> file</li>
<li>Naam: <span class="tt">struct module_msg</span></li>
<li>Documenteer elk veld</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md494"></a>
Channel Declarations vs Definitions</h2>
<p><b>In header file (<span class="tt">.h</span>):</b> </p><div class="fragment"><div class="line"><span class="comment">/* Declare channel for other modules to use */</span></div>
<div class="line"><a class="code hl_function" href="group__app.html#ga22efa7ab8a139bb9deec0761182f5b41">ZBUS_CHAN_DECLARE</a>(LED_CHAN);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define message struct */</span></div>
<div class="line"><span class="keyword">struct </span>led_msg {</div>
<div class="line">    uint8_t period_ms;</div>
<div class="line">    uint8_t brightness_red;</div>
<div class="line">};</div>
</div><!-- fragment --><p><b>In source file (<span class="tt">.c</span>):</b> </p><div class="fragment"><div class="line"><span class="comment">/* Define the actual channel */</span></div>
<div class="line"><a class="code hl_function" href="app_8c.html#a19084703653c2a15bf7091510af4ea13">ZBUS_CHAN_DEFINE</a>(LED_CHAN, <span class="keyword">struct</span> led_msg, NULL, NULL, </div>
<div class="line">                 ZBUS_OBSERVERS(led_listener), ZBUS_MSG_INIT(0));</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md496"></a>
Module Initialisatie</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md497"></a>
SYS_INIT Gebruik</h2>
<div class="fragment"><div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> module_init(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Check device readiness */</span></div>
<div class="line">    <span class="keywordflow">if</span> (!device_is_ready(some_device)) {</div>
<div class="line">        LOG_ERR(<span class="stringliteral">&quot;Device not ready&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> -ENODEV;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initialize resources */</span></div>
<div class="line">    k_mutex_init(&amp;module_mutex);</div>
<div class="line">    k_work_init_delayable(&amp;module_work, work_handler);</div>
<div class="line"> </div>
<div class="line">    LOG_INF(<span class="stringliteral">&quot;Module initialized&quot;</span>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><a class="code hl_function" href="app_8c.html#ac59c4a1d8445ae57c02ba7c20d6dced5">SYS_INIT</a>(module_init, APPLICATION, CONFIG_MODULE_INIT_PRIORITY);</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md498"></a>
Kconfig Integratie</h2>
<p>Elke module moet een Kconfig file hebben:</p>
<div class="fragment"><div class="line"> Copyright (c) 2025 SolarResult B.V.</div>
<div class="line"> </div>
<div class="line">menuconfig MODULE_NAME</div>
<div class="line">    bool &quot;Module Description&quot;</div>
<div class="line">    default y</div>
<div class="line">    select REQUIRED_DEPENDENCY</div>
<div class="line">    help</div>
<div class="line">      Enable this module and configure its behavior.</div>
<div class="line"> </div>
<div class="line">if MODULE_NAME</div>
<div class="line"> </div>
<div class="line">config MODULE_NAME_INIT_PRIORITY</div>
<div class="line">    int &quot;Module initialization priority&quot;</div>
<div class="line">    default 90</div>
<div class="line">    help</div>
<div class="line">      Initialization priority for the module.</div>
<div class="line"> </div>
<div class="line">module = MODULE_NAME</div>
<div class="line">module-str = Module Name</div>
<div class="line">source &quot;subsys/logging/Kconfig.template.log_config&quot;</div>
<div class="line"> </div>
<div class="line">endif  MODULE_NAME</div>
</div><!-- fragment --><hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md500"></a>
CMakeLists.txt voor Modules</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md501"></a>
Standaard Pattern (Altijd Compileren)</h2>
<p><b>Voor core modules die altijd gecompileerd moeten worden:</b></p>
<div class="fragment"><div class="line"># Copyright (c) 2025 SolarResult B.V.</div>
<div class="line"> </div>
<div class="line">target_sources(app PRIVATE </div>
<div class="line">    ${CMAKE_CURRENT_SOURCE_DIR}/module_name.c</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">target_include_directories(app PRIVATE .)</div>
</div><!-- fragment --><p><b>Belangrijke punten:</b></p><ul>
<li><span class="tt">target_sources(app PRIVATE ...)</span> - Voegt bronbestanden toe aan de <span class="tt">app</span> target</li>
<li><span class="tt">${CMAKE_CURRENT_SOURCE_DIR}/</span> - Gebruik altijd volledige pad voor bronbestanden</li>
<li><span class="tt">target_include_directories(app PRIVATE .)</span> - Maakt header files beschikbaar voor andere modules</li>
<li>Geen conditionals - module wordt altijd gecompileerd</li>
</ul>
<p><b>Voorbeelden:</b> <span class="tt">led</span>, <span class="tt">p_one</span>, <span class="tt">timing</span> modules</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md502"></a>
Conditionele Compilatie Pattern</h2>
<p><b>Voor optionele modules die via Kconfig uit te schakelen zijn:</b></p>
<div class="fragment"><div class="line"># Copyright (c) 2025 SolarResult B.V.</div>
<div class="line"> </div>
<div class="line">if(CONFIG_APP_MODULE_NAME)</div>
<div class="line">    target_sources(app PRIVATE </div>
<div class="line">        ${CMAKE_CURRENT_SOURCE_DIR}/module_name.c</div>
<div class="line">    )</div>
<div class="line">    </div>
<div class="line">    target_include_directories(app PRIVATE .)</div>
<div class="line">endif()</div>
</div><!-- fragment --><p><b>Gebruik dit alleen wanneer:</b></p><ul>
<li>Module is echt optioneel (niet core functionaliteit)</li>
<li>Module kan volledig uitgeschakeld worden zonder andere modules te breken</li>
<li>Er is een <span class="tt">CONFIG_APP_MODULE_NAME</span> option in Kconfig</li>
</ul>
<p><b>Let op:</b> Als andere modules de header van deze module nodig hebben, compileer dan altijd zonder conditie!</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md503"></a>
Multiple Source Files</h2>
<p><b>Voor modules met meerdere bronbestanden:</b></p>
<div class="fragment"><div class="line"># Copyright (c) 2025 SolarResult B.V.</div>
<div class="line"> </div>
<div class="line">target_sources(app PRIVATE </div>
<div class="line">    ${CMAKE_CURRENT_SOURCE_DIR}/module_name.c</div>
<div class="line">    ${CMAKE_CURRENT_SOURCE_DIR}/module_name_parser.c</div>
<div class="line">    ${CMAKE_CURRENT_SOURCE_DIR}/module_name_util.c</div>
<div class="line">)</div>
<div class="line"> </div>
<div class="line">target_include_directories(app PRIVATE .)</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md504"></a>
Header Visibility</h2>
<p><b>De <span class="tt">target_include_directories(app PRIVATE .)</span> regel:</b></p>
<ul>
<li>Maakt de module directory beschikbaar in het include path</li>
<li>Andere modules kunnen headers includeren met: <span class="tt">#include "module_name.h"</span></li>
<li><b>Altijd toevoegen</b>, zelfs voor modules zonder public headers (consistency)</li>
<li>Gebruik <span class="tt">.</span> (huidige directory), niet <span class="tt">${CMAKE_CURRENT_SOURCE_DIR}</span></li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md505"></a>
Integration in Parent CMakeLists</h2>
<p><b>In <span class="tt">application/src/modules/CMakeLists.txt</span>:</b></p>
<div class="fragment"><div class="line"># Add module subdirectories</div>
<div class="line">add_subdirectory(app)</div>
<div class="line">add_subdirectory(led)</div>
<div class="line">add_subdirectory(timing)</div>
<div class="line">add_subdirectory(p_one)</div>
<div class="line">add_subdirectory(energy_pulse)</div>
<div class="line">add_subdirectory(message_queue)</div>
<div class="line">add_subdirectory(network)</div>
<div class="line">add_subdirectory(cloud)</div>
<div class="line">add_subdirectory(reboot)</div>
</div><!-- fragment --><p><b>Volgorde:</b></p><ul>
<li>Alfabetisch of logische dependency volgorde</li>
<li>Core modules eerst (app, timing)</li>
<li>Hardware modules (led, p_one, energy_pulse)</li>
<li>Communication modules (message_queue, network, cloud)</li>
<li>System modules laatste (reboot)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md507"></a>
Module Checklist</h1>
<p>Bij het toevoegen van een nieuwe module, doorloop deze checklist:</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md508"></a>
Bestanden Structuur</h2>
<ul class="check">
<li class="unchecked"><span class="tt">module_name.c</span> - Source file met correcte file header (copyright)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">module_name.h</span> - Header file met include guards (<span class="tt">MODULE_NAME_H_</span>)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">module_name_zbus.h</span> - ZBUS interface header (indien ZBUS gebruikt)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">module_name_doc.md</span> - Design documentatie (voor Doxygen)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">CMakeLists.txt</span> - Build configuratie</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">Kconfig.module_name</span> - Configuratie opties (optioneel, indien configureerbaar)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md509"></a>
Code Structuur</h2>
<ul class="check">
<li class="unchecked">Include guards correct in header files</li>
</ul>
<ul class="check">
<li class="unchecked">Includes in juiste volgorde (Zephyr → nRF Cloud → Project)</li>
</ul>
<ul class="check">
<li class="unchecked">Forward declarations voor state machine (indien SMF gebruikt)</li>
</ul>
<ul class="check">
<li class="unchecked">Sectie headers aanwezig (<span class="tt">/* ===== ... ===== */</span>)</li>
</ul>
<ul class="check">
<li class="unchecked">File template gevolgd (zie File Structuur sectie)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md510"></a>
ZBUS Integratie</h2>
<ul class="check">
<li class="unchecked">ZBUS channels correct gedeclareerd (in .h) en gedefinieerd (in .c)</li>
</ul>
<ul class="check">
<li class="unchecked">Message structs correct gedefinieerd</li>
</ul>
<ul class="check">
<li class="unchecked">Channel naming conventie gevolgd (<span class="tt">*_CHAN</span> suffix)</li>
</ul>
<ul class="check">
<li class="unchecked">MSG_SUBSCRIBER of LISTENER pattern correct geïmplementeerd</li>
</ul>
<ul class="check">
<li class="unchecked">CHANNEL_LIST macro gebruikt (indien meerdere channels)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md511"></a>
Module Initialisatie</h2>
<ul class="check">
<li class="unchecked"><span class="tt"><a class="el" href="app_8c.html#ac59c4a1d8445ae57c02ba7c20d6dced5">SYS_INIT()</a></span> gebruikt voor module init (indien nodig)</li>
</ul>
<ul class="check">
<li class="unchecked">Correcte priority gekozen (zie andere modules als referentie)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt"><a class="el" href="app_8c.html#a0357560df82a39e9c631c79d57b612b2">K_THREAD_DEFINE()</a></span> voor module thread (indien nodig)</li>
</ul>
<ul class="check">
<li class="unchecked">Thread stack size geconfigureerd in Kconfig</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md512"></a>
CMakeLists.txt</h2>
<ul class="check">
<li class="unchecked"><span class="tt">target_sources(app PRIVATE ${CMAKE_CURRENT_SOURCE_DIR}/module_name.c)</span> toegevoegd</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">target_include_directories(app PRIVATE .)</span> toegevoegd</li>
</ul>
<ul class="check">
<li class="unchecked">Conditie toegevoegd indien module optioneel (anders altijd compileren)</li>
</ul>
<ul class="check">
<li class="unchecked">Module toegevoegd aan parent <span class="tt">CMakeLists.txt</span> (<span class="tt">add_subdirectory(module_name)</span>)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md513"></a>
Kconfig</h2>
<ul class="check">
<li class="unchecked">Module Kconfig bestand aangemaakt (indien configureerbaar)</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">CONFIG_APP_MODULE_NAME</span> optie toegevoegd</li>
</ul>
<ul class="check">
<li class="unchecked">Thread stack size configureerbaar</li>
</ul>
<ul class="check">
<li class="unchecked">Logging configuratie toegevoegd (<span class="tt">Kconfig.template.log_config</span>)</li>
</ul>
<ul class="check">
<li class="unchecked">Module Kconfig gesourced in parent Kconfig (<span class="tt">source "src/modules/module_name/Kconfig.module_name"</span>)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md514"></a>
Task Watchdog (indien module eigen thread heeft)</h2>
<ul class="check">
<li class="unchecked"><span class="tt">CONFIG_TASK_WDT_CHANNELS</span> verhoogd in <span class="tt">application/prj.conf</span></li>
</ul>
<ul class="check">
<li class="unchecked">Watchdog timeout en processing time in Kconfig</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">BUILD_ASSERT</span> voor timeout validatie</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt"><a class="el" href="app_8c.html#ad3667701d9e14f8b5fc4e3ee0131a27b" title="Watchdog timeout callback.">task_wdt_callback()</a></span> functie geïmplementeerd</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt"><a class="el" href="task__wdt__util_8c.html#a3cd0fca4b68b6c6a7222cde37cf5b49f" title="Sets up a task watchdog channel for the calling thread.">task_wdt_util_setup()</a></span> aangeroepen bij thread start</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">task_wdt_feed()</span> aangeroepen in main loop</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">zbus_wait_ms</span> correct berekend (wdt_timeout - processing_time)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md515"></a>
Testing</h2>
<ul class="check">
<li class="unchecked">Module compileert zonder errors</li>
</ul>
<ul class="check">
<li class="unchecked">Module compileert zonder warnings</li>
</ul>
<ul class="check">
<li class="unchecked">Memory usage gecontroleerd (FLASH/RAM)</li>
</ul>
<ul class="check">
<li class="unchecked">Module init succesvol (log output gecheckt)</li>
</ul>
<ul class="check">
<li class="unchecked">ZBUS communicatie getest (indien van toepassing)</li>
</ul>
<ul class="check">
<li class="unchecked">Thread draait en feed watchdog (indien van toepassing)</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md516"></a>
Documentatie</h2>
<ul class="check">
<li class="unchecked"><span class="tt">@defgroup</span> in header: titel = <span class="tt">&lt;Module&gt; - API Referentie</span></li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">@brief</span> is één korte zin met punt</li>
</ul>
<ul class="check">
<li class="unchecked">Verwijzing naar doc: "For complete documentation, see @ref module_doc"</li>
</ul>
<ul class="check">
<li class="unchecked"><span class="tt">&lt;module&gt;_doc.md</span> aanwezig met titel: <span class="tt"># &lt;Module&gt; - Documentatie {#module_doc}</span></li>
</ul>
<ul class="check">
<li class="unchecked">Navigatietabel in <span class="tt">&lt;module&gt;_doc.md</span> met links naar API en source files</li>
</ul>
<ul class="check">
<li class="unchecked">Doxygen comments voor publieke functies</li>
</ul>
<ul class="check">
<li class="unchecked">File headers met korte beschrijving</li>
</ul>
<ul class="check">
<li class="unchecked">Inline comments waar nodig (niet overdrijven)</li>
</ul>
<hr  />
<h1 class="doxsection"><a class="anchor" id="autotoc_md518"></a>
Referentie Modules</h1>
<p>Goed gestructureerde modules om als voorbeeld te gebruiken:</p>
<ul>
<li><b>LED Module</b> (<span class="tt">modules/led/</span>) - Klein, simpel voorbeeld</li>
</ul>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
