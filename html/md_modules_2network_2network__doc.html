<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class="dark-mode">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<!-- BEGIN opengraph metadata -->
<meta property="og:title" content="SolarResult Dinnis Core API Documentation" />
<meta property="og:description" content="API documentation for SolarResult Dinnis Core - IoT firmware for smart meter gateway device built with Zephyr RTOS on Nordic nRF9161" />
<!-- END opengraph metadata -->
<!-- Favicon -->
<link rel="icon" type="image/svg+xml" href="solar_result_white.svg">
<title>SolarResult Dinnis Core: &lt;!--</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript" src="doxygen-awesome-tabs.js"></script>
<script type="text/javascript">
    // Initialize Doxygen Awesome features (dark mode only, no toggle)
    DoxygenAwesomeFragmentCopyButton.init()
    DoxygenAwesomeParagraphLink.init()
    DoxygenAwesomeInteractiveToc.init()
    DoxygenAwesomeTabs.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="solar_result_white.svg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SolarResult Dinnis Core
   </div>
   <div id="projectbrief">Dinnis Rev1.0.0 Firmware - IoT Gateway for DSMR P1 Smart Meters</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('md_modules_2network_2network__doc.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"></div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>title: Network Module parent: Modules </p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md81"></a>
grand_parent: Design</h1>
<h1 class="doxsection"><a class="anchor" id="autotoc_md82"></a>
Network Module</h1>
<h2 class="doxsection"><a class="anchor" id="autotoc_md83"></a>
Inhoudsopgave</h2>
<ul>
<li>Overzicht</li>
<li>Componenten Diagram</li>
<li>State Machine</li>
<li>ZBUS Kanalen</li>
<li>Foutafhandeling en Robuustheid</li>
<li>Initialisatie Flow</li>
<li>Afhankelijkheden</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md84"></a>
Overzicht</h2>
<p>De <span class="tt">network</span> module is verantwoordelijk voor het beheren van de cellulaire (LTE-M/NB-IoT) verbinding van het apparaat. De primaire taak is het opzetten en onderhouden van een stabiele netwerkverbinding, die essentieel is voor alle cloud-communicatie.</p>
<p>De module maakt gebruik van de <b>Zephyr Connection Manager</b> om de complexiteit van het verbinden met het netwerk te abstraheren. Het monitort de verbindingsstatus en publiceert deze via ZBUS, zodat andere modules (zoals de <span class="tt">cloud</span> module) hierop kunnen reageren.</p>
<p>Een belangrijk kenmerk van deze module is de robuustheid. Vrijwel elke fout die optreedt tijdens de initialisatie of het beheer van de verbinding, leidt tot een gecontroleerde herstart van het systeem. Dit zorgt ervoor dat het apparaat zichzelf kan herstellen van kritieke netwerkproblemen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md85"></a>
Componenten Diagram</h2>
<div class="fragment"><div class="line">graph TD</div>
<div class="line">    subgraph Network Module</div>
<div class="line">        A[network_thread]</div>
<div class="line">        B(State Machine)</div>
<div class="line">        C{ZBUS: NETWORK_CHAN}</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    subgraph Zephyr OS / Libraries</div>
<div class="line">        D[Connection Manager]</div>
<div class="line">        E[nRF Modem Library]</div>
<div class="line">        F[Task Watchdog]</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    subgraph Andere Modules</div>
<div class="line">        G[Cloud Module]</div>
<div class="line">        H[Reboot Module]</div>
<div class="line">    end</div>
<div class="line"> </div>
<div class="line">    A -- Manages --&gt; B;</div>
<div class="line">    A -- Feeds --&gt; F;</div>
<div class="line">    B -- Publishes status --&gt; C;</div>
<div class="line">    A -- Subscribes to --&gt; C;</div>
<div class="line"> </div>
<div class="line">    A -- Uses --&gt; D;</div>
<div class="line">    A -- Initializes --&gt; E;</div>
<div class="line">    D -- Raises events --&gt; A;</div>
<div class="line"> </div>
<div class="line">    C -- Informs --&gt; G;</div>
<div class="line">    A -- Requests reboot on error --&gt; H;</div>
<div class="line"> </div>
<div class="line">    style A fill:#cde4ff,stroke:#333,stroke-width:2px</div>
<div class="line">    style B fill:#cde4ff,stroke:#333,stroke-width:2px</div>
<div class="line">    style C fill:#ffe6cc,stroke:#333,stroke-width:2px</div>
</div><!-- fragment --><h2 class="doxsection"><a class="anchor" id="autotoc_md86"></a>
State Machine</h2>
<p>De module gebruikt een hiërarchische state machine (SMF) om de verbindingsstatus te beheren.</p>
<ul>
<li><b><span class="tt">STATE_OPERATIONAL</span></b> (Hoofdstatus)<ul>
<li><b>Entry</b>: Bij het betreden van deze status wordt de initialisatie gestart:<ol type="1">
<li>Callbacks voor de Zephyr Connection Manager worden geregistreerd.</li>
<li><span class="tt">conn_mgr_all_if_connect(true)</span> wordt aangeroepen om het verbindingsproces te starten.</li>
<li>De module wacht op de initialisatie van de nRF modem library (via de <span class="tt">nrf_modem_initialized</span> semafoor).</li>
<li>Na succesvolle modem-initialisatie wordt de status <span class="tt">NETWORK_MODEM_INIT</span> gepubliceerd.</li>
</ol>
</li>
<li><b>Run</b>: Verwerkt ZBUS-berichten en schakelt naar de juiste sub-status (<span class="tt">CONNECTED</span> of <span class="tt">DISCONNECTED</span>).</li>
<li><b>Sub-states</b>:<ul>
<li><b><span class="tt">STATE_DISCONNECTED</span></b> (Initiële sub-status)<ul>
<li>De module bevindt zich in deze staat wanneer er geen actieve L4-verbinding is.</li>
<li>Wacht op een <span class="tt">NETWORK_CONNECTED</span> bericht om over te gaan naar <span class="tt">STATE_CONNECTED</span>.</li>
</ul>
</li>
<li><b><span class="tt">STATE_CONNECTED</span></b><ul>
<li>De module bevindt zich in deze staat wanneer er een actieve L4-verbinding is.</li>
<li>Wacht op een <span class="tt">NETWORK_DISCONNECTED</span> bericht om terug te keren naar <span class="tt">STATE_DISCONNECTED</span>.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>De state machine wordt primair aangedreven door events van de Connection Manager, die worden omgezet in ZBUS-berichten en door de module zelf worden ontvangen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md87"></a>
ZBUS Kanalen</h2>
<h3 class="doxsection"><a class="anchor" id="autotoc_md88"></a>
Publicaties</h3>
<ul>
<li><b><span class="tt">NETWORK_CHAN</span></b><ul>
<li><b>Bericht</b>: <span class="tt">struct <a class="el" href="structnetwork__msg.html">network_msg</a></span></li>
<li><b>Inhoud</b>:<ul>
<li><span class="tt">type</span>: <span class="tt">NETWORK_STATUS</span></li>
<li><span class="tt">status</span>: Een <span class="tt">enum <a class="el" href="group__network.html#ga1d388be7b8bc84c14c1c37a93d4e4c55">network_status</a></span> die de huidige staat van de verbinding aangeeft:<ul>
<li><span class="tt">NETWORK_MODEM_INIT</span>: De modem is succesvol geïnitialiseerd.</li>
<li><span class="tt">NETWORK_DISCONNECTED</span>: De L4-verbinding is verbroken.</li>
<li><span class="tt">NETWORK_CONNECTED</span>: De L4-verbinding is tot stand gebracht.</li>
</ul>
</li>
</ul>
</li>
<li><b>Trigger</b>: Wordt gepubliceerd wanneer de Connection Manager een <span class="tt">NET_EVENT_L4_CONNECTED</span> of <span class="tt">NET_EVENT_L4_DISCONNECTED</span> event genereert, of na modem-initialisatie.</li>
</ul>
</li>
</ul>
<h3 class="doxsection"><a class="anchor" id="autotoc_md89"></a>
Abonnementen</h3>
<ul>
<li><b><span class="tt">NETWORK_CHAN</span></b><ul>
<li>De module abonneert zich op haar eigen kanaal om de state machine aan te sturen op basis van de door de Connection Manager gerapporteerde statuswijzigingen.</li>
</ul>
</li>
</ul>
<h2 class="doxsection"><a class="anchor" id="autotoc_md90"></a>
Foutafhandeling en Robuustheid</h2>
<p>De <span class="tt">network</span> module is ontworpen om faalbestendig te zijn. Een <span class="tt">reboot_request_publish(REBOOT_TYPE_ERROR)</span> wordt aangeroepen in de volgende scenario's, wat leidt tot een systeemherstart:</p>
<ol type="1">
<li><b>Modem Initialisatie Fout</b>: Als <span class="tt">nrf_modem_lib_init()</span> een fout retourneert.</li>
<li><b>Modem Initialisatie Timeout</b>: Als de modem niet initialiseert binnen de ingestelde timeout (<span class="tt">CONFIG_APP_NETWORK_MODULE_MODEM_INIT_TIMEOUT_SECONDS</span>).</li>
<li><b>Connection Manager Fout</b>: Als <span class="tt">conn_mgr_all_if_connect()</span> een fout retourneert.</li>
<li><b>Fatale Connectiviteitsfout</b>: Bij ontvangst van een <span class="tt">NET_EVENT_CONN_IF_FATAL_ERROR</span> van de Connection Manager.</li>
<li><b>ZBUS Fouten</b>: Als het publiceren (<span class="tt">zbus_chan_pub</span>) of wachten op (<span class="tt">zbus_sub_wait_msg</span>) berichten mislukt.</li>
<li><b>State Machine Fout</b>: Als <span class="tt">smf_run_state()</span> een fout retourneert.</li>
<li><b>Task Watchdog Timeout</b>: Als de <span class="tt">network_thread</span> vastloopt en de watchdog niet op tijd voedt.</li>
</ol>
<p>Deze strategie zorgt ervoor dat het apparaat niet in een ongedefinieerde netwerkstaat kan blijven hangen.</p>
<h2 class="doxsection"><a class="anchor" id="autotoc_md91"></a>
Initialisatie Flow</h2>
<ol type="1">
<li>De <span class="tt">network_thread</span> start.</li>
<li>De task watchdog wordt geconfigureerd en gestart.</li>
<li>De state machine wordt geïnitialiseerd naar <span class="tt">STATE_OPERATIONAL</span>, wat direct de <span class="tt">state_operational_entry</span> functie uitvoert.</li>
<li><span class="tt">state_operational_entry</span> start het verbindingsproces via de Connection Manager en wacht op de <span class="tt">nrf_modem_initialized</span> semafoor.</li>
<li>De <span class="tt">modem_lib_init_callback</span> (getriggerd door de nRF Modem Library) geeft de semafoor vrij na succesvolle initialisatie.</li>
<li>Zodra de semafoor is vrijgegeven, publiceert de module <span class="tt">NETWORK_MODEM_INIT</span>.</li>
<li>De module wacht nu op L4-events van de Connection Manager, die de overgangen tussen <span class="tt">STATE_CONNECTED</span> en <span class="tt">STATE_DISCONNECTED</span> zullen aansturen.</li>
</ol>
<h2 class="doxsection"><a class="anchor" id="autotoc_md92"></a>
Afhankelijkheden</h2>
<ul>
<li><b>Zephyr Connection Manager</b>: Voor het beheren van de netwerkverbinding.</li>
<li><b>nRF Modem Library</b>: Voor de initialisatie en communicatie met de nRF9161 modem.</li>
<li><b>ZBUS</b>: Voor het communiceren van de netwerkstatus naar andere modules.</li>
<li><b>Reboot Module</b>: Om een herstart aan te vragen bij fatale fouten.</li>
<li><b>Task Watchdog</b>: Om de thread te bewaken en te herstellen bij vastlopen.</li>
<li><b>Cloud Module</b>: Consumeert de statusberichten van de <span class="tt">NETWORK_CHAN</span> om te weten wanneer het kan proberen te verbinden met nRF Cloud. --&gt; </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
